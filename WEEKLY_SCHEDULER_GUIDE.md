# 📅 매주 월요일 00:01 자동 작업 스케줄러 가이드

이 문서는 매주 월요일 자정(00:01)에 자동으로 실행되는 작업들을 자세히 설명합니다.

## 🕐 실행 시간

- **스케줄**: 매주 월요일 오전 00:01 (한국시간 기준)
- **설정 위치**: `backend/src/app.ts`의 `cron.schedule('1 0 * * 1', ...)`
- **타임존**: Asia/Seoul (한국시간)

---

## 📋 자동 실행되는 작업 목록

### 1️⃣ 다음 주 투표 세션 생성

**목적**: 다음 주(월~금) 일정에 대한 투표를 위한 세션을 자동으로 생성합니다.

**생성되는 세션 정보**:
- **투표 기간**: 다음 주 월요일 ~ 금요일
- **의견 수렴 기간 시작**: 이번 주 월요일 00:01
- **의견 수렴 기간 마감**: 관리자가 "투표 마감" 버튼을 누르는 순간
- **상태**: `isActive: true`, `isCompleted: false`

**예시**:
- 오늘이 2025년 11월 3일(월요일)이라면:
  - 다음 주 월요일: 2025년 11월 10일
  - 다음 주 금요일: 2025년 11월 14일
  - **생성되는 세션**:
    - 투표 기간: 2025. 11. 10.(월) ~ 2025. 11. 14.(금)
    - 의견 수렴 기간 시작: 2025. 11. 03.(월) 00:01
    - 의견 수렴 기간 마감: 관리자 투표마감 버튼 클릭 시

**중복 체크**:
- 이미 해당 주간의 세션이 존재하면 새로 생성하지 않습니다
- 로그에 "⚠️ 이미 해당 주간의 투표 세션이 존재합니다" 메시지가 표시됩니다

---

### 2️⃣ 지난 주 투표 결과를 이번 주 일정에 반영

**목적**: 지난 주에 완료된 투표 결과를 바탕으로 이번 주 경기를 자동 생성합니다.

**작업 순서**:

1. **지난 주 완료된 세션 찾기**
   - `isCompleted: true`인 세션
   - 투표가 1개 이상 존재하는 세션
   - 가장 최근의 완료된 세션

2. **기존 자동 생성 일정 정리**
   - 지난 주 세션의 주간(월~일)에 해당하는 기존 자동 생성 일정(`autoGenerated: true`) 삭제

3. **투표 결과 집계**
   - 각 요일(월, 화, 수, 목, 금, 토, 일)별 투표 수 계산
   - 각 요일별 참여자 목록 수집

4. **자동 경기 생성**
   - 가장 많이 투표받은 요일(들)에 대해 경기 생성
   - 동점인 경우 모든 요일에 경기 생성
   - 생성되는 경기 정보:
     - 날짜: 해당 요일
     - 시간: '미정'
     - 장소: '미정'
     - 경기 유형: '미정'
     - 이벤트 유형: '미정'
     - 자동 생성 표시: `autoGenerated: true`
     - 확정 여부: `confirmed: false`
     - 참가자: 투표한 회원 이름 목록

**예시**:
- 지난 주 세션: 2025년 10월 27일 ~ 10월 31일
- 투표 결과:
  - 월요일: 3명
  - 수요일: 5명 (최다)
  - 금요일: 4명
- **생성되는 경기**:
  - 2025년 10월 27일(월) 경기 (3명)
  - 2025년 10월 29일(수) 경기 (5명) ✅ 최다 투표
  - 2025년 10월 31일(금) 경기 (4명)

---

## 🔍 로그 확인 방법

### Render 대시보드에서 로그 확인:

1. **Render 대시보드 접속**
   - https://dashboard.render.com
   - `fccgfirst` 서비스 클릭

2. **Logs 탭 클릭**
   - 왼쪽 사이드바 → "Monitor" → "Logs"

3. **로그 메시지 확인**
   - 매주 월요일 00:01에 다음 메시지들이 표시됩니다:
     - `🔄 매주 월요일 00:01 자동 작업 시작...`
     - `📅 다음주 월요일 계산: { ... }`
     - `✅ 다음주 투표 세션 자동 생성 완료: { ... }` 또는 `⚠️ 이미 해당 주간의 투표 세션이 존재합니다`
     - `🧹 지난주 자동생성일정 정리: X 개 삭제`
     - `✅ 지난주 투표결과 반영 자동생성일정: ...`
     - `✅ 매주 월요일 00:01 자동 작업 완료`

---

## ⚠️ 문제 해결

### 문제 1: 세션이 생성되지 않음

**원인**:
- 스케줄러가 실행되지 않음
- 이미 같은 주간의 세션이 존재함
- 데이터베이스 연결 오류

**해결 방법**:
1. Render 로그에서 에러 메시지 확인
2. 데이터베이스 연결 상태 확인
3. 기존 세션 확인 (관리자 페이지 → 투표 결과)

### 문제 2: 자동 생성 경기가 생성되지 않음

**원인**:
- 지난 주 세션이 완료되지 않음 (`isCompleted: false`)
- 지난 주 세션에 투표가 없음
- 투표 결과 파싱 오류

**해결 방법**:
1. 지난 주 세션이 완료되었는지 확인 (관리자 페이지 → 투표 결과)
2. 지난 주 세션에 투표가 있는지 확인
3. 로그에서 "⚠️ 투표 파싱 오류" 메시지 확인

### 문제 3: 스케줄러가 실행되지 않음

**원인**:
- Render 무료 플랜의 인스턴스가 스핀 다운됨
- 서버 재시작으로 인한 스케줄러 초기화

**해결 방법**:
1. Render 로그에서 서버 재시작 여부 확인
2. 스케줄러 수동 실행 (관리자 페이지에서 제공하는 경우)
3. 또는 다음 월요일까지 대기

---

## 📊 실행 예시 (2025년 11월 3일 월요일 00:01)

```
🔄 매주 월요일 00:01 자동 작업 시작...
📅 다음주 월요일 계산: {
  오늘: 2025. 11. 3.,
  오늘요일: 월,
  다음주월요일: 2025. 11. 10.,
  일수차이: 7
}
✅ 다음주 투표 세션 자동 생성 완료: {
  세션ID: 6,
  투표기간: 2025. 11. 10. ~ 2025. 11. 14.,
  의견수렴기간: 2025. 11. 3. 00:01 ~ 2025. 11. 14. 17:00
}
🧹 지난주 자동생성일정 정리: 3 개 삭제
✅ 지난주 투표결과 반영 자동생성일정: MON 2025-10-27
✅ 지난주 투표결과 반영 자동생성일정: WED 2025-10-29
✅ 지난주 투표결과 반영 자동생성일정: FRI 2025-10-31
✅ 매주 월요일 00:01 자동 작업 완료
```

---

## 🔄 스케줄러 코드 위치

- **파일**: `backend/src/app.ts`
- **라인**: 약 1120~1282줄
- **스케줄 설정**: `cron.schedule('1 0 * * 1', ...)` 
  - `1 0 * * 1` = 매주 월요일 오전 00:01

---

## 💡 참고 사항

1. **타임존**: 모든 시간은 한국시간(Asia/Seoul) 기준입니다.
2. **자동 생성 경기**: 자동으로 생성된 경기는 `autoGenerated: true`로 표시되며, 관리자가 수정할 수 있습니다.
3. **투표 세션**: 새로 생성된 세션은 즉시 활성화(`isActive: true`)되어 투표를 받을 수 있습니다.
4. **로그 보관**: Render 무료 플랜은 로그를 일정 기간만 보관하므로, 중요한 정보는 별도로 기록하세요.

---

## ✅ 정상 작동 확인 방법

1. **매주 월요일 오전 00:01 이후**
   - Render 로그에서 위의 로그 메시지들이 표시되는지 확인
   
2. **관리자 페이지 → 투표 결과**
   - 새로 생성된 세션이 표시되는지 확인
   - 세션의 투표 기간과 의견 수렴 기간이 올바른지 확인

3. **일정 페이지**
   - 자동 생성된 경기가 표시되는지 확인
   - 경기 정보(날짜, 참가자)가 올바른지 확인

