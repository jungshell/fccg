import { useState, useEffect, useCallback, useMemo, useRef, useLayoutEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Box,
  VStack,
  HStack,
  Text,
  Button,
  useToast,
  Flex,
  Grid,
  Modal,
  ModalOverlay,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalCloseButton,
  Badge,
  Tooltip,
  Input,
  IconButton,
  Skeleton,
  Spinner,
  Icon,
  FormControl,
  FormLabel,
  Textarea,
} from '@chakra-ui/react';
import NewCalendarV2 from '../components/NewCalendarV2';
import { ArrowUpIcon, SmallCloseIcon } from '@chakra-ui/icons';
import { useAuthStore } from '../store/auth';
import { WarningIcon } from '@chakra-ui/icons';
import { getUnifiedVoteDataNew, deleteVote } from '../api/auth';
import { eventBus, EVENT_TYPES } from '../utils/eventBus';
import { API_ENDPOINTS } from '../constants';
import { getApiUrl } from '../config/api';
import { EditIcon, DeleteIcon } from '@chakra-ui/icons';
import { CalendarSkeleton, VoteSectionSkeleton } from '../components/common/SkeletonLoader';
import { shareKakaoText } from '../utils/kakaoShare';

// íƒ€ì… ì •ì˜
interface VoteData {
  date: string;
  count: number;
  max: boolean;
  dayName: string;
  voteDate: Date;
}

interface VoteResults {
  voteSession: {
    id: number;
    weekStartDate: string;
    startTime: string;
    endTime: string;
    isActive: boolean;
    isCompleted: boolean;
    createdAt: string;
    updatedAt: string;
    votes: Array<{
      id: number;
      userId: number;
      selectedDays: string[];
      createdAt: string;
    }>;
  };
  voteResults: Record<string, number>;
}

interface GameData {
  id: string;
  eventType: string;
  count: number;
  time: string;
  location: string;
  locationAddress?: string; // ì¥ì†Œ ì£¼ì†Œ (ì‹ ì£¼ì†Œ)
  confirmed: boolean;
  date?: string;
  memberNames?: string[] | string;
  selectedMembers?: string[] | string;
  mercenaryCount?: number;
  autoGenerated?: boolean;
}

const buildFallbackActiveSessionFromLastWeek = (lastWeekResults: any) => {
  if (!lastWeekResults) return null;

  const results = lastWeekResults.results || {};
  const fallbackParticipants: any[] = [];

  Object.entries(results).forEach(([dayKey, dayResult]: [string, any]) => {
    if (Array.isArray(dayResult?.participants)) {
      dayResult.participants.forEach((participant: any) => {
        fallbackParticipants.push({
          userId: participant.userId ?? participant.id ?? null,
          userName: participant.userName ?? participant.name ?? String(participant),
          selectedDays: Array.isArray(participant.selectedDays)
            ? participant.selectedDays
            : [dayKey],
          votedAt:
            participant.votedAt ||
            lastWeekResults.endTime ||
            lastWeekResults.startTime ||
            new Date().toISOString()
        });
      });
    }
  });

  return {
    ...lastWeekResults,
    sessionId: lastWeekResults.sessionId,
    id: lastWeekResults.sessionId,
    participants: fallbackParticipants,
    results,
    totalParticipants: lastWeekResults.totalParticipants ?? fallbackParticipants.length,
    isActive: false,
    isCompleted: true,
    disabledDays: [],
    isFallbackFromLastWeek: true
  };
};




export default function SchedulePageV2() {
  const navigate = useNavigate();
  const kakaoAppKey = import.meta.env.VITE_KAKAO_JS_KEY as string | undefined;
  const toast = useToast();
  
  // ì¤‘ì•™í™”ëœ ë°ì´í„° ìƒíƒœ ê´€ë¦¬ (ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì‚¬ìš©)
  const [appData, setAppData] = useState({
    // ê²Œì„ ë°ì´í„°
    games: [] as GameData[],
    gameDataForCalendar: {} as Record<string, GameData>,
    
    // íˆ¬í‘œ ë°ì´í„°
    voteResults: null as VoteResults | null,
    nextWeekVoteData: [] as VoteData[],
    
    // íšŒì› ë°ì´í„°
    allMembers: [] as Array<{id: number, name: string}>,
    
    // UI ìƒíƒœ
    isLoading: false,
    error: null as string | null,
    lastUpdated: null as Date | null
  });
  
  // ì¸ì¦ ìƒíƒœ
  const { user, refreshUserData, setUser, reloadTokenFromStorage } = useAuthStore();
  
  // ê¸°ì¡´ ìƒíƒœ ë³€ìˆ˜ë“¤ (í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
  const [gameDataForCalendar, setGameDataForCalendar] = useState<Record<string, GameData>>({});
  const [allDates] = useState<VoteData[]>([]);
  const [voteResults, setVoteResults] = useState<VoteResults | null>({
    voteResults: {},
    voteSession: {
      id: 0,
      weekStartDate: '',
      startTime: '',
      endTime: '',
      isActive: false,
      isCompleted: false,
      createdAt: '',
      updatedAt: '',
      votes: []
    }
  });
  const [showVoteSharePrompt, setShowVoteSharePrompt] = useState(false);
  const [voteShareDays, setVoteShareDays] = useState<string[]>([]);
  const [isShareAbsentVote, setIsShareAbsentVote] = useState(false);

  const voteShareText = useMemo(() => {
    const shareUrl = `${window.location.origin}/schedule-v2?utm=vote_share`;
    const selectedLabel = voteShareDays.length > 0 ? voteShareDays.join(', ') : 'ë¯¸ì •';
    const description = isShareAbsentVote
      ? 'ì´ë²ˆ ì£¼ëŠ” ë¶ˆì°¸ìœ¼ë¡œ íˆ¬í‘œí–ˆì–´ìš”. ì•„ì§ íˆ¬í‘œ ì•ˆ í•œ ë¶„ë“¤ì€ ì°¸ì—¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤!'
      : `ì„ íƒ ìš”ì¼: ${selectedLabel}\nì•„ì§ íˆ¬í‘œ ì•ˆ í•œ ë¶„ë“¤ì€ ì§€ê¸ˆ ì°¸ì—¬í•´ì£¼ì„¸ìš”!`;
    return `ğŸ—³ï¸ íˆ¬í‘œ ì™„ë£Œ!\n${description}\níˆ¬í‘œ ë§í¬: ${shareUrl}`;
  }, [voteShareDays, isShareAbsentVote]);
  const [nextWeekVoteData, setNextWeekVoteData] = useState<VoteData[]>([]);
  
  // í†µí•© API ë°ì´í„° ìƒíƒœ
  const [unifiedVoteData, setUnifiedVoteData] = useState<{
    activeSession: any;
    allMembers: Array<{id: number, name: string}>;
    lastWeekResults: any;
  } | null>(null);
  const [allMembers, setAllMembers] = useState<Array<{id: number, name: string}>>([]);
  const [games, setGames] = useState<GameData[]>([]);

  // (moved below after isVoteClosed)
  
  // UI ìƒíƒœ (ë°ì´í„°ì™€ ë¶„ë¦¬)
  const [selectedDays, setSelectedDays] = useState<string[]>([]);
  const [showVoteStatus, setShowVoteStatus] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [comments, setComments] = useState<{ text: string; user: string; date: string }[]>([]);
  const [showSuspensionRequestModal, setShowSuspensionRequestModal] = useState(false);
  const [suspensionRequestReason, setSuspensionRequestReason] = useState('');
  const [editingCommentIndex, setEditingCommentIndex] = useState<number | null>(null);
  const [editCommentText, setEditCommentText] = useState('');
  const [isLoading] = useState(false);
  const [error] = useState<string | null>(null);
  
  // ê³µíœ´ì¼ ë°ì´í„° ìƒíƒœ
  const [holidays, setHolidays] = useState<Record<string, string>>({});
  const gridContainerRef = useRef<HTMLDivElement | null>(null);
  const [lockedCalendarWidth, setLockedCalendarWidth] = useState<number | null>(null);

  useLayoutEffect(() => {
    if (typeof window === 'undefined') return;
    const container = gridContainerRef.current;
    if (!container) return;

    const GAP_PX = 6;
    const SIDEBAR_WIDTH = 400;

    const updateWidth = (totalWidth: number) => {
      const calendarWidth = Math.max(totalWidth - SIDEBAR_WIDTH - GAP_PX, 1000);
      setLockedCalendarWidth((prev) => {
        if (prev === null || Math.abs(prev - calendarWidth) > 1) {
          return calendarWidth;
        }
        return prev;
      });
    };

    updateWidth(container.getBoundingClientRect().width);

    const resizeObserver = new ResizeObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.target === container) {
          updateWidth(entry.contentRect.width);
        }
      });
    });

    resizeObserver.observe(container);

    return () => {
      resizeObserver.disconnect();
    };
  }, []);
  
  // ê³µíœ´ì¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    const fetchHolidays = async () => {
      try {
        const currentYear = new Date().getFullYear();
        const nextYear = currentYear + 1;
        
        // API BASE URL ê°€ì ¸ì˜¤ê¸°
        const { getApiBaseUrl } = await import('../config/api');
        const baseUrl = await getApiBaseUrl();
        const apiUrl = baseUrl.replace('/api/auth', '');
        
        // ì˜¬í•´ì™€ ë‚´ë…„ ê³µíœ´ì¼ ì¡°íšŒ
        const response = await fetch(`${apiUrl}/api/holiday/years`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ years: [currentYear.toString(), nextYear.toString()] }),
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data.holidayMap) {
            // API ì‘ë‹µì—ì„œ í†µí•©ëœ ê³µíœ´ì¼ ë§µ ì‚¬ìš©
            setHolidays(data.data.holidayMap);
          } else if (data.success && data.data.holidays) {
            // ì—°ë„ë³„ ê³µíœ´ì¼ ë§µì´ ìˆëŠ” ê²½ìš° í†µí•©
            const holidayMap: Record<string, string> = {};
            Object.values(data.data.holidays).forEach((yearMap: any) => {
              Object.assign(holidayMap, yearMap);
            });
            setHolidays(holidayMap);
          } else {
            console.warn('âš ï¸ ê³µíœ´ì¼ API ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤:', data);
          }
        } else {
          console.error('âŒ ê³µíœ´ì¼ API í˜¸ì¶œ ì‹¤íŒ¨:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('âŒ ê³µíœ´ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        // API ì‹¤íŒ¨ ì‹œ ë¹ˆ ê°ì²´ ìœ ì§€
        setHolidays({});
      }
    };
    
    fetchHolidays();
  }, []);
  
  // ê³µíœ´ì¼ ì²´í¬ í•¨ìˆ˜ (API ë°ì´í„° ì‚¬ìš©)
  const isHolidayDate = useCallback((dateString: string): boolean => {
    if (!dateString || Object.keys(holidays).length === 0) {
      return false;
    }
    
    let formattedDate: string | null = null;
    
    // í˜•ì‹ 1: "2025. 11. 17.(ì›”)" -> "2025-11-17"
    const match1 = dateString.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
    if (match1) {
      const year = match1[1];
      const month = match1[2].padStart(2, '0');
      const day = match1[3].padStart(2, '0');
      formattedDate = `${year}-${month}-${day}`;
    } else {
      // í˜•ì‹ 2: "11ì›” 17ì¼(ì›”)" -> "2025-11-17" (ì˜¬í•´ ê¸°ì¤€)
      const match2 = dateString.match(/(\d+)ì›”\s*(\d+)ì¼/);
      if (match2) {
        const currentYear = new Date().getFullYear();
        const month = match2[1].padStart(2, '0');
        const day = match2[2].padStart(2, '0');
        formattedDate = `${currentYear}-${month}-${day}`;
      }
    }
    
    if (!formattedDate) {
      return false;
    }
    
    // APIì—ì„œ ê°€ì ¸ì˜¨ ê³µíœ´ì¼ ë°ì´í„° í™•ì¸
    return holidays[formattedDate] !== undefined;
  }, [holidays]);

  // ê³µíœ´ì¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  const getHolidayName = useCallback((dateString: string): string | null => {
    if (!dateString || Object.keys(holidays).length === 0) {
      return null;
    }
    
    let formattedDate: string | null = null;
    
    // í˜•ì‹ 1: "2025. 11. 17.(ì›”)" -> "2025-11-17"
    const match1 = dateString.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
    if (match1) {
      const year = match1[1];
      const month = match1[2].padStart(2, '0');
      const day = match1[3].padStart(2, '0');
      formattedDate = `${year}-${month}-${day}`;
    } else {
      // í˜•ì‹ 2: "11ì›” 17ì¼(ì›”)" -> "2025-11-17" (ì˜¬í•´ ê¸°ì¤€)
      const match2 = dateString.match(/(\d+)ì›”\s*(\d+)ì¼/);
      if (match2) {
        const currentYear = new Date().getFullYear();
        const month = match2[1].padStart(2, '0');
        const day = match2[2].padStart(2, '0');
        formattedDate = `${currentYear}-${month}-${day}`;
      }
    }
    
    if (!formattedDate) {
      return null;
    }
    
    return holidays[formattedDate] || null;
  }, [holidays]);

  // íŠ¹ì • ìš”ì¼ì´ disabledDaysì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
  const isDayDisabled = useCallback((dayKey: string): { disabled: boolean; reason: string | null } => {
    if (!unifiedVoteData?.activeSession?.disabledDays) {
      return { disabled: false, reason: null };
    }
    
    try {
      // disabledDaysê°€ ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
      let disabledDaysArray: Array<{ day: string; reason: string }> = [];
      if (typeof unifiedVoteData.activeSession.disabledDays === 'string') {
        disabledDaysArray = JSON.parse(unifiedVoteData.activeSession.disabledDays);
      } else if (Array.isArray(unifiedVoteData.activeSession.disabledDays)) {
        disabledDaysArray = unifiedVoteData.activeSession.disabledDays;
      }
      
      const disabledDay = disabledDaysArray.find((d: any) => d.day === dayKey);
      if (disabledDay) {
        return { disabled: true, reason: disabledDay.reason || null };
      }
    } catch (e) {
      console.warn('disabledDays íŒŒì‹± ì‹¤íŒ¨:', e);
    }
    
    return { disabled: false, reason: null };
  }, [unifiedVoteData]);

  // disabledDays ë””ë²„ê¹…
  useEffect(() => {
    if (unifiedVoteData?.activeSession?.disabledDays) {
      console.log('ğŸ” í™œì„± ì„¸ì…˜ disabledDays:', unifiedVoteData.activeSession.disabledDays);
      console.log('ğŸ” íƒ€ì…:', typeof unifiedVoteData.activeSession.disabledDays);
      try {
        const parsed = typeof unifiedVoteData.activeSession.disabledDays === 'string' 
          ? JSON.parse(unifiedVoteData.activeSession.disabledDays) 
          : unifiedVoteData.activeSession.disabledDays;
        console.log('ğŸ” íŒŒì‹±ëœ disabledDays:', parsed);
      } catch (e) {
        console.warn('ğŸ” disabledDays íŒŒì‹± ì‹¤íŒ¨:', e);
      }
    } else {
      console.log('ğŸ” í™œì„± ì„¸ì…˜ì— disabledDaysê°€ ì—†ìŒ');
    }
  }, [unifiedVoteData?.activeSession?.disabledDays]);

  // ìµœê·¼ ë¡œì»¬ íˆ¬í‘œ ìºì‹œ (ë°±ì—”ë“œ ì¼ì‹œì  ì§€ì—° ëŒ€ë¹„)
  const localVotesRef = useRef<any[]>([]);

  // íˆ¬í‘œ ë§ˆê° ì•ˆë‚´ ë¬¸êµ¬: ê·œì¹™ ì„¤ëª…ìš© ê³ ì • ë¬¸êµ¬ (ìë™ ë§ˆê° ì•„ë‹˜)
  // í•­ìƒ "ì´ë²ˆì£¼ ëª©ìš”ì¼ 17ì‹œê¹Œì§€"ë¡œ í‘œê¸°í•˜ë˜, ì»¬ëŸ¬ í‘œì‹œëŠ” ì´ë²ˆì£¼ ëª©ìš”ì¼ 17:00ê¹Œì§€ ë‚¨ì€ ì‹œê°„ìœ¼ë¡œ ê³„ì‚°
  const getVoteDeadline = useCallback(() => {
    const now = new Date();
    // ì´ë²ˆì£¼ ì›”ìš”ì¼ 00:00 ê³„ì‚°
    const currentDay = now.getDay(); // 0: ì¼, 1: ì›”, ..., 6: í† 
    const daysToMonday = currentDay === 0 ? -6 : 1 - currentDay;
    const thisWeekMonday = new Date(now);
    thisWeekMonday.setDate(now.getDate() + daysToMonday);
    thisWeekMonday.setHours(0, 0, 0, 0);
    // ì´ë²ˆì£¼ ëª©ìš”ì¼ 17:00 ê³„ì‚°
    const thisWeekThursday1700 = new Date(thisWeekMonday);
    thisWeekThursday1700.setDate(thisWeekMonday.getDate() + 3); // ëª©ìš”ì¼
    thisWeekThursday1700.setHours(17, 0, 0, 0);
    const remainingHours = Math.max(0, (thisWeekThursday1700.getTime() - now.getTime()) / (1000 * 60 * 60));
    const month = thisWeekThursday1700.getMonth() + 1;
    const date = thisWeekThursday1700.getDate();
    const dayName = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][thisWeekThursday1700.getDay()];
    const text = `${month}ì›” ${date}ì¼(${dayName}) 17:00ê¹Œì§€`;
    return { text, deadline: thisWeekThursday1700, remainingHours };
  }, []);

  // íˆ¬í‘œ ë§ˆê°ì¼ ìƒ‰ìƒ ê³„ì‚° - ë©”ëª¨ì´ì œì´ì…˜ ì ìš©
  const getVoteDeadlineColor = useCallback((remainingHours: number) => {
    if (remainingHours <= 0) return 'red.500';
    if (remainingHours <= 24) return 'red.500';
    if (remainingHours <= 48) return 'orange.500';
    return 'black';
  }, []);

  // íˆ¬í‘œ ë§ˆê°ì¼ ì •ë³´ - ë©”ëª¨ì´ì œì´ì…˜ ì ìš©
  const voteDeadlineInfo = useMemo(() => getVoteDeadline(), [getVoteDeadline]);
  
  // íˆ¬í‘œ ë§ˆê° ì—¬ë¶€ í™•ì¸ (í†µí•©ëœ ë¡œì§ ì‚¬ìš©)


  // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì´ë²ˆì£¼ì™€ ë‹¤ìŒì£¼ ì¼ì • ë°ì´í„° ìƒì„±
  const getScheduleData = useMemo(() => {
    const now = new Date();
    const currentDay = now.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
    
    // ì´ë²ˆì£¼ ì›”ìš”ì¼ ê³„ì‚°
    let daysUntilMonday;
    if (currentDay === 0) { // ì¼ìš”ì¼
      daysUntilMonday = -6; // ì§€ë‚œ ì›”ìš”ì¼
    } else if (currentDay === 1) { // ì›”ìš”ì¼
      daysUntilMonday = 0; // ì˜¤ëŠ˜
    } else {
      daysUntilMonday = 1 - currentDay; // ì´ë²ˆì£¼ ì›”ìš”ì¼
    }
    
    const thisWeekMonday = new Date(now);
    thisWeekMonday.setDate(now.getDate() + daysUntilMonday);
    
    // ë‹¤ìŒì£¼ ì›”ìš”ì¼ ê³„ì‚°
    const nextWeekMonday = new Date(thisWeekMonday);
    nextWeekMonday.setDate(thisWeekMonday.getDate() + 7);
    
    // ì´ë²ˆì£¼ ì¼ì • ë°ì´í„° (ì›”-ê¸ˆ) - ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
    const thisWeekScheduleData = [];
    for (let i = 0; i < 5; i++) {
      const date = new Date(thisWeekMonday);
      date.setDate(thisWeekMonday.getDate() + i);
      
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
      const dayName = dayNames[i];
      
      thisWeekScheduleData.push({
        date: `${month}ì›” ${day}ì¼(${dayName})`,
        count: 0,
        confirmed: false
      });
    }
    
    // ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ë°ì´í„° (ì›”-ê¸ˆ)
    const nextWeekVoteData = [];
    for (let i = 0; i < 5; i++) {
      const date = new Date(nextWeekMonday);
      date.setDate(nextWeekMonday.getDate() + i);
      
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
      const dayName = dayNames[i];
      
      nextWeekVoteData.push({
        date: `${month}ì›” ${day}ì¼(${dayName})`,
        count: 0
      });
    }
    
    return { thisWeekScheduleData, nextWeekVoteData };
  }, []);

  // ì´ë²ˆì£¼ ì¼ì • ë°ì´í„°ë¥¼ íˆ¬í‘œ ê²°ê³¼(ì§€ë‚œì£¼ ë§ˆê° ì„¸ì…˜)ë¡œë§Œ í‘œì‹œ
  const updateThisWeekScheduleWithGames = useMemo(() => {
    console.log('ğŸ” updateThisWeekScheduleWithGames ì‹¤í–‰:', {
      games: games ? games.length : 0,
      unifiedVoteData: unifiedVoteData ? 'ìˆìŒ' : 'ì—†ìŒ',
      thisWeekScheduleData: getScheduleData.thisWeekScheduleData
    });
    
    // ë¨¼ì € ëª¨ë“  ë‚ ì§œì˜ íˆ¬í‘œ ìˆ˜ë¥¼ ê³„ì‚°í•˜ê³  ìµœëŒ€ê°’ ì°¾ê¸°
    const voteCounts: number[] = [];
    
    // í˜„ì¬ ì´ë²ˆì£¼ ì›”ìš”ì¼ ê³„ì‚° (ë¹„êµìš©) - map ë°–ì—ì„œ í•œ ë²ˆë§Œ ê³„ì‚°
    const now = new Date();
    const currentDay = now.getDay();
    let daysUntilMonday;
    if (currentDay === 0) {
      daysUntilMonday = -6;
    } else if (currentDay === 1) {
      daysUntilMonday = 0;
    } else {
      daysUntilMonday = 1 - currentDay;
    }
    const thisWeekMonday = new Date(now);
    thisWeekMonday.setDate(now.getDate() + daysUntilMonday);
    thisWeekMonday.setHours(0, 0, 0, 0);
    const thisWeekMondayNormalized = new Date(thisWeekMonday.getFullYear(), thisWeekMonday.getMonth(), thisWeekMonday.getDate());
    
    // ì‚¬ìš©í•  ê²°ê³¼ ë°ì´í„° ê²°ì •: ì´ë²ˆì£¼ ì¼ì •ì€ ì§€ë‚œì£¼ íˆ¬í‘œ ê²°ê³¼(lastWeekResults)ë§Œ ì‚¬ìš©
    // activeSessionì€ ë‹¤ìŒì£¼ íˆ¬í‘œ ì„¸ì…˜ì´ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    let resultsToUse: any = null;
    let weekStartDateToUse: Date | null = null;
    
    console.log('ğŸ” ì´ë²ˆì£¼ ì¼ì • - ë°ì´í„° ì†ŒìŠ¤ í™•ì¸ ì‹œì‘ (lastWeekResultsë§Œ ì‚¬ìš©):', {
      hasUnifiedVoteData: !!unifiedVoteData,
      hasLastWeekResults: !!unifiedVoteData?.lastWeekResults,
      thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0]
    });
    
    if (unifiedVoteData?.lastWeekResults) {
      const lastWeekResults = unifiedVoteData.lastWeekResults;
      const weekStartDate = new Date(lastWeekResults.weekStartDate);
      const weekStartLocalNormalized = new Date(weekStartDate.getFullYear(), weekStartDate.getMonth(), weekStartDate.getDate());
      
      console.log('ğŸ” lastWeekResults ë‚ ì§œ ë¹„êµ:', {
        lastWeekResultsWeekStart: weekStartLocalNormalized.toISOString().split('T')[0],
        thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0],
        isMatch: weekStartLocalNormalized.getTime() === thisWeekMondayNormalized.getTime(),
        hasResults: !!lastWeekResults.results,
        resultsKeys: lastWeekResults.results ? Object.keys(lastWeekResults.results) : []
      });
      
      // ì´ë²ˆì£¼ ë°ì´í„°ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
      if (weekStartLocalNormalized.getTime() === thisWeekMondayNormalized.getTime()) {
        resultsToUse = lastWeekResults.results || {};
        weekStartDateToUse = weekStartDate;
        console.log('âœ… lastWeekResults ì‚¬ìš© (ì´ë²ˆì£¼ ë°ì´í„°)', {
          resultsKeys: Object.keys(resultsToUse)
        });
      } else {
        // ë‚ ì§œê°€ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šì•„ë„ ì¼ì£¼ì¼ ì´ë‚´ë©´ ì‚¬ìš© (ë‚ ì§œ ë§¤í•‘ ì¡°ì •)
        const dayDiff = Math.abs((weekStartLocalNormalized.getTime() - thisWeekMondayNormalized.getTime()) / (1000 * 60 * 60 * 24));
        const isWithinWeek = dayDiff <= 7; // ì¼ì£¼ì¼ ì´ë‚´ë©´ í—ˆìš©
        
        console.log('âš ï¸ lastWeekResults ë‚ ì§œ ë²”ìœ„ í™•ì¸:', {
          lastWeekResultsWeekStart: weekStartLocalNormalized.toISOString().split('T')[0],
          thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0],
          dayDiff,
          isWithinWeek,
          hasResults: !!lastWeekResults.results,
          resultsKeys: lastWeekResults.results ? Object.keys(lastWeekResults.results) : []
        });
        
        if (isWithinWeek && lastWeekResults.results) {
          resultsToUse = lastWeekResults.results;
          // weekStartDateToUseë¥¼ ì´ë²ˆì£¼ ì›”ìš”ì¼ë¡œ ì„¤ì •í•˜ì—¬ ë‚ ì§œ ë§¤í•‘ì´ ì˜¬ë°”ë¥´ê²Œ ë˜ë„ë¡ í•¨
          weekStartDateToUse = thisWeekMondayNormalized;
          console.log('âœ… lastWeekResults ì‚¬ìš© (ì¼ì£¼ì¼ ì´ë‚´ ë°ì´í„°, ì´ë²ˆì£¼ ì›”ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘)', {
            resultsKeys: Object.keys(resultsToUse),
            weekStartDate: weekStartDateToUse ? weekStartDateToUse.toISOString().split('T')[0] : 'null',
            hasWeekStartDate: !!weekStartDateToUse
          });
        }
      }
    }
    
    if (!resultsToUse) {
      console.log('âš ï¸ ì´ë²ˆì£¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', {
        hasLastWeekResults: !!unifiedVoteData?.lastWeekResults,
        lastWeekResultsWeekStart: unifiedVoteData?.lastWeekResults?.weekStartDate,
        hasActiveSession: !!unifiedVoteData?.activeSession,
        activeSessionWeekStart: unifiedVoteData?.activeSession?.weekStartDate,
        activeSessionCompleted: unifiedVoteData?.activeSession?.isCompleted,
        activeSessionActive: unifiedVoteData?.activeSession?.isActive,
        thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0]
      });
    }
    
    console.log('ğŸ” map ì‹œì‘ ì „ resultsToUse í™•ì¸:', {
      hasResultsToUse: !!resultsToUse,
      hasWeekStartDateToUse: !!weekStartDateToUse,
      resultsToUseKeys: resultsToUse ? Object.keys(resultsToUse) : [],
      weekStartDate: weekStartDateToUse ? weekStartDateToUse.toISOString().split('T')[0] : null
    });
    
    const scheduleDataWithCounts = getScheduleData.thisWeekScheduleData.map(schedule => {
      // ë‚ ì§œì—ì„œ ì¼ì ì¶”ì¶œ (ì˜ˆ: "9ì›” 24ì¼(ìˆ˜)" -> 24)
      const dayMatch = schedule.date.match(/(\d+)ì›” (\d+)ì¼/);
      if (!dayMatch) return { schedule, totalCount: 0 };

      const month = parseInt(dayMatch[1]);
      const day = parseInt(dayMatch[2]);
      
      // íˆ¬í‘œ ê²°ê³¼ë§Œ ì‚¬ìš© (ì§€ë‚œì£¼ ì™„ë£Œ ì„¸ì…˜ ìš”ì•½)
      let totalCount = 0;
      
      console.log('ğŸ” map ë‚´ë¶€ - resultsToUse í™•ì¸:', {
        date: schedule.date,
        hasResultsToUse: !!resultsToUse,
        hasWeekStartDateToUse: !!weekStartDateToUse,
        month,
        day
      });
      
      if (resultsToUse && weekStartDateToUse) {
        const results = resultsToUse;
        const weekStartDate = weekStartDateToUse;
        
        console.log('ğŸ” ì´ë²ˆì£¼ ì¼ì • - ê²°ê³¼ ë°ì´í„° í™•ì¸:', {
          weekStartDate: weekStartDate.toISOString().split('T')[0],
          results: Object.keys(results),
          targetDate: `${month}-${day}`,
          scheduleDate: schedule.date,
          thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0]
        });
        
        // ìš”ì¼ ë§¤í•‘ (ì›”=0, í™”=1, ìˆ˜=2, ëª©=3, ê¸ˆ=4)
        const dayMapping = {
          'MON': 0, 'TUE': 1, 'WED': 2, 'THU': 3, 'FRI': 4
        };
        
        // weekStartDateë¥¼ ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ ì •ê·œí™” (UTC ì˜¤í”„ì…‹ ë¬´ì‹œ)
        const weekStartLocal = new Date(weekStartDate.getFullYear(), weekStartDate.getMonth(), weekStartDate.getDate());
        const weekStartLocalNormalized = new Date(weekStartLocal.getFullYear(), weekStartLocal.getMonth(), weekStartLocal.getDate());
        
        // weekStartDateê°€ ì´ë²ˆì£¼ ì›”ìš”ì¼ê³¼ ë‹¤ë¥¸ ê²½ìš°, ì´ë²ˆì£¼ ì›”ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘
        const weekStartToUse = weekStartLocalNormalized.getTime() === thisWeekMondayNormalized.getTime() 
          ? weekStartLocal 
          : thisWeekMondayNormalized; // ì´ë²ˆì£¼ ì›”ìš”ì¼ ì‚¬ìš©
        
        console.log('ğŸ” ë‚ ì§œ ë§¤í•‘ - ì£¼ê°„ ë¹„êµ:', {
          weekStartDate: weekStartLocal.toISOString().split('T')[0],
          thisWeekMonday: thisWeekMondayNormalized.toISOString().split('T')[0],
          isSameWeek: weekStartLocalNormalized.getTime() === thisWeekMondayNormalized.getTime(),
          weekStartToUse: weekStartToUse.toISOString().split('T')[0]
        });
        
        const dayIndex = Object.entries(dayMapping).find(([, index]) => {
          const currentDate = new Date(weekStartToUse);
          currentDate.setDate(weekStartToUse.getDate() + index);
          // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¹„êµ
          return currentDate.getMonth() + 1 === month && currentDate.getDate() === day;
        });
        
        console.log('ğŸ” ë‚ ì§œ ë§¤í•‘ í™•ì¸:', {
          targetDate: `${month}-${day}`,
          weekStartDate: weekStartDate.toISOString().split('T')[0],
          weekStartToUse: weekStartToUse.toISOString().split('T')[0],
          dayMapping,
          foundDayIndex: dayIndex
        });
        
        if (dayIndex) {
          const [dayKey] = dayIndex;
          const voteCount = results[dayKey]?.count || 0;
          
          console.log('ğŸ” íˆ¬í‘œ ë°ì´í„° í™•ì¸:', {
            dayKey,
            voteCount,
            hasResults: !!results[dayKey],
            resultsKeys: Object.keys(results)
          });
          
          if (voteCount > 0) {
            totalCount = voteCount;
            
            console.log('âœ… íˆ¬í‘œ ë°ì´í„°ì—ì„œ ì°¸ì„ì ê³„ì‚°:', {
              date: schedule.date,
              dayKey,
              voteCount,
              participants: results[dayKey]?.participants || []
            });
          }
        } else {
          console.log('âš ï¸ ë‚ ì§œ ë§¤í•‘ ì‹¤íŒ¨:', {
            targetDate: `${month}-${day}`,
            weekStartToUse: weekStartToUse.toISOString().split('T')[0],
            scheduleDate: schedule.date
          });
        }
      }
      
      voteCounts.push(totalCount);
      
      console.log('ğŸ” ì´ë²ˆì£¼ ì¼ì • - ê°œë³„ ë‚ ì§œ ê³„ì‚°:', {
        date: schedule.date,
        totalCount,
        month,
        day
      });
      
      return { schedule, totalCount };
    });
    
    // ìµœëŒ€ íˆ¬í‘œ ìˆ˜ ì°¾ê¸°
    const maxVoteCount = voteCounts.length > 0 ? Math.max(...voteCounts) : 0;
    console.log('ğŸ” ìµœëŒ€ íˆ¬í‘œ ìˆ˜:', maxVoteCount, 'ì „ì²´ íˆ¬í‘œ ìˆ˜:', voteCounts);
    
    // ìµœëŒ€ê°’ê³¼ ê°™ì€ ë‚ ì§œì—ë§Œ isConfirmed = true ì„¤ì •
    const updatedData = scheduleDataWithCounts.map(({ schedule, totalCount }) => {
      const isConfirmed = totalCount > 0 && totalCount === maxVoteCount;
      
      // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
      console.log('ğŸ” ì´ë²ˆì£¼ ì¼ì • ê³„ì‚° ê²°ê³¼:', {
        date: schedule.date,
        totalCount,
        isConfirmed,
        maxVoteCount,
        hasGameData: games && games.length > 0,
        hasVoteData: unifiedVoteData && unifiedVoteData.lastWeekResults,
        willReturnCount: totalCount
      });
      
      const result = {
        ...schedule,
        count: totalCount,
        confirmed: isConfirmed
      };
      
      console.log('ğŸ” ë°˜í™˜ë˜ëŠ” ê°ì²´:', {
        date: result.date,
        count: result.count,
        confirmed: result.confirmed
      });
      
      return result;
    });
    
    console.log('âœ… ì—…ë°ì´íŠ¸ëœ ì´ë²ˆì£¼ ì¼ì • ë°ì´í„°:', updatedData.map(d => ({ date: d.date, count: d.count, confirmed: d.confirmed })));
    return updatedData;
  }, [getScheduleData.thisWeekScheduleData, games, unifiedVoteData]);

  // ì¤‘ì•™í™”ëœ ë°ì´í„° ë¡œë”© í•¨ìˆ˜ - í†µí•© API ì‚¬ìš©
  const loadAllData = useCallback(async () => {
    console.log('ğŸ”„ í†µí•© APIë¡œ ë°ì´í„° ë¡œë”© ì‹œì‘...');
    
    setAppData(prev => ({ ...prev, isLoading: true, error: null }));
    
    try {
      // 1. í†µí•© íˆ¬í‘œ ë°ì´í„° ë¡œë“œ (ëª¨ë“  ë°ì´í„° í¬í•¨)
      console.log('ğŸ—³ï¸ í†µí•© íˆ¬í‘œ ë°ì´í„° ë¡œë”©...');
      console.log('ğŸ” getUnifiedVoteDataNew í˜¸ì¶œ ì§ì „');
      let unifiedData;
      try {
        console.log('ğŸ” getUnifiedVoteDataNew í˜¸ì¶œ ì‹œì‘...');
        unifiedData = await getUnifiedVoteDataNew();
        console.log('âœ… getUnifiedVoteDataNew í˜¸ì¶œ ì™„ë£Œ');
        console.log('ğŸ” unifiedData íƒ€ì… í™•ì¸:', typeof unifiedData);
        console.log('ğŸ” unifiedData null/undefined í™•ì¸:', unifiedData === null, unifiedData === undefined);
        console.log('ğŸ” unifiedData ì¡´ì¬ ì—¬ë¶€:', !!unifiedData);
        
        if (!unifiedData) {
          console.error('âŒ unifiedDataê°€ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤!');
          throw new Error('unifiedDataê°€ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤');
        }
        
      console.log('âœ… í†µí•© íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', unifiedData);
        console.log('ğŸ” activeSession í™•ì¸ ì‹œì‘...');
        try {
          console.log('ğŸ” activeSession í™•ì¸:', unifiedData?.activeSession);
        } catch (e) {
          console.error('âŒ activeSession í™•ì¸ ì¤‘ ì—ëŸ¬:', e);
        }
        console.log('ğŸ” allMembers í™•ì¸ ì‹œì‘...');
        try {
          console.log('ğŸ” allMembers í™•ì¸:', unifiedData?.allMembers?.length || 0);
        } catch (e) {
          console.error('âŒ allMembers í™•ì¸ ì¤‘ ì—ëŸ¬:', e);
        }
        console.log('âœ… í†µí•© íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ëª¨ë“  í™•ì¸ ë');
      } catch (error) {
        console.error('âŒ í†µí•© íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        console.error('âŒ ì—ëŸ¬ íƒ€ì…:', typeof error);
        console.error('âŒ ì—ëŸ¬ ë©”ì‹œì§€:', error instanceof Error ? error.message : String(error));
        console.error('âŒ ì—ëŸ¬ ìŠ¤íƒ:', error instanceof Error ? error.stack : undefined);
        throw error;
      }
      
      console.log('ğŸ” í†µí•© ë°ì´í„° ì¶”ì¶œ ì‹œì‘...');
      // í†µí•© ë°ì´í„°ì—ì„œ ê°ê° ì¶”ì¶œ
      const allMembers = unifiedData.allMembers || [];
      let activeSession = unifiedData.activeSession;

      if (!activeSession && unifiedData.lastWeekResults) {
        console.log('ğŸ” lastWeekResults í™•ì¸:', {
          hasLastWeekResults: !!unifiedData.lastWeekResults,
          resultsKeys: unifiedData.lastWeekResults?.results ? Object.keys(unifiedData.lastWeekResults.results) : [],
          hasAbsent: unifiedData.lastWeekResults?.results ? 'ë¶ˆì°¸' in unifiedData.lastWeekResults.results : false,
          absentCount: unifiedData.lastWeekResults?.results?.['ë¶ˆì°¸']?.count
        });
        const fallbackSession = buildFallbackActiveSessionFromLastWeek(unifiedData.lastWeekResults);
        if (fallbackSession) {
          console.log('â„¹ï¸ í™œì„± ì„¸ì…˜ì´ ì—†ì–´ ì§€ë‚œì£¼ ê²°ê³¼ë¥¼ í‘œì‹œìš©ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          console.log('ğŸ” fallbackSession.results keys:', fallbackSession.results ? Object.keys(fallbackSession.results) : []);
          console.log('ğŸ” fallbackSession.results ë¶ˆì°¸:', fallbackSession.results?.['ë¶ˆì°¸']);
          activeSession = fallbackSession;
        }
      }
      console.log('ğŸ” í†µí•© ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ:', {
        allMembersCount: allMembers.length,
        hasActiveSession: !!activeSession
      });
      
      console.log('ğŸ” ì¶”ì¶œëœ activeSession í™•ì¸ ì‹œì‘...');
      try {
        console.log('ğŸ” ì¶”ì¶œëœ activeSession:', activeSession ? {
          sessionId: activeSession.sessionId,
          id: activeSession.id,
          isActive: activeSession.isActive,
          isCompleted: activeSession.isCompleted,
          endTime: activeSession.endTime,
          participantsCount: activeSession.participants?.length || 0
        } : null);
      } catch (e) {
        console.error('âŒ activeSession ë¡œê·¸ ì¶œë ¥ ì¤‘ ì—ëŸ¬:', e);
      }
      
      console.log('ğŸ” í™œì„± ì„¸ì…˜ í™•ì¸ ì‹œì‘...');
      // 2. í™œì„± ì„¸ì…˜ì´ ìˆìœ¼ë©´ íˆ¬í‘œ ë°ì´í„° ì„¤ì •
      let voteResults = null;
      let localNextWeekVoteData: any[] = []; // ê¸°ë³¸ê°’ì„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
      
      // íˆ¬í‘œ ë§ˆê° ì—¬ë¶€ í™•ì¸ (activeSessionì´ isCompleted: trueì¸ ê²½ìš°)
      const isVoteClosedForDataLoad = activeSession?.isCompleted === true;
      
      console.log('ğŸ” activeSession ì¡´ì¬ ì—¬ë¶€:', !!activeSession);
      console.log('ğŸ” activeSession ì „ì²´:', activeSession);
      console.log('ğŸ” activeSession.results:', activeSession?.results);
      console.log('ğŸ” íˆ¬í‘œ ë§ˆê° ì—¬ë¶€:', isVoteClosedForDataLoad);
      
      // íˆ¬í‘œ ë§ˆê° í›„ì—ë„ activeSessionì´ ìˆìœ¼ë©´ activeSession.resultsë¥¼ ì‚¬ìš©
      if (isVoteClosedForDataLoad && activeSession) {
        console.log('âœ… íˆ¬í‘œ ë§ˆê°ë¨ - activeSession.results ì‚¬ìš©í•˜ì—¬ voteResults ì„¤ì •...');
        console.log('ğŸ” íˆ¬í‘œ ë§ˆê° í›„ activeSession.results ì›ë³¸:', activeSession.results);
        const resultsKeys = activeSession.results ? Object.keys(activeSession.results) : [];
        console.log('ğŸ” íˆ¬í‘œ ë§ˆê° í›„ activeSession.results í‚¤ ëª©ë¡:', resultsKeys);
        console.log('ğŸ” íˆ¬í‘œ ë§ˆê° í›„ activeSession.results í‚¤ ìƒì„¸:', resultsKeys.map(key => ({
          key,
          value: activeSession.results[key],
          hasCount: activeSession.results[key]?.count !== undefined,
          count: activeSession.results[key]?.count
        })));
        console.log('ğŸ” ë¶ˆì°¸ í‚¤ ì¡´ì¬ ì—¬ë¶€:', resultsKeys.includes('ë¶ˆì°¸'));
        console.log('ğŸ” ë¶ˆì°¸ ë°ì´í„°:', activeSession.results?.['ë¶ˆì°¸']);
        
        // í™œì„± ì„¸ì…˜ì˜ íˆ¬í‘œ ë°ì´í„°ë¥¼ voteResults í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const participants = activeSession.participants || [];
        const votes = participants.map((p: any) => ({
          id: p.userId || Date.now() + Math.random(),
          userId: p.userId,
          selectedDays: (() => {
          try {
              if (Array.isArray(p.selectedDays)) return p.selectedDays;
              if (typeof p.selectedDays === 'string') return JSON.parse(p.selectedDays || '[]');
              return [];
            } catch { return []; }
          })(),
          createdAt: p.votedAt || new Date().toISOString()
        }));
        
        // activeSession.resultsë¥¼ voteResults í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (count ê°’ë§Œ ì¶”ì¶œ)
        console.log('ğŸ” activeSession.results ì›ë³¸:', activeSession.results);
        console.log('ğŸ” activeSession.results í‚¤ ëª©ë¡:', activeSession.results ? Object.keys(activeSession.results) : []);
        
        const voteResultsData: Record<string, number> = {};
        if (activeSession.results) {
          Object.entries(activeSession.results).forEach(([dayKey, dayResult]: [string, any]) => {
            console.log(`ğŸ” ì²˜ë¦¬ ì¤‘: ${dayKey}`, dayResult);
            if (dayResult && typeof dayResult === 'object' && 'count' in dayResult) {
              voteResultsData[dayKey] = dayResult.count || 0;
            } else if (typeof dayResult === 'number') {
              voteResultsData[dayKey] = dayResult;
            }
          });
        }
        
        console.log('ğŸ” voteResultsData ë³€í™˜ ê²°ê³¼:', voteResultsData);
        console.log('ğŸ” ë¶ˆì°¸ ì¸ì›:', voteResultsData['ë¶ˆì°¸']);

        voteResults = {
            voteSession: {
            id: activeSession.sessionId,
            weekStartDate: activeSession.weekStartDate,
            startTime: activeSession.startTime,
            endTime: activeSession.endTime,
            isActive: activeSession.isActive,
            isCompleted: activeSession.isCompleted,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              votes: votes
            },
        voteResults: voteResultsData
        };
        
        // ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (ìš”ì¼ë§Œ í¬í•¨, 'ë¶ˆì°¸' ì œì™¸)
        localNextWeekVoteData = Object.entries(activeSession.results)
          .filter(([day]) => day !== 'ë¶ˆì°¸') // 'ë¶ˆì°¸' í‚¤ ì œì™¸
          .map(([day, data]: [string, any]) => {
          const dayNames = { MON: 'ì›”', TUE: 'í™”', WED: 'ìˆ˜', THU: 'ëª©', FRI: 'ê¸ˆ' };
          const dayName = dayNames[day as keyof typeof dayNames];
          
          // ê¸°ì¤€ ì›”ìš”ì¼ì—ì„œ í•´ë‹¹ ìš”ì¼ ë‚ ì§œ ê³„ì‚°
          const baseMonday = new Date(activeSession.weekStartDate);
          const dayIndex = { MON: 0, TUE: 1, WED: 2, THU: 3, FRI: 4 }[day as keyof typeof dayNames];
          const targetDate = new Date(baseMonday.getTime() + dayIndex * 24 * 60 * 60 * 1000);
          
          const month = targetDate.getMonth() + 1;
          const dayNum = targetDate.getDate();
          
          return {
            date: `${month}ì›” ${dayNum}ì¼(${dayName})`,
            count: data.count,
            max: false,
            dayName,
            voteDate: targetDate
          };
        });
        
        console.log('âœ… íˆ¬í‘œ ë§ˆê° í›„ voteResults ì„¤ì • ì™„ë£Œ:', voteResults);
        console.log('âœ… ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸:', localNextWeekVoteData);
        console.log('âœ… activeSession.results ê¸°ë°˜ voteResults ì„¤ì • ì™„ë£Œ');
      } else if (activeSession) {
        console.log('âœ… activeSessionì´ ìˆìŒ - voteResults ì„¤ì • ì‹œì‘...');
        // í™œì„± ì„¸ì…˜ì´ ìˆì„ ë•Œë§Œ ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„° ìƒì„±
        localNextWeekVoteData = getScheduleData.nextWeekVoteData.map(vote => ({
            ...vote,
            max: false,
            dayName: vote.date.split('(')[1]?.replace(')', '') || '',
            voteDate: new Date()
        }));
        // í™œì„± ì„¸ì…˜ì˜ íˆ¬í‘œ ë°ì´í„°ë¥¼ voteResults í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        // ë°±ì—”ë“œëŠ” participants ë°°ì—´ì„ ì œê³µí•˜ë¯€ë¡œ ì´ë¥¼ votes í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const participants = activeSession.participants || [];
        const votes = participants.map((p: any) => ({
          id: p.userId || Date.now() + Math.random(),
          userId: p.userId,
          selectedDays: (() => {
          try {
              if (Array.isArray(p.selectedDays)) return p.selectedDays;
              if (typeof p.selectedDays === 'string') return JSON.parse(p.selectedDays || '[]');
              return [];
            } catch { return []; }
          })(),
          createdAt: p.votedAt || new Date().toISOString()
        }));
        
        // activeSession.resultsë¥¼ voteResults í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (count ê°’ë§Œ ì¶”ì¶œ)
        console.log('ğŸ” í™œì„± ì„¸ì…˜ activeSession.results ì›ë³¸:', activeSession.results);
        console.log('ğŸ” í™œì„± ì„¸ì…˜ activeSession.results í‚¤ ëª©ë¡:', activeSession.results ? Object.keys(activeSession.results) : []);
        
        const voteResultsData: Record<string, number> = {};
        if (activeSession.results) {
          Object.entries(activeSession.results).forEach(([dayKey, dayResult]: [string, any]) => {
            console.log(`ğŸ” í™œì„± ì„¸ì…˜ ì²˜ë¦¬ ì¤‘: ${dayKey}`, dayResult);
            if (dayResult && typeof dayResult === 'object' && 'count' in dayResult) {
              voteResultsData[dayKey] = dayResult.count || 0;
            } else if (typeof dayResult === 'number') {
              voteResultsData[dayKey] = dayResult;
            }
          });
        }
        
        console.log('ğŸ” í™œì„± ì„¸ì…˜ voteResultsData ë³€í™˜ ê²°ê³¼:', voteResultsData);
        console.log('ğŸ” í™œì„± ì„¸ì…˜ ë¶ˆì°¸ ì¸ì›:', voteResultsData['ë¶ˆì°¸']);

        voteResults = {
            voteSession: {
            id: activeSession.sessionId,
            weekStartDate: activeSession.weekStartDate,
            startTime: activeSession.startTime,
            endTime: activeSession.endTime,
            isActive: activeSession.isActive,
            isCompleted: activeSession.isCompleted,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              votes: votes
            },
        voteResults: voteResultsData
        };
        
        // ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (ìš”ì¼ë§Œ í¬í•¨, 'ë¶ˆì°¸' ì œì™¸)
        localNextWeekVoteData = Object.entries(activeSession.results)
          .filter(([day]) => day !== 'ë¶ˆì°¸') // 'ë¶ˆì°¸' í‚¤ ì œì™¸
          .map(([day, data]: [string, any]) => {
          const dayNames = { MON: 'ì›”', TUE: 'í™”', WED: 'ìˆ˜', THU: 'ëª©', FRI: 'ê¸ˆ' };
          const dayName = dayNames[day as keyof typeof dayNames];
          
          // ê¸°ì¤€ ì›”ìš”ì¼ì—ì„œ í•´ë‹¹ ìš”ì¼ ë‚ ì§œ ê³„ì‚°
          const baseMonday = new Date(activeSession.weekStartDate);
          const dayIndex = { MON: 0, TUE: 1, WED: 2, THU: 3, FRI: 4 }[day as keyof typeof dayNames];
          const targetDate = new Date(baseMonday.getTime() + dayIndex * 24 * 60 * 60 * 1000);
          
          const month = targetDate.getMonth() + 1;
          const dayNum = targetDate.getDate();
          
          // dataê°€ ê°ì²´ì¸ ê²½ìš° count ì†ì„± ì‚¬ìš©
          const count = (data && typeof data === 'object' && 'count' in data) ? data.count : (typeof data === 'number' ? data : 0);
          
          return {
            date: `${month}ì›” ${dayNum}ì¼(${dayName})`,
            count: count,
            max: false,
            dayName,
            voteDate: targetDate
          };
        });
        
        console.log('âœ… íˆ¬í‘œ ë°ì´í„° ì„¤ì • ì™„ë£Œ:', voteResults);
        console.log('âœ… ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸:', localNextWeekVoteData);
        console.log('âœ… voteResults ì„¤ì • ì™„ë£Œ - activeSession ë¸”ë¡ ì¢…ë£Œ');
      } else {
        // í™œì„± ì„¸ì…˜ì´ ì—†ì„ ë•ŒëŠ” ë¹ˆ íˆ¬í‘œ ë°ì´í„° ì„¤ì •
        console.log('âš ï¸ í™œì„± íˆ¬í‘œ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ íˆ¬í‘œ ë°ì´í„°ë¡œ ì„¤ì •');
        voteResults = {
          voteResults: {},
          voteSession: {
            id: 0,
            weekStartDate: '',
            startTime: '',
            endTime: '',
            isActive: false,
            isCompleted: false,
            createdAt: '',
            updatedAt: '',
            votes: []
          }
        };
        localNextWeekVoteData = [];
        console.log('âš ï¸ ë¹ˆ íˆ¬í‘œ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
      }
      
      console.log('ğŸ” voteResults ìµœì¢… í™•ì¸:', voteResults ? 'ìˆìŒ' : 'null');
      
      // 3. ê²Œì„ ë°ì´í„° ë¡œë“œ (ë³„ë„ try-catchë¡œ ê°ì‹¸ì„œ ì‹¤íŒ¨í•´ë„ íˆ¬í‘œ ë°ì´í„°ëŠ” ìœ ì§€)
      let games: any[] = [];
      let calendarGameData: Record<string, GameData> = {};
      let validCalendarGameData: Record<string, GameData> = {};
      
      try {
        console.log('âš½ ê²Œì„ ë°ì´í„° ë¡œë”© ì‹œì‘...');
        const token = localStorage.getItem('token') || localStorage.getItem('auth_token_backup') || '';
        const gamesUrl = await getApiUrl('/members');
        console.log('ğŸ” ê²Œì„ ë°ì´í„° API URL:', gamesUrl);
        const gamesResponse = await fetch(gamesUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
      
      if (gamesResponse.ok) {
        const unifiedData = await gamesResponse.json();
        games = unifiedData.games || [];
        console.log('ğŸ® ê²Œì„ ë°ì´í„° ë¡œë“œ ì„±ê³µ (í†µí•© API):', games.length, 'ê°œ');
        
        // ê²Œì„ ë°ì´í„°ë¥¼ ë‹¬ë ¥ìš©ìœ¼ë¡œ ë³€í™˜
        games.forEach((game: any) => {
          // ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦
          if (!game.date || typeof game.date !== 'string') {
            console.warn('âš ï¸ ë‚ ì§œê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²Œì„ ë°ì´í„° ê±´ë„ˆëœ€:', game.id, game.date);
            return;
          }
          
          // ë‚ ì§œ ë¬¸ìì—´ì´ NaNì„ í¬í•¨í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
          if (game.date.includes('NaN') || game.date === 'Invalid Date') {
            console.warn('âš ï¸ NaNì„ í¬í•¨í•œ ë‚ ì§œ ë¬¸ìì—´:', game.date, 'ê²Œì„ ID:', game.id);
            return;
          }
          
          let gameDate: Date;
          try {
            gameDate = new Date(game.date);
          } catch (error) {
            console.warn('âš ï¸ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨:', error, 'ê²Œì„ ID:', game.id, 'ë‚ ì§œ:', game.date);
            return;
          }
          
          // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
          if (isNaN(gameDate.getTime())) {
            console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:', game.date, 'ê²Œì„ ID:', game.id);
            return;
          }
          
          // ë‚ ì§œ êµ¬ì„± ìš”ì†Œ ê²€ì¦
          const year = gameDate.getFullYear();
          const month = gameDate.getMonth();
          const day = gameDate.getDate();
          
          if (isNaN(year) || isNaN(month) || isNaN(day)) {
            console.warn('âš ï¸ ë‚ ì§œ êµ¬ì„± ìš”ì†Œê°€ NaN:', { year, month, day }, 'ê²Œì„ ID:', game.id);
            return;
          }
          
          // ISO ë¬¸ìì—´ ìƒì„± ì „ í•œ ë²ˆ ë” ê²€ì¦
          let dateString: string;
          try {
            dateString = gameDate.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
            
            // dateStringì´ ìœ íš¨í•œ í˜•ì‹ì¸ì§€ ê²€ì¦ (YYYY-MM-DD)
            if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString) || dateString.includes('NaN')) {
              console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ ë¬¸ìì—´:', dateString, 'ê²Œì„ ID:', game.id);
              return;
            }
          } catch (error) {
            console.warn('âš ï¸ ë‚ ì§œ ë¬¸ìì—´ ë³€í™˜ ì‹¤íŒ¨:', error, 'ê²Œì„ ID:', game.id);
            return;
          }
          
          // ìë™ìƒì„±ì¼ì •ì€ ì¼ì •í™•ì • ì „ê¹Œì§€ ìº˜ë¦°ë”ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
          if (game.autoGenerated) {
            console.log('â­ï¸ ìë™ìƒì„±ì¼ì • ìº˜ë¦°ë” í‘œì‹œ ê±´ë„ˆëœ€:', dateString, game.eventType);
            return;
          }
          
          // í™•ì •ëœ ê²½ê¸°ë§Œ ë‹¬ë ¥ì— í‘œì‹œ (ìë™ìƒì„±ì¼ì •ì´ ì•„ë‹Œ ê²½ìš°)
          if (!game.autoGenerated) {
            // count ì¬ê³„ì‚°(ë°±ì—”ë“œ ê°’ì´ ë¶€ì •í™•í•œ ê²½ìš° ëŒ€ë¹„)
            const rawMemberNames = Array.isArray(game.memberNames)
              ? game.memberNames
              : (typeof game.memberNames === 'string'
                ? (() => { try { return JSON.parse(game.memberNames); } catch { return []; } })()
                : []);
            const rawSelectedMembers = Array.isArray(game.selectedMembers)
              ? game.selectedMembers
              : (typeof game.selectedMembers === 'string'
                ? (() => { try { return JSON.parse(game.selectedMembers); } catch { return []; } })()
                : []);
            const selectedSet = new Set<string>(rawSelectedMembers.filter(Boolean));
            const otherCount = rawMemberNames.filter((n: any) => {
              if (typeof n !== 'string') return false;
              const t = n.trim();
              if (!t) return false;
              if (t.startsWith('ìš©ë³‘')) return false;
              if (selectedSet.has(t)) return false;
              return true;
            }).length;
            const computedCount = (Number(game.mercenaryCount) || 0) + selectedSet.size + otherCount;
            
            calendarGameData[dateString] = {
              id: String(game.id ?? dateString),
              confirmed: true, // ìë™ìƒì„±ì¼ì •ì´ ì•„ë‹ˆë¯€ë¡œ ëª¨ë‘ í™•ì •ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
              date: gameDate.toISOString(),
              time: game.time || 'ë¯¸ì •',
              location: game.location || 'ë¯¸ì •',
              locationAddress: game.locationAddress || null, // ì£¼ì†Œ ì •ë³´ ì¶”ê°€
              eventType: game.eventType || 'ë¯¸ì •',
              // ì¬ê³„ì‚°í•œ ê°’ ìš°ì„  ì‚¬ìš©
              count: computedCount,
              // ëª¨ë‹¬ í‘œì‹œìš© ì›ìë£Œ ë³´ì¡´
              memberNames: game.memberNames ?? [],
              selectedMembers: game.selectedMembers ?? [],
              mercenaryCount: Number(game.mercenaryCount || 0),
              autoGenerated: false // ìº˜ë¦°ë”ì— í‘œì‹œë˜ëŠ” ê²ƒì€ í™•ì •ëœ ê²Œì„ë§Œ
            };
            console.log('ğŸ“… ë‹¬ë ¥ìš© ê²Œì„ ë°ì´í„° ì¶”ê°€:', dateString, calendarGameData[dateString]);
          }
        });
        
        // ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤(NaN í¬í•¨) ì œê±°
        validCalendarGameData = {};
        for (const [key, value] of Object.entries(calendarGameData)) {
          if (key && !key.includes('NaN') && /^\d{4}-\d{2}-\d{2}/.test(key.split('T')[0])) {
            validCalendarGameData[key] = value;
          } else {
            console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤ ì œê±°:', key);
          }
        }
        
        setGameDataForCalendar(validCalendarGameData);
        console.log('ğŸ“… ë‹¬ë ¥ìš© ê²Œì„ ë°ì´í„° ì„¤ì • ì™„ë£Œ:', Object.keys(validCalendarGameData).length, 'ê°œ (ìœ íš¨í•œ ë°ì´í„°)');
      } else {
        console.error('âŒ ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', gamesResponse.status);
      }
      } catch (gameError) {
        // ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ëŠ” íˆ¬í‘œ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ë³„ë„ ì²˜ë¦¬
        console.error('âŒ ê²Œì„ ë°ì´í„° ë¡œë“œ ì¤‘ ì—ëŸ¬ (íˆ¬í‘œ ê¸°ëŠ¥ì€ ê³„ì† ì§„í–‰):', gameError);
        console.warn('âš ï¸ ê²Œì„ ë°ì´í„°ëŠ” ë¡œë“œí•˜ì§€ ëª»í–ˆì§€ë§Œ, íˆ¬í‘œ ë°ì´í„°ëŠ” ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // gamesëŠ” ì´ë¯¸ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”ë˜ì–´ ìˆìŒ
      }
      
      // 4. ì´ë²ˆì£¼ ì¼ì • ë¡œë“œ (í†µí•© APIì—ì„œ ê°€ì ¸ì˜´)
      console.log('ğŸ“… ì´ë²ˆì£¼ ì¼ì • ë¡œë”©...');
      // const thisWeekResponse = await getThisWeekSchedules();
      // const thisWeekSchedules = thisWeekResponse?.schedules || [];
      
      // 5. í†µí•© ë°ì´í„° ì„¤ì •
      console.log('ğŸ“Š í†µí•© ë°ì´í„° ì„¤ì • ì¤‘...');
      console.log('ğŸ” ìƒíƒœ ì„¤ì • ì „ ë°ì´í„° í™•ì¸:', {
        voteResults: voteResults ? 'ìˆìŒ' : 'null',
        localNextWeekVoteData: localNextWeekVoteData.length,
        games: games.length,
        allMembers: allMembers.length
      });
      
      // ë‹¤ìŒì£¼ íˆ¬í‘œ ë°ì´í„° ìƒíƒœ ë°˜ì˜ (ë‹¬ë ¥/ìš°í•˜ë‹¨ ì„¹ì…˜ í‘œì‹œìš©)
      console.log('ğŸ” setNextWeekVoteData í˜¸ì¶œ ì „...');
      setNextWeekVoteData(localNextWeekVoteData);
      console.log('âœ… setNextWeekVoteData í˜¸ì¶œ ì™„ë£Œ');
      
      console.log('ğŸ” setAppData í˜¸ì¶œ ì „...');
      setAppData({
        games,
        gameDataForCalendar: validCalendarGameData, // validCalendarGameData ì‚¬ìš© (NaN ì œê±°ëœ ë°ì´í„°)
        voteResults,
        nextWeekVoteData: localNextWeekVoteData,
        allMembers,
        isLoading: false,
        error: null,
        lastUpdated: new Date()
      });
      console.log('âœ… setAppData í˜¸ì¶œ ì™„ë£Œ');
      
      // 6. ê°œë³„ ìƒíƒœë„ ì„¤ì • (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
      console.log('ğŸ“Š ê°œë³„ ìƒíƒœ ì„¤ì • ì‹œì‘...');
      console.log('ğŸ“Š ìƒíƒœ ì„¤ì • ì „ í™•ì¸:', {
        voteResults: voteResults ? {
          voteSessionId: voteResults.voteSession?.id,
          voteSessionSessionId: voteResults.voteSession?.sessionId,
          isActive: voteResults.voteSession?.isActive,
          isCompleted: voteResults.voteSession?.isCompleted,
          endTime: voteResults.voteSession?.endTime
        } : null,
        activeSession: activeSession ? {
          sessionId: activeSession.sessionId,
          id: activeSession.id,
          isActive: activeSession.isActive,
          isCompleted: activeSession.isCompleted,
          endTime: activeSession.endTime
        } : null
      });
      
      console.log('ğŸ“Š ìƒíƒœ ì„¤ì • ì§ì „ ìµœì¢… í™•ì¸:', {
        voteResults: voteResults ? {
          voteSessionId: voteResults.voteSession?.id,
          voteSessionSessionId: voteResults.voteSession?.sessionId,
          isActive: voteResults.voteSession?.isActive,
          isCompleted: voteResults.voteSession?.isCompleted
        } : 'null',
        activeSession: activeSession ? {
          sessionId: activeSession.sessionId,
          id: activeSession.id,
          isActive: activeSession.isActive,
          isCompleted: activeSession.isCompleted
        } : 'null'
      });
      
      setAllMembers(allMembers);
      setVoteResults(voteResults);
      setGames(games);
      setNextWeekVoteData(localNextWeekVoteData);
      
      // 7. í†µí•© ë°ì´í„° ì„¤ì • (í•­ìƒ ì„¤ì •í•˜ì—¬ ìƒíƒœ ì•ˆì •ì„± í™•ë³´)
      // activeSessionì´ isCompleted: trueì´ê³  isActive: falseì¸ ê²½ìš°, ì´ë¥¼ lastWeekResultsë¡œë„ ì‚¬ìš©
      let lastWeekResultsToUse = unifiedData.lastWeekResults || null;
      
      if (activeSession && activeSession.isCompleted && !activeSession.isActive) {
        // activeSessionì´ ì™„ë£Œëœ ì„¸ì…˜ì´ë©´ ì´ë¥¼ lastWeekResultsë¡œë„ ì‚¬ìš©
        // ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì²˜ë¦¬í–ˆì§€ë§Œ, í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ëª…ì‹œì ìœ¼ë¡œ í™•ì¸
        if (!lastWeekResultsToUse || !lastWeekResultsToUse.results) {
          console.log('âœ… activeSessionì´ ì™„ë£Œëœ ì„¸ì…˜ì´ë¯€ë¡œ lastWeekResultsë¡œ ì‚¬ìš©');
          // activeSessionì˜ ê²°ê³¼ë¥¼ lastWeekResults í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          const activeResults: any = {};
          if (activeSession.results) {
            Object.entries(activeSession.results).forEach(([dayKey, dayResult]: [string, any]) => {
              activeResults[dayKey] = {
                count: dayResult?.count || 0,
                participants: dayResult?.participants || []
              };
            });
          }
          
          lastWeekResultsToUse = {
            sessionId: activeSession.sessionId || activeSession.id,
            weekStartDate: activeSession.weekStartDate,
            startTime: activeSession.startTime,
            endTime: activeSession.endTime,
            isActive: false,
            isCompleted: true,
            results: activeResults,
            participants: activeSession.participants || [],
            totalParticipants: activeSession.totalParticipants || 0
          };
        }
      }
      
      const unifiedVoteDataToSet = {
        activeSession: activeSession || null, // activeSessionì´ ì—†ì–´ë„ nullë¡œ ëª…ì‹œì  ì„¤ì •
        allMembers: allMembers, // ì´ë¯¸ ì¶”ì¶œí•œ allMembers ë³€ìˆ˜ ì‚¬ìš©
        lastWeekResults: lastWeekResultsToUse // ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ëœ lastWeekResults ì‚¬ìš©
      };
      console.log('ğŸ“Š unifiedVoteData ì„¤ì •:', unifiedVoteDataToSet);
      console.log('ğŸ“Š unifiedVoteData.activeSession í™•ì¸:', unifiedVoteDataToSet.activeSession);
      console.log('ğŸ“Š unifiedVoteData.lastWeekResults í™•ì¸:', unifiedVoteDataToSet.lastWeekResults);
      setUnifiedVoteData(unifiedVoteDataToSet);
      
      // ìƒíƒœ ì„¤ì • í›„ ì¦‰ì‹œ í™•ì¸ (ë‹¤ìŒ ë Œë”ë§ ì‚¬ì´í´ì—ì„œ í™•ì¸ë¨)
      setTimeout(() => {
        console.log('ğŸ“Š ìƒíƒœ ì„¤ì • í›„ í™•ì¸ (ë‹¤ìŒ ì‚¬ì´í´):', {
          unifiedVoteDataActiveSession: unifiedVoteDataToSet.activeSession ? 'ìˆìŒ' : 'ì—†ìŒ',
          voteResultsSession: voteResults?.voteSession ? 'ìˆìŒ' : 'ì—†ìŒ'
        });
      }, 100);
      
      console.log('âœ… loadAllData ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ');
      
    } catch (error) {
      console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ì‹¬ê°í•œ ì—ëŸ¬):', error);
      console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
        message: error instanceof Error ? error.message : String(error),
        stack: error instanceof Error ? error.stack : undefined
      });
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„°ë¡œ ì„¤ì •í•˜ì—¬ í™”ë©´ì´ ì™„ì „íˆ ê¹¨ì§€ì§€ ì•Šë„ë¡ í•¨
      // ë‹¨, unifiedVoteDataëŠ” ì´ë¯¸ ì„¤ì •ëœ ê²½ìš° ìœ ì§€ (ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ)
      setAppData(prev => ({
        ...prev,
        isLoading: false,
        error: null, // ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
        lastUpdated: new Date()
      }));
      
      // ê¸°ë³¸ ë°ì´í„° ì„¤ì • (ë‹¨, unifiedVoteDataëŠ” ìœ ì§€)
      console.log('âš ï¸ ì‹¬ê°í•œ ì—ëŸ¬ ë°œìƒ - ê¸°ë³¸ ë°ì´í„° ì„¤ì • (ë‹¨, unifiedVoteDataëŠ” ìœ ì§€)');
      setAllMembers([]);
      // setVoteResults(null); // voteResultsë„ ìœ ì§€ (ì´ë¯¸ ì„¤ì •ëœ ê²½ìš°)
      setGames([]);
      setNextWeekVoteData([]);
      // setUnifiedVoteData(null); // unifiedVoteDataëŠ” ìœ ì§€ - íˆ¬í‘œ ê¸°ëŠ¥ì„ ìœ„í•´ í•„ìˆ˜!
      console.log('âœ… unifiedVoteDataì™€ voteResultsëŠ” ìœ ì§€ë˜ì–´ íˆ¬í‘œ ê¸°ëŠ¥ì´ ê³„ì† ì‘ë™í•©ë‹ˆë‹¤.');
    } finally {
      console.log('âœ… loadAllData í•¨ìˆ˜ ì™„ë£Œ (ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨)');
    }
  }, []);



  // íˆ¬í‘œ ê²°ê³¼ë¥¼ localStorageì— ì €ì¥ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
  // const saveVoteResultsToStorage = (results: VoteResults) => {
  //   localStorage.setItem('voteResults', JSON.stringify(results));
  // };

  // íˆ¬í‘œ ì œì¶œ ì²˜ë¦¬ (1ì¸ 1íšŒ ë³µìˆ˜ë‚ ì§œ íˆ¬í‘œ)
  const handleVoteSubmit = async () => {
    // ì¸ì¦ ìƒíƒœ í™•ì¸
    let token = localStorage.getItem('token');
    const storedUser = localStorage.getItem('user');
    
    console.log('ğŸ” íˆ¬í‘œ ì œì¶œ ì‹œ í† í° í™•ì¸:', token ? 'í† í° ìˆìŒ' : 'í† í° ì—†ìŒ');
    console.log('ğŸ” ì‚¬ìš©ì ì •ë³´:', user);
    console.log('ğŸ” ì €ì¥ëœ ì‚¬ìš©ì:', storedUser ? 'ìˆìŒ' : 'ì—†ìŒ');
    console.log('ğŸ” í† í° ê¸¸ì´:', token ? token.length : 0);
    
    // í† í°ì´ ì—†ìœ¼ë©´ ê°•í™”ëœ í† í° ë³µêµ¬ ì‹œë„
    if (!token) {
      console.log('âš ï¸ íˆ¬í‘œ ì‹œ ê°•í™”ëœ í† í° ë³µêµ¬ ì‹œë„...');
      reloadTokenFromStorage();
      
      // ë³µêµ¬ í›„ ë‹¤ì‹œ í™•ì¸ (ì—¬ëŸ¬ ì†ŒìŠ¤ì—ì„œ)
      token = localStorage.getItem('token') || 
              localStorage.getItem('auth_token_backup') || 
              sessionStorage.getItem('token');
      
      if (!token) {
        console.log('âŒ í† í° ë³µêµ¬ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
        toast({
          title: 'íˆ¬í‘œ ì‹¤íŒ¨',
          description: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.',
          status: 'error',
          duration: 3000,
          isClosable: true,
        });
        navigate('/login');
        return;
      }
      console.log('âœ… í† í° ë³µêµ¬ ì„±ê³µ! ê¸¸ì´:', token.length);
      // ë³µêµ¬ëœ í† í°ì„ ë‹¤ì‹œ ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
      localStorage.setItem('token', token);
      localStorage.setItem('auth_token_backup', token);
      sessionStorage.setItem('token', token);
    }
    
    if (!token || !user) {
      console.log('âŒ ì¸ì¦ ì‹¤íŒ¨ - í† í°:', !!token, 'ì‚¬ìš©ì:', !!user);
      toast({
        title: 'íˆ¬í‘œ ì‹¤íŒ¨',
        description: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      navigate('/login');
      return;
    }

    // íˆ¬í‘œ ë§ˆê° í™•ì¸
    if (isVoteClosed) {
      toast({
        title: 'íˆ¬í‘œ ë§ˆê°',
        description: 'íˆ¬í‘œ ê¸°ê°„ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      return;
    }

    // ì„ íƒê°’ ì •ê·œí™”: 'ë¶ˆì°¸'ì´ í¬í•¨ë˜ë©´ ë‹¨ë… ì„ íƒìœ¼ë¡œ ê°•ì œ, ì¤‘ë³µ/ê³µë°± ì œê±°
    const normalizedSelectedDays = (() => {
      const trimmed = selectedDays.map(d => (typeof d === 'string' ? d.trim() : d));
      if (trimmed.includes('ë¶ˆì°¸')) return ['ë¶ˆì°¸'];
      const unique = Array.from(new Set(trimmed));
      return unique.filter(Boolean);
    })();

    // ì„ íƒëœ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ê²½ê³ 
    if (normalizedSelectedDays.length === 0) {
      toast({
        title: 'ë‚ ì§œ ì„ íƒ í•„ìš”',
        description: 'ìš”ì¼ ë˜ëŠ” ë¶ˆì°¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.',
        status: 'warning',
        duration: 2500,
        isClosable: true,
      });
      return;
    }
    
    console.log('âœ… ì¸ì¦ ì„±ê³µ - íˆ¬í‘œ ì§„í–‰');

    // ì¸ì¦ í† í° ì¬í™•ì¸ (ì¤‘ë³µ ì„ ì–¸ ì œê±°)
    token = token || localStorage.getItem('token') || localStorage.getItem('auth_token_backup') || sessionStorage.getItem('token');
    if (!token) {
      toast({
        title: 'íˆ¬í‘œ ì‹¤íŒ¨',
        description: 'ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      return;
    }
    
    // í† í° ìœ íš¨ì„± ê²€ì¦
    try {
      const tokenPayload = JSON.parse(atob(token.split('.')[1]));
      const currentTime = Math.floor(Date.now() / 1000);
      if (tokenPayload.exp && tokenPayload.exp < currentTime) {
        toast({
          title: 'íˆ¬í‘œ ì‹¤íŒ¨',
          description: 'í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
          status: 'error',
          duration: 3000,
          isClosable: true,
        });
        return;
      }
    } catch (e) {
      toast({
        title: 'íˆ¬í‘œ ì‹¤íŒ¨',
        description: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      return;
    }

    // í™œì„± ì„¸ì…˜ ID í™•ë³´ - voteResultsë¥¼ ìš°ì„ ì ìœ¼ë¡œ í™•ì¸ (ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€)
    // sessionIdì™€ id ë‘˜ ë‹¤ í™•ì¸ (ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
    let voteSessionId = voteResults?.voteSession?.id ||
                        voteResults?.voteSession?.sessionId ||
                        unifiedVoteData?.activeSession?.sessionId || 
                        unifiedVoteData?.activeSession?.id;
    
    console.log('ğŸ” íˆ¬í‘œ ì„¸ì…˜ ID í™•ì¸:', {
      unifiedSessionId: unifiedVoteData?.activeSession?.sessionId,
      unifiedId: unifiedVoteData?.activeSession?.id,
      voteResultsId: voteResults?.voteSession?.id,
      voteResultsSessionId: voteResults?.voteSession?.sessionId,
      ìµœì¢…voteSessionId: voteSessionId
    });
    
    if (!voteSessionId) {
      // ê¸°ë³¸ íˆ¬í‘œ ì„¸ì…˜ ìƒì„±
      const currentDate = new Date();
      const nextThursday = new Date(currentDate);
      nextThursday.setDate(currentDate.getDate() + (4 - currentDate.getDay() + 7) % 7); // ë‹¤ìŒ ëª©ìš”ì¼
      nextThursday.setHours(17, 0, 0, 0); // 17ì‹œ
      
      const defaultVoteSession = {
        id: Date.now(),
        weekStartDate: (() => {
          const now = new Date();
          const currentDay = now.getDay();
          const daysToMonday = currentDay === 0 ? -6 : 1 - currentDay;
          const monday = new Date(now);
          monday.setDate(now.getDate() + daysToMonday);
          return monday.toISOString().split('T')[0];
        })(),
        startTime: new Date().toISOString(),
        endTime: nextThursday.toISOString(),
        isActive: true,
        isCompleted: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        votes: []
      };
      
      // voteResults ì—…ë°ì´íŠ¸
      setVoteResults(prev => ({
        voteResults: prev?.voteResults || {},
        voteSession: defaultVoteSession
      }));
      
      voteSessionId = defaultVoteSession.id;
    }
    
    // í˜„ì¬ ì‚¬ìš©ìê°€ ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸
    const hasUserVoted = voteResults?.voteSession?.votes?.some((vote: any) => 
      Number(vote.userId) === Number(user?.id)
    );
    
    console.log('ğŸ” ì‚¬ìš©ì íˆ¬í‘œ ì—¬ë¶€ í™•ì¸:', { hasUserVoted, userId: user?.id });
    
    try {
      // APIì— íˆ¬í‘œ ë°ì´í„° ì „ì†¡
      const voteUrl = await getApiUrl('/votes');
      console.log('ğŸ” íˆ¬í‘œ API URL:', voteUrl);
      const response = await fetch(voteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          voteSessionId: voteSessionId,
          selectedDays: normalizedSelectedDays,
          timestamp: new Date().toISOString()
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('âœ… íˆ¬í‘œ API ì„±ê³µ:', result);
        
        // ì„±ê³µ ë©”ì‹œì§€
        const isAbsentVote = (normalizedSelectedDays.length === 1 && normalizedSelectedDays[0] === 'ë¶ˆì°¸');
        toast({
          title: hasUserVoted ? 'ì¬íˆ¬í‘œ ì™„ë£Œ' : 'íˆ¬í‘œ ì™„ë£Œ',
          description: isAbsentVote
            ? 'ë¶ˆì°¸ìœ¼ë¡œ íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
            : (hasUserVoted 
                ? `${selectedDays.length}ê°œ ë‚ ì§œë¡œ ì¬íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`
                : `${selectedDays.length}ê°œ ë‚ ì§œì— íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`),
          status: 'success',
          duration: 3000,
          isClosable: true,
        });
        
        // ì¹´ì¹´ì˜¤ ê³µìœ  ì•ˆë‚´ í‘œì‹œ
        setVoteShareDays(normalizedSelectedDays);
        setIsShareAbsentVote(isAbsentVote);
        setShowVoteSharePrompt(true);

        // íˆ¬í‘œ ì™„ë£Œ í›„ ì„ íƒëœ ë‚ ì§œ ì´ˆê¸°í™”
        setSelectedDays([]);
        
        // í—¤ë”ì˜ íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë°œìƒ
        window.dispatchEvent(new CustomEvent('voteSubmitted', {
          detail: { 
            userId: user?.id,
            sessionId: voteSessionId,
            selectedDays: selectedDays.length
          }
        }));
        
        // ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë” ê°•ë ¥í•œ ì—…ë°ì´íŠ¸)
        const newVote = {
          id: Date.now(),
          userId: user?.id,
          selectedDays: normalizedSelectedDays,
          createdAt: new Date().toISOString()
        };
        
        setVoteResults(prev => {
          if (!prev) {
            // voteResultsê°€ nullì¸ ê²½ìš° ê¸°ë³¸ êµ¬ì¡° ìƒì„±
            return {
              voteResults: {
                ['ë¶ˆì°¸']: newVote.selectedDays.includes('ë¶ˆì°¸') ? 1 : 0
              },
              voteSession: {
                id: voteSessionId,
                weekStartDate: new Date().toISOString().split('T')[0],
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                isActive: true,
                isCompleted: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                votes: [newVote]
              }
            };
          }
          
          if (!prev.voteSession) {
            // voteSessionì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ êµ¬ì¡° ìƒì„±
            return {
              ...prev,
              voteResults: {
                ...prev.voteResults,
                ['ë¶ˆì°¸']:
                  (prev.voteResults?.['ë¶ˆì°¸'] || 0) + (newVote.selectedDays.includes('ë¶ˆì°¸') ? 1 : 0)
              },
              voteSession: {
                id: voteSessionId,
                weekStartDate: new Date().toISOString().split('T')[0],
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                isActive: true,
                isCompleted: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                votes: [newVote]
              }
            };
          }
          
          // ê¸°ì¡´ íˆ¬í‘œê°€ ìˆìœ¼ë©´ ì œê±°í•˜ê³  ìƒˆ íˆ¬í‘œ ì¶”ê°€
          const existingVotes = prev.voteSession.votes.filter((v: any) => v.userId !== user?.id);
          const updatedVotes = [...existingVotes, newVote];
          
          return {
            ...prev,
            voteResults: {
              ...prev.voteResults,
              ['ë¶ˆì°¸']:
                // ê¸°ì¡´ì— ë³¸ì¸ì´ ë¶ˆì°¸ìœ¼ë¡œ íˆ¬í‘œí–ˆë‹¤ë©´ -1, ì´ë²ˆ íˆ¬í‘œê°€ ë¶ˆì°¸ì´ë©´ +1
                (prev.voteResults?.['ë¶ˆì°¸'] || 0)
                - (prev.voteSession.votes.some((v: any) => Number(v.userId) === Number(user?.id) && Array.isArray(v.selectedDays) && v.selectedDays.includes('ë¶ˆì°¸')) ? 1 : 0)
                + (newVote.selectedDays.includes('ë¶ˆì°¸') ? 1 : 0)
            },
            voteSession: {
              ...prev.voteSession,
              votes: updatedVotes
            }
          };
        });

        // ë¡œì»¬ ìºì‹œ ì—…ë°ì´íŠ¸
        try {
          localVotesRef.current = (localVotesRef.current || []).filter((v: any) => Number(v.userId) !== Number(user?.id));
          localVotesRef.current = [...localVotesRef.current, newVote];
        } catch {}
        
        // ê°•ì œ ë¦¬ë Œë”ë§ì„ ìœ„í•œ ìƒíƒœ ì—…ë°ì´íŠ¸
        setAppData(prev => ({
          ...prev,
          lastUpdated: new Date()
        }));
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
        setTimeout(async () => {
          try {
            await loadAllData();
            // íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ
            window.dispatchEvent(new CustomEvent('voteDataChanged'));
            console.log('âœ… íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ');
          } catch (error) {
            console.error('âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
          }
        }, 100);
        
      } else {
        const errorData = await response.json();
        console.error('âŒ íˆ¬í‘œ API ì‹¤íŒ¨:', errorData);
        toast({
          title: 'íˆ¬í‘œ ì‹¤íŒ¨',
          description: errorData.error || 'íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          status: 'error',
          duration: 3000,
          isClosable: true,
        });
      }
    } catch (error) {
      console.error('âŒ íˆ¬í‘œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      toast({
        title: 'íˆ¬í‘œ ì‹¤íŒ¨',
        description: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
    }
  };

  const handleKakaoShare = async () => {
    const shareUrl = `${window.location.origin}/schedule-v2?utm=vote_share`;
    const shareText = voteShareText;

    if (kakaoAppKey) {
      try {
        await shareKakaoText(kakaoAppKey, {
          text: shareText,
          url: shareUrl,
          buttonTitle: 'íˆ¬í‘œ í™•ì¸í•˜ê¸°',
        });
        return;
      } catch (error) {
        console.warn('ì¹´ì¹´ì˜¤ ê³µìœ  ì‹¤íŒ¨, ëŒ€ì²´ ê³µìœ ë¡œ ì „í™˜:', error);
      }
    }

    // ì¹´ì¹´ì˜¤ í‚¤ê°€ ì—†ê±°ë‚˜ SDK ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê³µìœ ë¡œ ëŒ€ì²´
    const fallbackText = shareText;
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'FC CHAL-GGYEO íˆ¬í‘œ ì™„ë£Œ',
          text: fallbackText,
          url: shareUrl,
        });
        return;
      } catch (error) {
        console.warn('ê¸°ë³¸ ê³µìœ  ì‹¤íŒ¨:', error);
      }
    }

    try {
      await navigator.clipboard.writeText(fallbackText);
      toast({
        title: 'ê³µìœ  ë‚´ìš© ë³µì‚¬ ì™„ë£Œ',
        description: 'ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.',
        status: 'success',
        duration: 2500,
        isClosable: true,
      });
    } catch (error) {
      toast({
        title: 'ê³µìœ  ì‹¤íŒ¨',
        description: 'ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        status: 'error',
        duration: 2500,
        isClosable: true,
      });
    }
  };

  const handleCopyShareText = async () => {
    try {
      await navigator.clipboard.writeText(voteShareText);
      toast({
        title: 'ë©”ì‹œì§€ ë³µì‚¬ ì™„ë£Œ',
        description: 'ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.',
        status: 'success',
        duration: 2500,
        isClosable: true,
      });
    } catch (error) {
      toast({
        title: 'ë³µì‚¬ ì‹¤íŒ¨',
        description: 'ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        status: 'error',
        duration: 2500,
        isClosable: true,
      });
    }
  };

  // ì¬íˆ¬í‘œ ì²˜ë¦¬ í•¨ìˆ˜
  const handleRevote = async () => {
    try {
      // í˜„ì¬ ì‚¬ìš©ìì˜ íˆ¬í‘œ ë°ì´í„° ì‚­ì œ
      const token = localStorage.getItem('token') || localStorage.getItem('auth_token_backup') || sessionStorage.getItem('token');
      
      console.log('ğŸ” ì¬íˆ¬í‘œ í† í° í™•ì¸:', { 
        token: token ? 'ìˆìŒ' : 'ì—†ìŒ', 
        tokenLength: token?.length || 0,
        user: user ? 'ìˆìŒ' : 'ì—†ìŒ',
        userId: user?.id,
        localStorage_token: localStorage.getItem('token') ? 'ìˆìŒ' : 'ì—†ìŒ',
        localStorage_backup: localStorage.getItem('auth_token_backup') ? 'ìˆìŒ' : 'ì—†ìŒ',
        sessionStorage_token: sessionStorage.getItem('token') ? 'ìˆìŒ' : 'ì—†ìŒ'
      });
      
      if (!token || !user) {
        toast({
          title: 'ì¸ì¦ ì˜¤ë¥˜',
          description: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
          status: 'error',
          duration: 3000,
          isClosable: true,
        });
        return;
      }

      // í˜„ì¬ í™œì„± ì„¸ì…˜ í™•ì¸
      if (unifiedVoteData?.activeSession && unifiedVoteData.activeSession.isActive) {
        await deleteVote(user.id);
        
        // ë¡œì»¬ ìƒíƒœ ì´ˆê¸°í™”
        setSelectedDays([]);
        
        // í—¤ë”ì˜ íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë°œìƒ
        window.dispatchEvent(new CustomEvent('voteSubmitted', {
          detail: { 
            userId: user.id,
            sessionId: unifiedVoteData.activeSession.id,
            action: 'delete'
          }
        }));
        
        // ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (íˆ¬í‘œ ì‚­ì œ)
        setVoteResults(prev => {
          if (!prev || !prev.voteSession) return prev;
          
          const updatedVotes = prev.voteSession.votes.filter((v: any) => v.userId !== user.id);
          
          return {
            ...prev,
            voteSession: {
              ...prev.voteSession,
              votes: updatedVotes
            }
          };
        });
        
        // ê°•ì œ ë¦¬ë Œë”ë§ì„ ìœ„í•œ ìƒíƒœ ì—…ë°ì´íŠ¸
        setAppData(prev => ({
          ...prev,
          lastUpdated: new Date()
        }));
        
        // íˆ¬í‘œ ê²°ê³¼ ìƒˆë¡œê³ ì¹¨ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
        setTimeout(async () => {
          try {
            await loadAllData();
            // íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ
            window.dispatchEvent(new CustomEvent('voteDataChanged'));
            console.log('âœ… íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ');
          } catch (error) {
            console.error('âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
          }
        }, 100);
        
        toast({
          title: 'íˆ¬í‘œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤',
          description: 'ë‹¤ì‹œ íˆ¬í‘œí•´ì£¼ì„¸ìš”.',
          status: 'success',
          duration: 2000,
          isClosable: true,
        });
      } else {
        toast({
          title: 'ì¬íˆ¬í‘œ ë¶ˆê°€',
          description: 'í™œì„± íˆ¬í‘œ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.',
          status: 'warning',
          duration: 3000,
          isClosable: true,
        });
      }
    } catch (error) {
      console.error('ì¬íˆ¬í‘œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
      toast({
        title: 'ì¬íˆ¬í‘œ ì´ˆê¸°í™” ì‹¤íŒ¨',
        description: 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
    }
  };


  // ì‚¬ìš©ìê°€ ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
  const hasUserVoted = () => {
    if (!user) return false;
    // 1) í†µí•© ë°ì´í„° ìš°ì„  (ì„œë²„ ì§„ì‹¤ê°’)
    const unifiedParticipants = unifiedVoteData?.activeSession?.participants;
    if (Array.isArray(unifiedParticipants)) {
      const found = unifiedParticipants.some((p: any) => Number(p.userId) === Number(user.id));
      if (found) return true;
    }
    // 2) ë¡œì»¬ ë°±ì—…
    if (voteResults?.voteSession?.votes) {
      return voteResults.voteSession.votes.some((vote: any) => Number(vote.userId) === Number(user.id));
    }
    return false;
  };

  // íˆ¬í‘œ ë§ˆê° ìƒíƒœ í™•ì¸ (ì„¸ì…˜ ìƒíƒœ ë˜ëŠ” ë§ˆê°ì¼ ê¸°ì¤€)
  const isVoteClosed = useMemo(() => {
    // voteResultsë¥¼ ìš°ì„ ì ìœ¼ë¡œ í™•ì¸ (ë” ì•ˆì •ì  - ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€)
    // unifiedVoteDataëŠ” ë³´ì¡°ì ìœ¼ë¡œë§Œ ì‚¬ìš©
    const voteResultsSession = voteResults?.voteSession;
    const unifiedSession = unifiedVoteData?.activeSession;
    // voteResultsSessionì„ ìš°ì„  ì‚¬ìš© (ì´ë¯¸ ì„¤ì •ëœ ê²½ìš°)
    const session = voteResultsSession || unifiedSession;
    
    console.log('ğŸ” isVoteClosed ê³„ì‚°:', {
      unifiedVoteData: unifiedVoteData ? 'ìˆìŒ' : 'null',
      hasUnifiedSession: !!unifiedSession,
      unifiedSessionType: typeof unifiedSession,
      unifiedSessionValue: unifiedSession,
      hasVoteResultsSession: !!voteResultsSession,
      voteResultsSessionType: typeof voteResultsSession,
      voteResultsSessionValue: voteResultsSession,
      session: session ? {
        id: session.id || session.sessionId,
        isActive: session.isActive,
        isCompleted: session.isCompleted,
        endTime: session.endTime
      } : null
    });
    
    if (!session) {
      console.log('âŒ ì„¸ì…˜ì´ ì—†ìŒ - íˆ¬í‘œ ë§ˆê°');
      return true; // í™œì„± ì„¸ì…˜ ì—†ìœ¼ë©´ í‘œì‹œ ë¹„í™œì„±
    }
    
    // ì™„ë£Œëœ ì„¸ì…˜ì€ íˆ¬í‘œ ë¶ˆê°€ëŠ¥
    if (session.isCompleted === true) {
      console.log('âŒ ì„¸ì…˜ì´ ì™„ë£Œë¨ - íˆ¬í‘œ ë§ˆê°');
      return true;
    }
    
    // isActive: falseì´ì§€ë§Œ isCompleted: falseì¸ ê²½ìš°ëŠ” íˆ¬í‘œ ê°€ëŠ¥ (ë°±ì—”ë“œì—ì„œ ë§ˆê°ë˜ì—ˆì§€ë§Œ ì™„ë£Œë˜ì§€ ì•Šì€ ì„¸ì…˜)
    // ë”°ë¼ì„œ isActive: falseë§Œìœ¼ë¡œëŠ” íˆ¬í‘œë¥¼ ë§‰ì§€ ì•ŠìŒ
    const now = new Date();
    const end = session.endTime ? new Date(session.endTime) : null;
    if (end && now > end) {
      console.log('âŒ íˆ¬í‘œ ë§ˆê° ì‹œê°„ ì´ˆê³¼ - íˆ¬í‘œ ë§ˆê°');
      return true;
    }
    
    console.log('âœ… íˆ¬í‘œ ê°€ëŠ¥');
    return false;
  }, [unifiedVoteData, voteResults]);

  const effectiveVoteResults = useMemo(() => {
    if (isVoteClosed && unifiedVoteData?.lastWeekResults?.results) {
      return unifiedVoteData.lastWeekResults.results;
    }
    return unifiedVoteData?.activeSession?.results || null;
  }, [isVoteClosed, unifiedVoteData]);

  const voteParticipationInfo = useMemo(() => {
    if (!unifiedVoteData?.allMembers || unifiedVoteData.allMembers.length === 0) return null;

    const normalizeId = (value: any): number => {
      if (typeof value === 'number') return value;
      if (typeof value === 'string') {
        const parsed = Number(value);
        return Number.isNaN(parsed) ? -1 : parsed;
      }
      return -1;
    };

    const votedUserIds = new Set<number>();
    const collectIds = (participants?: any[]) => {
      if (!participants || !Array.isArray(participants)) return;
      participants.forEach((participant: any) => {
        const id = normalizeId(participant?.userId ?? participant?.id);
        if (id > -1) votedUserIds.add(id);
      });
    };

    const sessionParticipants = isVoteClosed
      ? unifiedVoteData?.lastWeekResults?.participants
      : unifiedVoteData?.activeSession?.participants;
    collectIds(sessionParticipants);

    if (effectiveVoteResults) {
      Object.values(effectiveVoteResults).forEach((dayResult: any) => {
        collectIds(dayResult?.participants);
      });
    }

    if (Array.isArray(unifiedVoteData.allSessions)) {
      unifiedVoteData.allSessions.forEach((session: any) => {
        collectIds(session?.participants);
      });
    }

    const allMembers = unifiedVoteData.allMembers;
    const votedMembers = allMembers
      .filter((member: any) => votedUserIds.has(normalizeId(member.id)))
      .map((member: any) => member.name);
    const nonVotedMembers = allMembers
      .filter((member: any) => !votedUserIds.has(normalizeId(member.id)))
      .map((member: any) => member.name);

    const uniqueVoters = votedMembers.length;
    const totalMembers = allMembers.length;
    const participationRate = totalMembers > 0 ? Math.round((uniqueVoters / totalMembers) * 100) : 0;

    return {
      totalMembers,
      uniqueVoters,
      participationRate,
      votedMembers,
      nonVotedMembers
    };
  }, [unifiedVoteData, effectiveVoteResults, isVoteClosed]);

  // íˆ¬í‘œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ê²°ì •
  const getVoteButtonText = () => {
    if (isVoteClosed) return 'íˆ¬í‘œ ë§ˆê°';
    if (hasUserVoted()) return 'ì¬íˆ¬í‘œí•˜ê¸°';
    return 'íˆ¬í‘œí•˜ê¸°';
  };

  // íˆ¬í‘œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleVoteButtonClick = () => {
    if (!user) {
      toast({
        title: 'ë¡œê·¸ì¸ í•„ìš”',
        description: 'íˆ¬í‘œí•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
        status: 'warning',
        duration: 3000,
        isClosable: true,
      });
      navigate('/login');
      return;
    }

    if (isVoteClosed) {
      toast({
        title: 'íˆ¬í‘œ ë§ˆê°',
        description: 'íˆ¬í‘œ ê¸°ê°„ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      return;
    }
    
    if (hasUserVoted()) {
      handleRevote();
    } else {
      handleVoteSubmit();
    }
  };



  // íˆ¬í‘œ í˜„í™© í‘œì‹œ
  const handleShowVoteStatus = () => {
    setShowVoteStatus(true);
  };

  // ëŒ“ê¸€ ì¶”ê°€ í•¸ë“¤ëŸ¬
  const handleAddComment = () => {
    if (commentText.trim() && user) {
      const newComment = {
        text: commentText,
        user: user.name,
        date: `${new Date().getMonth() + 1}.${new Date().getDate()}.` // 8.19. í˜•ì‹
      };
      setComments(prev => [...prev, newComment]);
      setCommentText('');
      toast({
        title: 'ëŒ“ê¸€ ì¶”ê°€',
        description: 'ëŒ“ê¸€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
        status: 'success',
        duration: 3000,
        isClosable: true,
      });
    } else {
      toast({
        title: 'ëŒ“ê¸€ ì‹¤íŒ¨',
        description: 'ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
    }
  };

  // ëŒ“ê¸€ ìˆ˜ì • í•¸ë“¤ëŸ¬
  const handleEditComment = (index: number) => {
    setEditingCommentIndex(index);
    setEditCommentText(comments[index].text);
  };

  // ëŒ“ê¸€ ìˆ˜ì • ì €ì¥ í•¸ë“¤ëŸ¬
  const handleSaveEditComment = (index: number) => {
    if (editCommentText.trim()) {
      const updatedComments = [...comments];
      updatedComments[index] = { ...updatedComments[index], text: editCommentText };
      setComments(updatedComments);
      setEditingCommentIndex(null);
      setEditCommentText('');
      toast({
        title: 'ëŒ“ê¸€ ìˆ˜ì •',
        description: 'ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
        status: 'success',
        duration: 3000,
        isClosable: true,
      });
    }
  };

  // ëŒ“ê¸€ ì‚­ì œ í•¸ë“¤ëŸ¬
  const handleDeleteComment = (index: number) => {
    const updatedComments = comments.filter((_, i) => i !== index);
    setComments(updatedComments);
    toast({
      title: 'ëŒ“ê¸€ ì‚­ì œ',
      description: 'ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
      status: 'success',
      duration: 3000,
      isClosable: true,
    });
  };

  // ì •ì§€ í•´ì œ ìš”ì²­ ì œì¶œ
  const handleSuspensionRequestSubmit = () => {
    if (!suspensionRequestReason.trim()) {
      toast({
        title: 'ìš”ì²­ ì‹¤íŒ¨',
        description: 'ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
      return;
    }

    if ((window as any).addSuspensionRequest && user) {
      (window as any).addSuspensionRequest(user.id, user.name, suspensionRequestReason.trim());
      
      setSuspensionRequestReason('');
      setShowSuspensionRequestModal(false);
      
      toast({
        title: 'ìš”ì²­ ì™„ë£Œ',
        description: 'ì •ì§€ í•´ì œ ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ê²€í†  í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤.',
        status: 'success',
        duration: 5000,
        isClosable: true,
      });
      } else {
      toast({
        title: 'ìš”ì²­ ì‹¤íŒ¨',
        description: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        status: 'error',
        duration: 3000,
        isClosable: true,
      });
    }
  };



  // ì œê±°ëœ í•¨ìˆ˜: fetchGamesFromAdmin (ì¤‘ì•™í™”ëœ loadAllDataë¡œ ëŒ€ì²´ë¨)

  // ì œê±°ëœ í•¨ìˆ˜: autoCreateGamesFromSchedule (ì¤‘ì•™í™”ëœ loadAllDataë¡œ ëŒ€ì²´ë¨)

  // ìˆ˜ë™ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜


  // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ìë™ ë³µêµ¬
  useEffect(() => {
    console.log('ğŸ”„ í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ìë™ ë³µêµ¬ ì‹œì‘...');
    reloadTokenFromStorage();
  }, [reloadTokenFromStorage]);

  // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    console.log('ğŸš€ useEffect ì‹œì‘ - loadData í˜¸ì¶œ ì˜ˆì •');
    
    const loadData = async () => {
      console.log('ğŸ“¥ loadData í•¨ìˆ˜ ì‹œì‘');
      // í† í° ê²€ì¦ (ë” ê´€ëŒ€í•˜ê²Œ)
      const token = localStorage.getItem('token');
      const userData = localStorage.getItem('user');
      
      console.log('ğŸ” í† í° ë° ì‚¬ìš©ì ë°ì´í„° í™•ì¸:', {
        hasToken: !!token,
        hasUserData: !!userData
      });
      
      if (!token) {
        console.log('âŒ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰');
        // í† í°ì´ ì—†ì–´ë„ ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰
        await loadAllData();
        return;
      }
      
      // ì‚¬ìš©ì ë°ì´í„°ê°€ localStorageì— ìˆìœ¼ë©´ ì¼ë‹¨ ì§„í–‰
      if (userData) {
        try {
          const parsedUser = JSON.parse(userData);
          console.log('âœ… localStorageì—ì„œ ì‚¬ìš©ì ë°ì´í„° í™•ì¸:', parsedUser.name);
          
          // ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
          try {
            await refreshUserData();
            console.log('âœ… ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì„±ê³µ');
    } catch (error) {
            console.warn('âš ï¸ ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, localStorage ë°ì´í„° ì‚¬ìš©:', error);
            // ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨í•´ë„ localStorage ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê³„ì† ì§„í–‰
            // localStorage ë°ì´í„°ë¥¼ ìŠ¤í† ì–´ì— ì„¤ì •
            setUser(parsedUser);
          }
          
          // ì¤‘ì•™í™”ëœ ë°ì´í„° ë¡œë”©
          await loadAllData();
          return;
        } catch (error) {
          console.error('âŒ localStorage ì‚¬ìš©ì ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
        }
      }
      
      // localStorageì— ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨ ì‹œë„
      try {
        await refreshUserData();
        console.log('âœ… ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì„±ê³µ');
        
        // ì¤‘ì•™í™”ëœ ë°ì´í„° ë¡œë”©
        await loadAllData();
    } catch (error) {
        console.error('âŒ ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        console.warn('âš ï¸ ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰');
        
        // ì‚¬ìš©ì ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰
        await loadAllData();
        return;
      }
    };
    
    loadData();
  }, []);

  // íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë³„ë„ useEffectë¡œ ë¶„ë¦¬)
  useEffect(() => {
    const handleVoteDataChanged = () => {
      console.log('ğŸ”„ íˆ¬í‘œ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ìˆ˜ì‹  - ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
      loadAllData();
    };
    
    // ê²½ê¸° ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const handleGameDataChanged = () => {
      console.log('ğŸ”„ ê²½ê¸° ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ ìˆ˜ì‹  - ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
      loadAllData();
    };
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    window.addEventListener('voteDataChanged', handleVoteDataChanged);
    window.addEventListener('gameDataChanged', handleGameDataChanged);
    
    return () => {
      window.removeEventListener('voteDataChanged', handleVoteDataChanged);
      window.removeEventListener('gameDataChanged', handleGameDataChanged);
    };
  }, [loadAllData]);

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨
  useEffect(() => {
    const forceRefreshData = async () => {
      console.log('ğŸ”„ í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨...');
      // ì£¼ì˜: ì¸ì¦ í† í°ì„ ë³´ì¡´í•´ì•¼ í•˜ë¯€ë¡œ ìŠ¤í† ë¦¬ì§€ëŠ” ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
      // í•„ìš”í•œ ë¹„ì¸ì¦ ìºì‹œë§Œ ê°œë³„ í‚¤ë¡œ ì •ë¦¬í•˜ë„ë¡ ìœ ì§€
      // ì˜ˆ) localStorage.removeItem('some_non_auth_cache_key');

      // ì¤‘ì•™í™”ëœ ë°ì´í„° ë¡œë”©
      await loadAllData();
      
      console.log('âœ… ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    };
    
    forceRefreshData();
  }, []);

  // ë§¤ì£¼ ì›”ìš”ì¼ 00:01 ìë™ ì—…ë°ì´íŠ¸ ë¡œì§
  useEffect(() => {
    const checkAndUpdateWeeklySchedule = () => {
      const now = new Date();
      const currentDay = now.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      
      // ë§¤ì£¼ ì›”ìš”ì¼ 00:01 ì²´í¬
      if (currentDay === 1 && currentHour === 0 && currentMinute === 1) {
        console.log('ğŸ• ë§¤ì£¼ ì›”ìš”ì¼ 00:01 - ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘');
        
        // 1ë‹¨ê³„: ì§€ë‚œì£¼ ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ê²°ê³¼ë¥¼ ì´ë²ˆì£¼ ì¼ì •ìœ¼ë¡œ ë°˜ì˜
        updateThisWeekSchedule();
        
        // 2ë‹¨ê³„: ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ìë™ ë°˜ì˜
        updateNextWeekVoteSchedule();
        
        // 3ë‹¨ê³„: ê´€ë¦¬ì-ê²½ê¸°ê´€ë¦¬ì— ìë™ ì¶”ê°€
        updateAdminGameManagement();
      }
    };

    // 1ë¶„ë§ˆë‹¤ ì²´í¬ (ì •í™•í•œ 00:01 íƒ€ì´ë°ì„ ìœ„í•´)
    const interval = setInterval(checkAndUpdateWeeklySchedule, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // 1ë‹¨ê³„: ì§€ë‚œì£¼ ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ê²°ê³¼ë¥¼ ì´ë²ˆì£¼ ì¼ì •ìœ¼ë¡œ ë°˜ì˜
  const updateThisWeekSchedule = () => {
    console.log('ğŸ“… 1ë‹¨ê³„: ì´ë²ˆì£¼ ì¼ì • ìë™ ì—…ë°ì´íŠ¸');
    
    // íˆ¬í‘œ ê²°ê³¼ì—ì„œ ìµœë‹¤ íˆ¬í‘œë¥¼ ë°›ì€ ë‚ ì§œ ì°¾ê¸°
    if (voteResults && voteResults.voteResults) {
      const maxVoteCount = Math.max(...Object.values(voteResults.voteResults));
      const maxVoteDate = Object.keys(voteResults.voteResults).find(
        date => voteResults.voteResults[date] === maxVoteCount
      );
      
      if (maxVoteDate && maxVoteCount > 0) {
        console.log(`âœ… ìµœë‹¤ íˆ¬í‘œ ë‚ ì§œ: ${maxVoteDate}, ì¸ì›ìˆ˜: ${maxVoteCount}ëª…`);
        
        // ì´ë²ˆì£¼ ì¼ì •ì— ìë™ ë°˜ì˜
        const updatedSchedule = getScheduleData.thisWeekScheduleData.map(schedule => {
          if (schedule.date.includes(maxVoteDate.split('-')[2])) {
            return {
              ...schedule,
              count: maxVoteCount,
              confirmed: true
            };
          }
          return schedule;
        });
        
        // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
        console.log('ğŸ“Š ì´ë²ˆì£¼ ì¼ì • ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', updatedSchedule);
      }
    }
  };

  // 2ë‹¨ê³„: ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ìë™ ë°˜ì˜
  const updateNextWeekVoteSchedule = () => {
    console.log('ğŸ—³ï¸ 2ë‹¨ê³„: ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ìë™ ë°˜ì˜');
    
    // ì‹¤ì œ ë‹¤ìŒì£¼ ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const currentDay = now.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
    
    // ì´ë²ˆì£¼ ì›”ìš”ì¼ ê³„ì‚°
    let daysUntilMonday;
    if (currentDay === 0) { // ì¼ìš”ì¼
      daysUntilMonday = -6; // ì§€ë‚œ ì›”ìš”ì¼
    } else if (currentDay === 1) { // ì›”ìš”ì¼
      daysUntilMonday = 0; // ì˜¤ëŠ˜
    } else {
      daysUntilMonday = 1 - currentDay; // ì´ë²ˆì£¼ ì›”ìš”ì¼
    }
    
    const thisWeekMonday = new Date(now);
    thisWeekMonday.setDate(now.getDate() + daysUntilMonday);
    
    // ë‹¤ìŒì£¼ ì›”ìš”ì¼ ê³„ì‚°
    const nextWeekMonday = new Date(thisWeekMonday);
    nextWeekMonday.setDate(thisWeekMonday.getDate() + 7);
    
    // ë‹¤ìŒì£¼ íˆ¬í‘œ ì¼ì • ìë™ ìƒì„± (ì‹¤ì œ ë‹¤ìŒì£¼ ì›”-ê¸ˆ)
    const nextWeekVoteData = [];
    for (let i = 0; i < 5; i++) {
      const date = new Date(nextWeekMonday);
      date.setDate(nextWeekMonday.getDate() + i);
      
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
      const dayName = dayNames[i];
      
      nextWeekVoteData.push({
        date: `${month}ì›” ${day}ì¼(${dayName})`,
        count: 0
      });
    }
    
    console.log('ğŸ“Š ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ ìë™ ë°˜ì˜ ì™„ë£Œ:', nextWeekVoteData);
  };

  // 3ë‹¨ê³„: ê´€ë¦¬ì-ê²½ê¸°ê´€ë¦¬ì— ìë™ ì¶”ê°€
  const updateAdminGameManagement = () => {
    console.log('âš™ï¸ 3ë‹¨ê³„: ê´€ë¦¬ì-ê²½ê¸°ê´€ë¦¬ ìë™ ì¶”ê°€');
    
    // íˆ¬í‘œ ê²°ê³¼ì—ì„œ ìµœë‹¤ íˆ¬í‘œë¥¼ ë°›ì€ ë‚ ì§œì˜ ì •ë³´
    if (voteResults && voteResults.voteResults) {
      const maxVoteCount = Math.max(...Object.values(voteResults.voteResults));
      const maxVoteDate = Object.keys(voteResults.voteResults).find(
        date => voteResults.voteResults[date] === maxVoteCount
      );
      
      if (maxVoteDate && maxVoteCount > 0) {
        // íˆ¬í‘œí•œ ì¸ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const memberNames = getVoteMemberNames(maxVoteDate, voteResults, user);
        
        // ê´€ë¦¬ì-ê²½ê¸°ê´€ë¦¬ì— ìë™ ì¶”ê°€í•  ë°ì´í„°
        const autoGameData = {
          date: maxVoteDate,
          count: maxVoteCount,
          memberNames: memberNames,
          selectedMembers: memberNames.slice(0, Math.floor(maxVoteCount / 2)), // ì˜ˆì‹œ: ì ˆë°˜ì„ ì„ íƒëœ íšŒì›ìœ¼ë¡œ
          mercenaryCount: 0,
          manualInput: memberNames.slice(Math.floor(maxVoteCount / 2)), // ë‚˜ë¨¸ì§€ë¥¼ ìˆ˜ê¸°ì…ë ¥ìœ¼ë¡œ
          eventType: null, // ê´€ë¦¬ì ì…ë ¥ í•„ìš”
          time: null, // ê´€ë¦¬ì ì…ë ¥ í•„ìš”
          location: null, // ê´€ë¦¬ì ì…ë ¥ í•„ìš”
          autoGenerated: true, // ìë™ ìƒì„±ëœ ë°ì´í„°ì„ì„ í‘œì‹œ
          createdAt: new Date().toISOString()
        };
        
        console.log('âš½ ê´€ë¦¬ì-ê²½ê¸°ê´€ë¦¬ ìë™ ì¶”ê°€ ë°ì´í„°:', autoGameData);
        
        // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        // saveGameToAdmin(autoGameData);
      }
    }
  };

  // ìë™ ì—…ë°ì´íŠ¸ ìƒíƒœ í‘œì‹œ (ë”ë¯¸ë°ì´í„° ì‹œì—° í›„ ì‹¤ì œ êµ¬í˜„ ì˜ˆì •)
  /*
  const [autoUpdateStatus, setAutoUpdateStatus] = useState<{
    lastUpdate: Date | null;
    nextUpdate: Date | null;
    isAutoGenerated: boolean;
  }>({
    lastUpdate: null,
    nextUpdate: null,
    isAutoGenerated: false
  });

  // ë‹¤ìŒ ì›”ìš”ì¼ 00:01 ê³„ì‚°
  useEffect(() => {
    const calculateNextUpdate = () => {
      const now = new Date();
      const daysUntilMonday = (8 - now.getDay()) % 7; // ë‹¤ìŒ ì›”ìš”ì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜
      const nextMonday = new Date(now);
      nextMonday.setDate(now.getDate() + daysUntilMonday);
      nextMonday.setHours(0, 1, 0, 0); // 00:01:00.000
      
      setAutoUpdateStatus(prev => ({
        ...prev,
        nextUpdate: nextMonday
      }));
    };
    
    calculateNextUpdate();
  }, []);
  */

  // ê²Œì„ í´ë¦­ í•¸ë“¤ëŸ¬


  // ì´ë²ˆì£¼ ì¼ì • ë”ë¯¸ë°ì´í„° (ì´ë¯¸ì§€ ë””ìì¸ì— ë§ê²Œ)
  // const thisWeekScheduleData = [
  //   {
  //     id: 1,
  //     date: '8ì›” 18ì¼(ì›”)',
  //     count: 0,
  //     confirmed: false
  //   },
  //   {
  //     id: 2,
  //     date: '8ì›” 19ì¼(í™”)',
  //     count: 0,
  //     confirmed: false
  //   },
  //   {
  //     id: 3,
  //     date: '8ì›” 20ì¼(ìˆ˜)',
  //     count: 6,
  //     confirmed: true
  //   },
  //   {
  //     id: 4,
  //     date: '8ì›” 21ì¼(ëª©)',
  //     count: 0,
  //     confirmed: false
  //   },
  //   {
  //     id: 5,
  //     date: '8ì›” 22ì¼(ê¸ˆ)',
  //     count: 0,
  //     confirmed: false
  //   }
  // ];

  // ì´ë²ˆì£¼ ì¼ì • ì„¹ì…˜
  const renderThisWeekSchedule = () => (
    <Box
      bg="white"
      px={{ base: 3, md: 4 }}
      pt={{ base: 0.5, md: 1 }}
      pb={{ base: 2, md: 3 }}
      borderRadius="lg"
      boxShadow="sm"
      border="1px solid"
      borderColor="gray.200"
      flex="1"
    >
      <Flex align="center" gap={{ base: 0.6, md: 1 }} mb={0} mt={0}>
        <Box as="span" fontSize={{ base: "md", md: "lg" }}>âš½</Box>
        <Text fontSize={{ base: "md", md: "lg" }} fontWeight="bold">ì´ë²ˆì£¼ ì¼ì •</Text>
      </Flex>
      
      <VStack spacing={{ base: 0, md: 0 }} align="stretch" mb={{ base: 1, md: 1 }}>
        {updateThisWeekScheduleWithGames.map((schedule) => {
          const actualCount = schedule.count;
          const isConfirmed = schedule.confirmed;
          
          console.log('ğŸ” ë Œë”ë§ - ì´ë²ˆì£¼ ì¼ì •:', {
            date: schedule.date,
            count: schedule.count,
            actualCount,
            isConfirmed,
            scheduleObject: schedule
          });
          
          return (
            <Box
              key={schedule.date}
              position="relative"
              px={{ base: 4, md: 6 }}
              py={0}
              minH="auto"
              h="auto"
            >
              <Flex justify="space-between" align="center" py={{ base: '-1px', md: '-1px' }} px={0} lineHeight={1}>
                <Flex align="center" gap={{ base: 1, md: 1.5 }} flex="1" minW="0">
                <Text 
                  fontSize={{ base: "xs", md: "sm" }} 
                  fontWeight={isConfirmed ? "bold" : "normal"} 
                  noOfLines={1}
                    lineHeight={1}
                  color={(() => {
                    // ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ìš”ì¼ ì¶”ì¶œí•˜ì—¬ ì£¼ë§ íŒë³„
                    const match = schedule.date.match(/\((.)\)/);
                    if (!match) return 'gray.700';
                    const day = match[1];
                    
                    // ì£¼ë§ ë˜ëŠ” ê³µíœ´ì¼ ì²´í¬
                    const isWeekend = (day === 'í† ' || day === 'ì¼');
                    const isHoliday = isHolidayDate(schedule.date);
                    
                    return (isWeekend || isHoliday) ? 'red.500' : 'gray.700';
                  })()}
                    ml="-11px"
                >
                  {schedule.date}
                </Text>
                {isConfirmed && (
                <Badge 
                  colorScheme="blue" 
                  variant="outline" 
                  borderRadius="full" 
                  fontSize={{ base: "2xs", md: "xs" }} 
                  px={{ base: 1, md: 1.5 }} 
                  py={{ base: 0.5, md: 0.5 }}
                  minW={{ base: "28px", md: "32px" }}
                  textAlign="center"
                  bg="white"
                  borderColor="blue.600"
                  color="blue.600"
                  fontWeight="bold"
                  flexShrink={0}
                >
                  ìµœë‹¤
                </Badge>
              )}
            </Flex>
            <Flex align="center" gap={2} flexShrink={0}>
              <Tooltip
                label={(() => {
                    if (actualCount === 0) {
                      return 'ì°¸ì„ì ì—†ìŒ';
                    }
                    
                    // ì´ë²ˆì£¼ ì¼ì •ì€ ì§€ë‚œì£¼ íˆ¬í‘œ ê²°ê³¼(lastWeekResults)ë§Œ ì‚¬ìš© (ê²Œì„ ë°ì´í„° ì œì™¸, activeSession ì œì™¸)
                    if (actualCount === 0) {
                      return 'ì°¸ì„ì ì—†ìŒ';
                    }
                    
                    const dayMatch = schedule.date.match(/(\d+)ì›” (\d+)ì¼/);
                    if (dayMatch && unifiedVoteData?.lastWeekResults) {
                      const month = parseInt(dayMatch[1]);
                      const day = parseInt(dayMatch[2]);
                      
                      // ì´ë²ˆì£¼ ì¼ì •ì€ lastWeekResultsë§Œ ì‚¬ìš© (ì§€ë‚œì£¼ íˆ¬í‘œ ê²°ê³¼)
                      const resultsToCheck = unifiedVoteData.lastWeekResults.results;
                      
                      if (resultsToCheck) {
                        // ì´ë²ˆì£¼ ì›”ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ìš”ì¼ ë§¤í•‘
                        const thisWeekMonday = new Date();
                        const currentDay = thisWeekMonday.getDay();
                        let daysUntilMonday;
                        if (currentDay === 0) {
                          daysUntilMonday = -6;
                        } else if (currentDay === 1) {
                          daysUntilMonday = 0;
                        } else {
                          daysUntilMonday = 1 - currentDay;
                        }
                        const thisWeekMondayCalc = new Date(thisWeekMonday);
                        thisWeekMondayCalc.setDate(thisWeekMonday.getDate() + daysUntilMonday);
                        thisWeekMondayCalc.setHours(0, 0, 0, 0);
                        const thisWeekMondayNormalized = new Date(thisWeekMondayCalc.getFullYear(), thisWeekMondayCalc.getMonth(), thisWeekMondayCalc.getDate());
                        
                        const dayMapping = { 'MON': 0, 'TUE': 1, 'WED': 2, 'THU': 3, 'FRI': 4 };
                        const targetDayIndex = Object.entries(dayMapping).find(([, index]) => {
                          const currentDate = new Date(thisWeekMondayNormalized);
                          currentDate.setDate(thisWeekMondayNormalized.getDate() + index);
                          return currentDate.getMonth() + 1 === month && currentDate.getDate() === day;
                        });
                        
                        if (targetDayIndex) {
                          const [dayKey] = targetDayIndex;
                          const dayResult = resultsToCheck[dayKey];
                          if (dayResult && dayResult.participants) {
                            const names = dayResult.participants.map((p: any) => {
                              if (typeof p === 'object' && p !== null) {
                                return p.userName || p.name || String(p);
                              }
                              return String(p);
                            }).filter(Boolean);
                            if (names.length > 0) {
                              console.log('ğŸ” íˆ´íŒ ì´ë¦„ í‘œì‹œ (ì§€ë‚œì£¼ íˆ¬í‘œ ê²°ê³¼):', { date: schedule.date, dayKey, names });
                              return names.join(', ');
                            }
                          }
                        }
                      }
                    }
                    
                    // ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ë°˜í™˜
                    return actualCount > 0 ? `${actualCount}ëª… ì°¸ì„` : 'ì°¸ì„ì ì—†ìŒ';
                })()}
                placement="top"
                hasArrow
                bg="blue.600"
                color="white"
                fontSize="sm"
                borderRadius="md"
                px={3}
                py={2}
                maxW="200px"
                whiteSpace="normal"
              >
                <Badge 
                  colorScheme="blue" 
                  variant="solid" 
                  borderRadius="full" 
                  px={{ base: 2, md: 3 }} 
                  py={{ base: 0.5, md: 1 }} 
                  fontSize={{ base: "2xs", md: "xs" }}
                    bg={(() => {
                      if (isConfirmed) return "blue.600"; // ìµœë‹¤: íŒŒë€ìƒ‰ ìœ ì§€
                      if (actualCount > 0) return "blue.600"; // ìµœë‹¤ê°€ ì•„ë‹Œ íˆ¬í‘œì ìˆìŒ: íŒŒë€ìƒ‰
                      return "gray.200"; // íˆ¬í‘œì ì—†ìŒ: íšŒìƒ‰
                    })()}
                    color={(() => {
                      if (isConfirmed) return "white"; // ìµœë‹¤: í°ìƒ‰
                      if (actualCount > 0) return "white"; // ìµœë‹¤ê°€ ì•„ë‹Œ íˆ¬í‘œì ìˆìŒ: í°ìƒ‰
                      return "gray.600"; // íˆ¬í‘œì ì—†ìŒ: íšŒìƒ‰
                    })()}
                    opacity={(() => {
                      if (isConfirmed) return 1; // ìµœë‹¤: ë¶ˆíˆ¬ëª…
                      if (actualCount > 0) return 0.4; // ìµœë‹¤ê°€ ì•„ë‹Œ íˆ¬í‘œì ìˆìŒ: 60% íˆ¬ëª…ë„
                      return 1; // íˆ¬í‘œì ì—†ìŒ: ë¶ˆíˆ¬ëª…
                    })()}
                  w={{ base: "40px", md: "45px" }}
                  h={{ base: "20px", md: "22px" }}
                  display="flex"
                  alignItems="center"
                  justifyContent="center"
                    fontWeight={isConfirmed ? "bold" : "normal"}
                  flexShrink={0}
                  lineHeight={1.1}
                  mr="-11px"
                >
                    {isHolidayDate(schedule.date) ? '-' : `${actualCount}ëª…`}
                </Badge>
              </Tooltip>
            </Flex>
          </Flex>
            </Box>
          );
        })}
      </VStack>
    </Box>
  );

  // íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ì—ì„œ íˆ¬í‘œ ë©¤ë²„ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (í†µí•© API êµ¬ì¡°)
  const getVoteMemberNames = (date: string, voteResults: VoteResults | null, _user: any) => {
    const memberNames: string[] = [];
    
    console.log('ğŸ” getVoteMemberNames í˜¸ì¶œ:', {
      date,
      allMembersCount: allMembers.length,
      unifiedVoteData: unifiedVoteData ? 'ìˆìŒ' : 'ì—†ìŒ',
      activeSession: unifiedVoteData?.activeSession ? 'ìˆìŒ' : 'ì—†ìŒ',
      participants: unifiedVoteData?.activeSession?.participants?.length || 0
    });
    
    // í†µí•© API ë°ì´í„°ì—ì„œ íˆ¬í‘œì ì´ë¦„ ì°¾ê¸°
    if (unifiedVoteData?.activeSession?.participants) {
      const participants = unifiedVoteData.activeSession.participants;

      // ê¸°ì¤€ ì›”ìš”ì¼: activeSession.weekStartDate(ì´ë²ˆì£¼ ì›”ìš”ì¼) ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒì£¼ ê³„ì‚°
      const baseWeekStartISO: string | undefined = unifiedVoteData?.activeSession?.weekStartDate;
      let baseMonday: Date;
      if (baseWeekStartISO) {
        baseMonday = new Date(baseWeekStartISO);
      } else {
        // fallback: í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì´ë²ˆì£¼ ì›”ìš”ì¼
        const now = new Date();
        const currentDay = now.getDay();
        const daysUntilMonday = currentDay === 0 ? -6 : 1 - currentDay;
        baseMonday = new Date(now);
        baseMonday.setDate(now.getDate() + daysUntilMonday);
      }
      const nextWeekMonday = new Date(baseMonday);
      nextWeekMonday.setDate(baseMonday.getDate() + 7);

      console.log('ğŸ” ê¸°ì¤€ ì›”ìš”ì¼ ê³„ì‚°:', { baseWeekStartISO, baseMonday: baseMonday.toISOString(), nextWeekMonday: nextWeekMonday.toISOString(), uiDate: date });

      // ê° ì°¸ê°€ìì— ëŒ€í•´ í•´ë‹¹ ë‚ ì§œì— íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸
      participants.forEach((participant: any) => {
        console.log('ğŸ” ì°¸ê°€ì ë¶„ì„:', {
          userId: participant.userId,
          userName: participant.userName,
          selectedDays: participant.selectedDays
        });
        
        if (participant.selectedDays && Array.isArray(participant.selectedDays)) {
          // selectedDaysì˜ ê° ë‚ ì§œë¥¼ ì‹¤ì œ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì„œ ë¹„êµ
          const hasVotedForDate = participant.selectedDays.some((selectedDay: string) => {
            console.log('ğŸ” ì„ íƒëœ ë‚ ì§œ í™•ì¸:', { selectedDay, targetDate: date });
            
            // selectedDayê°€ 'MON', 'TUE' ë“±ì˜ í˜•íƒœì¸ ê²½ìš°
            const dayMapping = { 'MON': 0, 'TUE': 1, 'WED': 2, 'THU': 3, 'FRI': 4 };
            const dayIndex = dayMapping[selectedDay as keyof typeof dayMapping];
            
            if (dayIndex !== undefined) {
              // activeSession.weekStartDate ê¸°ì¤€ ë‹¤ìŒì£¼ ì›”ìš”ì¼ì—ì„œ í•´ë‹¹ ìš”ì¼ ë‚ ì§œ ê³„ì‚°
              const targetDate = new Date(nextWeekMonday.getTime() + dayIndex * 24 * 60 * 60 * 1000);
              const month = targetDate.getMonth() + 1;
              const day = targetDate.getDate();
              const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
              const dayName = dayNames[dayIndex];
              const formattedDate = `${month}ì›” ${day}ì¼(${dayName})`;
              
              console.log('ğŸ” ë‚ ì§œ ë³€í™˜:', { selectedDay, formattedDate, targetDate: date, match: formattedDate === date });
              return formattedDate === date;
            }
            
            // selectedDayê°€ ì´ë¯¸ í•œêµ­ì–´ í˜•ì‹ì¸ ê²½ìš°
            if (selectedDay === date) {
              console.log('ğŸ” ì§ì ‘ ë§¤ì¹­:', { selectedDay, date });
              return true;
            }
            
            return false;
          });
          
          if (hasVotedForDate) {
            console.log('âœ… íˆ¬í‘œì ì°¾ìŒ:', participant);
            // ë¨¼ì € participant.userNameì´ ìˆìœ¼ë©´ ì‚¬ìš©
            if (participant.userName) {
              memberNames.push(participant.userName);
              console.log('âœ… userName ì‚¬ìš©:', participant.userName);
            } else {
              // ì—†ìœ¼ë©´ allMembersì—ì„œ ì°¾ê¸°
            const member = allMembers.find(m => m.id === participant.userId);
            if (member) {
              memberNames.push(member.name);
                console.log('âœ… allMembersì—ì„œ ì°¾ìŒ:', member.name);
              } else {
                // ê·¸ë˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                memberNames.push(`íšŒì›${participant.userId}`);
                console.log('âš ï¸ ê¸°ë³¸ê°’ ì‚¬ìš©:', `íšŒì›${participant.userId}`);
              }
            }
          }
        }
      });
    }
    
    // í†µí•© API ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
    if (memberNames.length === 0 && voteResults && voteResults.voteSession && voteResults.voteSession.votes) {
      console.log('ğŸ” ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©');
      voteResults.voteSession.votes.forEach(vote => {
        if (vote.selectedDays && Array.isArray(vote.selectedDays)) {
          const hasVotedForDate = vote.selectedDays.some((selectedDate: string) => {
            const dateObj = new Date(selectedDate);
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dateObj.getDay()];
            const formattedDate = `${month}ì›” ${day}ì¼(${dayOfWeek})`;
            return formattedDate === date;
          });
          
          if (hasVotedForDate) {
            const member = allMembers.find(m => m.id === vote.userId);
            if (member) {
              memberNames.push(member.name);
            } else {
              memberNames.push(`íšŒì›${vote.userId}`);
            }
          }
        }
      });
    }
    
    console.log('ğŸ“Š ìµœì¢… ë©¤ë²„ ì´ë¦„:', memberNames);
    return memberNames;
  };

  // ë¶ˆì°¸ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë³„ë„ í•¨ìˆ˜)
  const getAbsentMemberNames = (voteResults: VoteResults | null, user: any) => {
    if (!voteResults || !voteResults.voteSession || !voteResults.voteSession.votes) {
    return [];
    }

    const absentMembers: string[] = [];
    
    // íˆ¬í‘œ ì„¸ì…˜ì—ì„œ 'ë¶ˆì°¸'ì„ ì„ íƒí•œ ì‚¬ìš©ì ì°¾ê¸°
    voteResults.voteSession.votes.forEach(vote => {
      if (vote.selectedDays.includes('ë¶ˆì°¸')) {
        // ì‹¤ì œ íšŒì› ì •ë³´ì— ë”°ë¥¸ ì´ë¦„ ë§¤í•‘
        // ì‹¤ì œ íšŒì› ë°ì´í„°ì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì°¾ê¸°
        let userName = 'ì•Œ ìˆ˜ ì—†ìŒ';
        const member = allMembers.find(m => m.id === vote.userId);
        if (member) {
          userName = member.name;
        }
        
        // ì‹¤ì œ ì‚¬ìš©ì ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë§¤í•‘ëœ ì´ë¦„ ì‚¬ìš©
        if (user?.name && vote.userId === user.id) {
          userName = user.name;
        }
        
        absentMembers.push(userName);
      }
    });

    return absentMembers;
  };

  // ê²½ê¸°ì •ë³´ ëª¨ë‹¬ ìƒíƒœ
  const [showGameModal, setShowGameModal] = useState(false);
  const [selectedGameData, setSelectedGameData] = useState<any>(null);

  // ê²½ê¸°ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
  const handleShowGameModal = (gameData: any) => {
    setSelectedGameData(gameData);
    setShowGameModal(true);
  };

  // ê²½ê¸°ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
  const handleCloseGameModal = () => {
    setShowGameModal(false);
    setSelectedGameData(null);
  };

  return (
    <Box minH="100vh" bg="white" pt="80px">
      <style>
        {`
          /* ì• ë‹ˆë©”ì´ì…˜ ì˜µì…˜ë“¤ - ì›í•˜ëŠ” ê²ƒì„ ì„ íƒí•´ì„œ ì£¼ì„ í•´ì œí•˜ì„¸ìš” */
          
          /* ì˜µì…˜ 1: ê¹œë¹¡ì„ (í˜„ì¬ ì ìš©ë¨) */
          @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
          }
          
          /* ì˜µì…˜ 2: ë¶€ë“œëŸ¬ìš´ í™•ëŒ€/ì¶•ì†Œ (í˜„ì¬ ì ìš©ë¨) */
          @keyframes gentleScale {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
          }
          
          /* ì˜µì…˜ 3: ìœ„ì•„ë˜ ì›€ì§ì„ */
          @keyframes gentleBounce {
            0% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
            100% { transform: translateY(0); }
          }
          
          /* ì˜µì…˜ 4: í…Œë‘ë¦¬ ê¹œë¹¡ì„ */
          @keyframes borderGlow {
            0% { border: 2px solid transparent; }
            50% { border: 2px solid purple; }
            100% { border: 2px solid transparent; }
          }
          
          /* ì˜µì…˜ 5: ìƒ‰ìƒ ë³€í™” */
          @keyframes colorShift {
            0% { background-color: rgb(147, 51, 234); }
            50% { background-color: rgb(168, 85, 247); }
            100% { background-color: rgb(147, 51, 234); }
          }
          
          /* ê¸€ë¡œìš° íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
          @keyframes glowEffect {
            0% { box-shadow: 0 0 10px rgba(147, 51, 234, 0.3); }
            50% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.6); }
            100% { box-shadow: 0 0 10px rgba(147, 51, 234, 0.3); }
          }
        `}
      </style>
      <Box minH="100vh" bg="gray.50" w="100%" overflowX="hidden" maxW="100vw" boxSizing="border-box">
        <Flex direction="column" minH="100vh" bg="gray.50" overflowX="hidden" maxW="100vw">
        {/* ë©”ì¸ ì»¨í…ì¸  */}
          <Grid
            ref={gridContainerRef}
            w="100%"
            maxW="100vw"
            boxSizing="border-box"
            templateColumns={
              lockedCalendarWidth
                ? { base: '1fr', lg: `${lockedCalendarWidth}px 400px` }
                : { base: '1fr', lg: 'minmax(0, 1fr) 400px' }
            }
            columnGap={{ base: 0, lg: 1 }}
            rowGap={{ base: 4, lg: 0 }}
            alignItems="stretch"
          >
          {/* ì •ì§€ëœ íšŒì› ì•ˆë‚´ */}
          {user && (user as any).status === 'SUSPENDED' && (
            <Box
              w="100%"
              bg="red.50"
              border="1px solid"
              borderColor="red.200"
              borderRadius="md"
              p={4}
              mx={4}
              mt={2}
            >
              <VStack spacing={3} align="stretch">
                <HStack spacing={2} align="center">
                  <Box as="span" fontSize="lg">âš ï¸</Box>
                  <Text fontSize="lg" fontWeight="bold" color="red.800">
                    ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤
                  </Text>
                </HStack>
                <Text fontSize="sm" color="red.700">
                  íˆ¬í‘œ ì°¸ì—¬ ë¶€ì¡±ìœ¼ë¡œ ì¸í•´ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. 
                  ì •ì§€ í•´ì œë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìš”ì²­í•´ì£¼ì„¸ìš”.
                </Text>
                <Button
                  colorScheme="red"
                  variant="outline"
                  size="sm"
                  onClick={() => setShowSuspensionRequestModal(true)}
                  alignSelf="flex-start"
                >
                  ì •ì§€ í•´ì œ ìš”ì²­í•˜ê¸°
                </Button>
              </VStack>
            </Box>
          )}

          {/* ì™¼ìª½: ë‹¬ë ¥ */}
          <Box
            p={{ base: 2, md: 4 }}
            pl={{ base: 'calc(0.5rem + 4mm)', md: 'calc(1rem + 4mm)' }}
            minW="0"
            w="100%"
            display="flex"
            flexDirection="column"
            overflow="visible"
          >
            {appData.isLoading ? (
              <CalendarSkeleton />
            ) : appData.error ? (
              <VStack spacing={4} align="center" justify="center" h="100%" minH="300px">
                <Icon as={WarningIcon} w={12} h={12} color="red.500" />
                <Text color="red.600" fontSize="lg" fontWeight="medium" textAlign="center">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</Text>
                <Text color="gray.600" textAlign="center" px={4}>{appData.error}</Text>
                <Button colorScheme="blue" onClick={loadAllData}>
                  ë‹¤ì‹œ ì‹œë„
                </Button>
              </VStack>
            ) : (
              <Box w="100%" flex="1" minW="0" display="flex" flexDirection="column">
              <NewCalendarV2
                gameDataForCalendar={gameDataForCalendar}
                allDates={allDates}
                onGameClick={handleShowGameModal}
                voteResults={voteResults}
                nextWeekVoteData={nextWeekVoteData}
                allMembers={allMembers}
                unifiedVoteData={unifiedVoteData}
              />
              </Box>
            )}
          </Box>

          {/* ì˜¤ë¥¸ìª½: ì¼ì • ì •ë³´ */}
          <Box
            w={{ base: '100%', lg: '400px' }}
            p={{ base: 2, md: 4 }}
            pr={{ base: 2, md: 4, lg: 1 }}
            overflowX="hidden"
            boxSizing="border-box"
            justifySelf={{ base: 'stretch', lg: 'end' }}
          >
            <VStack spacing={{ base: 1, md: 1.5 }} align="stretch">
              {/* ì´ë²ˆì£¼ ì¼ì • */}
              {renderThisWeekSchedule()}

              {/* ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ - ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œ */}
                <Box
                  bg="white"
                px={{ base: 3, md: 4 }}
                pt={{ base: 0.5, md: 1 }}
                pb={{ base: 3, md: 4 }}
                  borderRadius="lg"
                  boxShadow="sm"
                  border="1px solid"
                  borderColor="gray.200"
                >
                <Flex justify="space-between" align="center" mb={0} mt={0}>
                  <Flex align="center" gap={{ base: 0.6, md: 1 }}>
                      <Box as="span" fontSize={{ base: "md", md: "lg" }}>ğŸ—³ï¸</Box>
                      <Text fontSize={{ base: "md", md: "lg" }} fontWeight="bold">ë‹¤ìŒì£¼ ì¼ì •íˆ¬í‘œ</Text>
                      {/* ìƒíƒœ ë±ƒì§€ - ì œëª© ë°”ë¡œ ì˜†ì— ë°°ì¹˜ */}
                      {unifiedVoteData?.activeSession && (
                      <Badge
                        colorScheme={isVoteClosed ? "red" : "purple"}
                        variant="solid"
                        fontSize={{ base: "2xs", md: "xs" }}
                        px={{ base: 1, md: 1.5 }}
                        py={0.5}
                        borderRadius="full"
                        minW={{ base: "40px", md: "50px" }}
                        textAlign="center"
                        bg={isVoteClosed ? "red.500" : "purple.500"}
                        color="white"
                      >
                        {isVoteClosed ? "íˆ¬í‘œì¢…ë£Œ" : "íˆ¬í‘œ ì¤‘"}
                      </Badge>
                      )}
                    </Flex>
                  {/* íˆ¬í‘œì°¸ì—¬ìœ¨ - ì˜¤ë¥¸ìª½ ëì— ë°°ì¹˜ */}
                  <Tooltip 
                    label={(() => {
                      const participationInfo = voteParticipationInfo;
                      if (!participationInfo) {
                        return 'íˆ¬í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                      }
                      const { votedMembers, nonVotedMembers } = participationInfo;
                      const segments = [];
                      if (votedMembers.length > 0) {
                        segments.push(`ì°¸ì—¬: ${votedMembers.join(', ')}`);
                      }
                      if (nonVotedMembers.length > 0) {
                        segments.push(`ë¯¸ì°¸ì—¬: ${nonVotedMembers.join(', ')}`);
                      }
                      return segments.join('\n') || 'íˆ¬í‘œ ë°ì´í„° ì—†ìŒ';
                    })()}
                    placement="bottom"
                    hasArrow
                    bg="gray.800"
                    color="white"
                    fontSize="sm"
                    whiteSpace="pre-line"
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} color="gray.600" fontWeight="medium" cursor="default">
                      íˆ¬í‘œì°¸ì—¬ìœ¨: {(() => {
                        const participationInfo = voteParticipationInfo;
                        if (!participationInfo) return '0%';
                        return `${participationInfo.participationRate}%`;
                      })()}
                    </Text>
                  </Tooltip>
                </Flex>

          <VStack spacing={{ base: 0, md: 0 }} align="stretch" mb={{ base: 1, md: 1 }}>
                  {(() => {
                    // ë¡œë”© ìƒíƒœì¼ ë•Œ ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ
                    if (appData.isLoading) {
                      return (
                      <VStack spacing={0} align="stretch">
                          {Array.from({ length: 5 }).map((_, i) => (
                          <Box key={i} p={0} py={0} borderWidth={1} borderRadius="lg" lineHeight={1}>
                              <Flex justify="space-between" align="center">
                                <Skeleton height="16px" width="80px" />
                                <Skeleton height="20px" width="40px" />
                              </Flex>
                            </Box>
                          ))}
                        </VStack>
                      );
                    }
                    
                    // í†µí•© API ë°ì´í„°ì—ì„œ í™œì„± ì„¸ì…˜ì˜ íˆ¬í‘œ í˜„í™©ì„ ê°€ì ¸ì˜´
                    if (!unifiedVoteData?.activeSession) {
                    return (
                      <>
                        {getScheduleData.nextWeekVoteData.map((vote, index) => {
                        // ë‚ ì§œì—ì„œ ìš”ì¼ ì¶”ì¶œí•˜ì—¬ dayKeyë¡œ ë³€í™˜
                        const dayMatch = vote.date.match(/\((.+)\)/);
                        const dayName = dayMatch ? dayMatch[1] : '';
                        const dayMapping: Record<string, string> = { 'ì›”': 'MON', 'í™”': 'TUE', 'ìˆ˜': 'WED', 'ëª©': 'THU', 'ê¸ˆ': 'FRI' };
                        const dayKey = dayMapping[dayName] || '';
                        
                        // activeSessionì˜ resultsì—ì„œ íˆ¬í‘œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                        let voteCount = 0;
                        let maxVoteCount = 0;
        if (effectiveVoteResults && dayKey) {
          voteCount = effectiveVoteResults[dayKey]?.count || 0;
                          // maxVoteCountë„ activeSession.resultsì—ì„œ ê³„ì‚°
          const results = effectiveVoteResults;
                          maxVoteCount = Math.max(
                            results.MON?.count || 0,
                            results.TUE?.count || 0,
                            results.WED?.count || 0,
                            results.THU?.count || 0,
                            results.FRI?.count || 0
                          );
                        } else if (voteResults?.voteResults && voteResults.voteResults[vote.date]) {
                          voteCount = voteResults.voteResults[vote.date];
                          maxVoteCount = voteResults?.voteResults ? Math.max(...Object.values(voteResults.voteResults).map((v: any) => typeof v === 'number' ? v : 0), 0) : 0;
                        }
                        const isMaxVote = voteCount === maxVoteCount && voteCount > 0;
                        const isHoliday = isHolidayDate(vote.date);
                        
                        return (
                            <Box
                            key={index} 
                              position="relative"
                            borderRadius="lg"
                              border={selectedDays.includes(vote.date) ? '1px solid' : 'none'}
                              borderColor={selectedDays.includes(vote.date) ? 'purple.400' : 'transparent'}
                              bg={selectedDays.includes(vote.date) ? 'purple.50' : isHoliday ? 'red.50' : 'transparent'}
                              px={{ base: 4, md: 6 }}
                              py={selectedDays.includes(vote.date) ? '-8px' : 0}
                              minH="auto"
                              h="auto"
                            onClick={() => {
                                if (isVoteClosed) return;
                                if (isHoliday) {
                                  toast({ title: 'ì„ íƒ ë¶ˆê°€', description: 'ê³µíœ´ì¼ì€ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', status: 'warning', duration: 2000, isClosable: true });
                                  return;
                                }
                                const dayMatch = vote.date.match(/\((.)\)/);
                                if (dayMatch) {
                                  const day = dayMatch[1];
                                  const isWeekend = day === 'í† ' || day === 'ì¼';
                                  if (isWeekend) {
                                    toast({ title: 'ì„ íƒ ë¶ˆê°€', description: 'ì£¼ë§ì€ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', status: 'warning', duration: 2000, isClosable: true });
                                    return;
                                  }
                                }
                              if (selectedDays.includes(vote.date)) {
                                setSelectedDays(selectedDays.filter(day => day !== vote.date));
                              } else {
                                const filteredDays = selectedDays.filter(day => day !== 'ë¶ˆì°¸');
                                setSelectedDays([...filteredDays, vote.date]);
                              }
                            }}
                              cursor={isHoliday ? 'not-allowed' : 'pointer'}
                              opacity={isHoliday ? 0.7 : 1}
                            _hover={{
                                bg: isHoliday ? 'red.50' : (selectedDays.includes(vote.date) ? 'purple.100' : 'gray.50'),
                            }}
                            transition="all 0.2s ease-in-out"
                            >
                              <Flex 
                                justify="space-between"
                                align="center"
                                py={{ base: '-1px', md: '-1px' }}
                                px={0}
                                lineHeight={1}
                          >
                                <Flex align="center" gap={{ base: 1, md: 1.5 }} flex="1" minW="0">
                                  <Text fontSize={{ base: 'xs', md: 'sm' }} fontWeight={isMaxVote ? 'bold' : (isHoliday ? 'semibold' : 'normal')} noOfLines={1} lineHeight={1} color={isHoliday ? 'red.500' : 'gray.700'} ml="-11px">
                                {vote.date}
                              </Text>
                              {isMaxVote && (
                                <Badge 
                                  colorScheme="purple" 
                                  variant="outline" 
                                    fontSize={{ base: '2xs', md: 'xs' }}
                                  px={{ base: 1, md: 1.5 }} 
                                  py={{ base: 0.5, md: 0.5 }}
                                  borderRadius="full"
                                    minW={{ base: '28px', md: '32px' }}
                                  textAlign="center"
                                  borderColor="purple.400"
                                  color="purple.600"
                                  flexShrink={0}
                                    lineHeight={1.1}
                                >
                                  ìµœë‹¤
                                </Badge>
                              )}
                            </Flex>
                            <Tooltip
                              label={(() => {
                                if (voteCount === 0) return '-';
                                if (unifiedVoteData?.activeSession?.results) {
                                  const match = vote.date.match(/(\d+)ì›” (\d+)ì¼\((.+)\)/);
                                  if (match) {
                                      const dayOfWeek = match[3];
                                      const dayKeys: Record<string, string> = { 'ì›”': 'MON', 'í™”': 'TUE', 'ìˆ˜': 'WED', 'ëª©': 'THU', 'ê¸ˆ': 'FRI' };
                                    const dayKey = dayKeys[dayOfWeek];
                                    if (dayKey && unifiedVoteData.activeSession.results[dayKey]?.participants) {
                                      const dayResult = unifiedVoteData.activeSession.results[dayKey];
                                      const memberNames = dayResult.participants.map((p: any) => p.userName).filter(Boolean);
                                      return memberNames.length > 0 ? memberNames.join(', ') : '-';
                                    }
                                  }
                                }
                                const memberNames = getVoteMemberNames(vote.date, voteResults, user);
                                return memberNames.length > 0 ? memberNames.join(', ') : '-';
                              })()}
                              placement="top"
                              hasArrow
                              bg="purple.600"
                              color="white"
                              fontSize="sm"
                              borderRadius="md"
                              px={3}
                              py={2}
                              maxW="200px"
                              whiteSpace="normal"
                            >
                              <Badge
                                  colorScheme={isMaxVote ? 'purple' : (voteCount === 0 ? 'gray' : 'blackAlpha')}
                                variant="solid"
                                borderRadius="full"
                                px={3}
                                py={1}
                                fontSize="xs"
                                  bg={isMaxVote ? 'purple.600' : (voteCount === 0 ? 'gray.200' : 'black')}
                                  color={isMaxVote ? 'white' : (voteCount === 0 ? 'gray.600' : 'white')}
                                w="45px"
                                h="22px"
                                display="flex"
                                alignItems="center"
                                justifyContent="center"
                                  fontWeight={isMaxVote ? 'bold' : 'normal'}
                                  lineHeight={1.1}
                                  mr="-11px"
                              >
                                {voteCount}ëª…
                              </Badge>
                            </Tooltip>
                          </Flex>
                            </Box>
                        );
                        })}
                      </>
                    );
                    }
                    
                    const activeSession = unifiedVoteData.activeSession;
                    const results = activeSession.results || {};
                    const now = new Date();
                  const currentDay = now.getDay();
                    let daysUntilMonday;
                  if (currentDay === 0) {
                    daysUntilMonday = -6;
                  } else if (currentDay === 1) {
                    daysUntilMonday = 0;
                    } else {
                    daysUntilMonday = 1 - currentDay;
                    }
                    const thisWeekMonday = new Date(now);
                    thisWeekMonday.setDate(now.getDate() + daysUntilMonday);
                    const nextWeekMonday = new Date(thisWeekMonday);
                    nextWeekMonday.setDate(thisWeekMonday.getDate() + 7);
                  const dayMapping: Record<string, number> = { MON: 0, TUE: 1, WED: 2, THU: 3, FRI: 4 };
                    
                  return (
                    <>
                      {Object.entries(dayMapping).map(([dayKey, dayIndex]) => {
                      const currentDate = new Date(nextWeekMonday.getTime() + dayIndex * 24 * 60 * 60 * 1000);
                      const month = currentDate.getMonth() + 1;
                      const day = currentDate.getDate();
                      const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
                      const dayName = dayNames[dayIndex];
                      const dateString = `${month}ì›” ${day}ì¼(${dayName})`;
                      const voteCount = results[dayKey]?.count || 0;
                      const maxVoteCount = Math.max(...Object.values(results).map((r: any) => r.count || 0), 0);
                      const isMaxVote = voteCount === maxVoteCount && voteCount > 0;
                      const isHoliday = isHolidayDate(dateString);
                      const holidayName = getHolidayName(dateString);
                      const disabledInfo = isDayDisabled(dayKey);
                      const isDisabled = isHoliday || disabledInfo.disabled;
                      const disabledReason = isHoliday ? holidayName : (disabledInfo.reason || null);
                    
                      return (
                          <Box
                          key={dayKey} 
                            position="relative"
                          borderRadius="lg"
                            border={selectedDays.includes(dateString) ? '1px solid' : 'none'}
                            borderColor={selectedDays.includes(dateString) ? 'purple.400' : 'transparent'}
                            bg={selectedDays.includes(dateString) ? 'purple.50' : isDisabled ? 'red.50' : 'transparent'}
                            px={{ base: 4, md: 6 }}
                            py={selectedDays.includes(dateString) ? '-8px' : 0}
                            minH="auto"
                            h="auto"
                            onClick={() => {
                              if (isVoteClosed) return;
                              if (isDisabled) {
                                const reasonText = disabledReason || 'ì„ íƒí•  ìˆ˜ ì—†ëŠ” ë‚ ì§œì…ë‹ˆë‹¤.';
                                toast({ title: 'ì„ íƒ ë¶ˆê°€', description: reasonText, status: 'warning', duration: 2000, isClosable: true });
                                return;
                              }
                              const dateObj = new Date(dateString);
                              const dayOfWeek = dateObj.getDay();
                              const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                              if (isWeekend) {
                                toast({ title: 'ì„ íƒ ë¶ˆê°€', description: 'ì£¼ë§ì€ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', status: 'warning', duration: 2000, isClosable: true });
                                return;
                              }
                              if (selectedDays.includes(dateString)) {
                                setSelectedDays(selectedDays.filter(day => day !== dateString));
                              } else {
                                const filteredDays = selectedDays.filter(day => day !== 'ë¶ˆì°¸');
                                setSelectedDays([...filteredDays, dateString]);
                              }
                            }}
                            cursor={isDisabled ? 'not-allowed' : 'pointer'}
                            opacity={isDisabled ? 0.7 : 1}
                          _hover={{
                              bg: isDisabled ? 'red.50' : (selectedDays.includes(dateString) ? 'purple.100' : 'gray.50'),
                          }}
                          transition="all 0.2s ease-in-out"
                          >
                            <Flex 
                              justify="space-between"
                              align="center"
                              py={{ base: '-1px', md: '-1px' }}
                              px={0}
                              lineHeight={1}
                        >
                              <Flex align="center" gap={{ base: 1, md: 1.5 }} flex="1" minW="0">
                                <Text fontSize={{ base: 'xs', md: 'sm' }} fontWeight={isMaxVote ? 'bold' : (isDisabled ? 'semibold' : 'normal')} noOfLines={1} lineHeight={1} color={isDisabled ? 'red.500' : 'gray.700'} ml="-11px">
                              {dateString}
                            </Text>
                            {isMaxVote && !isDisabled && (
                              <Badge 
                                colorScheme="purple" 
                                variant="outline" 
                                  fontSize={{ base: '2xs', md: 'xs' }}
                                px={{ base: 1, md: 1.5 }} 
                                py={{ base: 0.5, md: 0.5 }}
                                borderRadius="full"
                                  minW={{ base: '28px', md: '32px' }}
                                textAlign="center"
                                borderColor="purple.400"
                                color="purple.600"
                                flexShrink={0}
                                  lineHeight={1.1}
                              >
                                ìµœë‹¤
                              </Badge>
                            )}
                            {isDisabled && disabledReason && (
                              <Badge 
                                colorScheme="red" 
                                variant="solid" 
                                  fontSize={{ base: '2xs', md: 'xs' }}
                                px={{ base: 1, md: 1.5 }} 
                                py={{ base: 0.5, md: 0.5 }}
                                borderRadius="full"
                                  minW={{ base: '28px', md: '32px' }}
                                textAlign="center"
                                bg="red.500"
                                color="white"
                                flexShrink={0}
                                  lineHeight={1.1}
                              >
                                {disabledReason}
                              </Badge>
                            )}
                          </Flex>
                          <Tooltip
                            label={(() => {
                              if (voteCount === 0) return '-';
                                if (results[dayKey]?.participants) {
                                  const memberNames = results[dayKey].participants.map((p: any) => p.userName).filter(Boolean);
                                return memberNames.length > 0 ? memberNames.join(', ') : '-';
                              }
                                return '-';
                            })()}
                            placement="top"
                            hasArrow
                            bg="purple.600"
                            color="white"
                            fontSize="sm"
                            borderRadius="md"
                            px={3}
                            py={2}
                            maxW="200px"
                            whiteSpace="normal"
                          >
                            <Badge
                                colorScheme={isMaxVote ? 'purple' : (voteCount === 0 ? 'gray' : 'blackAlpha')}
                              variant="solid"
                              borderRadius="full"
                              px={3}
                              py={1}
                              fontSize="xs"
                                bg={isMaxVote ? 'purple.600' : (voteCount === 0 ? 'gray.200' : 'black')}
                                color={isMaxVote ? 'white' : (voteCount === 0 ? 'gray.600' : 'white')}
                              w="45px"
                              h="22px"
                              display="flex"
                              alignItems="center"
                              justifyContent="center"
                                fontWeight={isMaxVote ? 'bold' : 'normal'}
                                lineHeight={1.1}
                                mr="-11px"
                            >
                              {isDisabled ? '-' : `${voteCount}ëª…`}
                            </Badge>
                          </Tooltip>
                        </Flex>
                          </Box>
                      );
                      })}
                    </>
                  );
                  })()}
                  
                  {/* ë¶ˆì°¸ ì˜µì…˜ */}
                <Box
                  position="relative"
                    borderRadius="lg"
                    border={selectedDays.includes('ë¶ˆì°¸') ? "1px solid" : "none"}
                    borderColor={selectedDays.includes('ë¶ˆì°¸') ? "purple.400" : "transparent"}
                    bg={selectedDays.includes('ë¶ˆì°¸') ? "purple.50" : "transparent"}
                  px={{ base: 4, md: 6 }}
                  py={selectedDays.includes('ë¶ˆì°¸') ? '-8px' : 0}
                  minH="auto"
                  h="auto"
                    onClick={() => {
                      // íˆ¬í‘œ ë§ˆê°ëœ ê²½ìš° ì„ íƒ ë¶ˆê°€
                      if (isVoteClosed) return;
                      
                      // ë¶ˆì°¸ì€ ë‹¨ë… ì„ íƒ (í‰ì¼ ì„ íƒ ëª¨ë‘ í•´ì œ)
                      if (selectedDays.includes('ë¶ˆì°¸')) {
                        setSelectedDays([]);
                      } else {
                        setSelectedDays(['ë¶ˆì°¸']);
                      }
                    }}
                  cursor="pointer"
                    _hover={{
                      bg: selectedDays.includes('ë¶ˆì°¸') ? "purple.100" : "gray.50",
                    }}
                    transition="all 0.2s ease-in-out"
                >
                  <Flex 
                    justify="space-between" 
                    align="center"
                    py={{ base: '-1px', md: '-1px' }}
                    px={0}
                    lineHeight={1}
                  >
                    <Flex align="center" gap={{ base: 0.5, md: 0.8 }} flex="1" minW="0">
                      <Text 
                        fontSize={{ base: "xs", md: "sm" }} 
                        fontWeight={selectedDays.includes('ë¶ˆì°¸') ? "bold" : "normal"}
                        color="red.500"
                        lineHeight={1}
                        ml="-11px"
                      >
                        ë¶ˆì°¸
                      </Text>
                    </Flex>
                    <Tooltip
                      label={(() => {
                        const absentCount = (() => {
                          const votes = (voteResults?.voteSession?.votes?.length ? voteResults?.voteSession?.votes : localVotesRef.current) || [];
                          const byVotes = votes.filter((v: any) => {
                            if (Array.isArray(v.selectedDays)) return v.selectedDays.includes('ë¶ˆì°¸');
                            if (typeof v.selectedDays === 'string') {
                              try { return JSON.parse(v.selectedDays).includes('ë¶ˆì°¸'); } catch { return v.selectedDays.includes('ë¶ˆì°¸'); }
                            }
                            return false;
                          }).length;
                          const byResults = voteResults?.voteResults?.['ë¶ˆì°¸'] || 0;
                          return Math.max(byVotes, byResults);
                        })();
                        if (absentCount === 0) return '-';
                        
                        // ë¶ˆì°¸í•œ ì¸ì›ëª… ê°€ì ¸ì˜¤ê¸°
                        const absentMembers = getAbsentMemberNames(voteResults, null);
                        return absentMembers.length > 0 ? absentMembers.join(', ') : '-';
                      })()}
                      placement="top"
                      hasArrow
                      bg="red.600"
                      color="white"
                      fontSize="sm"
                      borderRadius="md"
                      px={3}
                      py={2}
                      maxW="200px"
                      whiteSpace="normal"
                    >
                    <Badge 
                        bg="red.500"
                        color="white"
                      variant="solid" 
                      borderRadius="full" 
                      px={{ base: 2, md: 3 }} 
                      py={{ base: 0.5, md: 1 }} 
                      fontSize={{ base: "2xs", md: "xs" }}
                      w={{ base: "40px", md: "45px" }}
                      h={{ base: "20px", md: "22px" }}
                      display="flex"
                      alignItems="center"
                      justifyContent="center"
                      flexShrink={0}
                    lineHeight={1.1}
                    mr="-11px"
                    >
                      {(() => {
                        const votes = (voteResults?.voteSession?.votes?.length ? voteResults?.voteSession?.votes : localVotesRef.current) || [];
                        const byVotes = votes.filter((v: any) => {
                          if (Array.isArray(v.selectedDays)) return v.selectedDays.includes('ë¶ˆì°¸');
                          if (typeof v.selectedDays === 'string') {
                            try { return JSON.parse(v.selectedDays).includes('ë¶ˆì°¸'); } catch { return v.selectedDays.includes('ë¶ˆì°¸'); }
                          }
                          return false;
                        }).length;
                        const byResults = voteResults?.voteResults?.['ë¶ˆì°¸'] || 0;
                        return Math.max(byVotes, byResults);
                      })()}ëª…
                    </Badge>
                    </Tooltip>
                  </Flex>
                </Box>
                </VStack>

                {/* ë²„íŠ¼ë“¤ */}
                <VStack spacing={{ base: 2, md: 3 }} align="stretch">
                  {/* íˆ¬í‘œë§ˆê°, íˆ¬í‘œí˜„í™©, íˆ¬í‘œí•˜ê¸°ë¥¼ í•œ ì¤„ì— ë°°ì¹˜ */}
                  <Flex gap={{ base: 1, md: 2 }} align="center" direction={{ base: 'column', sm: 'row' }}>
                    {/* íˆ¬í‘œë§ˆê° ì‹œê°„ - ë§ˆê° ì‹œ ìˆ¨ê¹€ */}
                  {!isVoteClosed && (unifiedVoteData?.activeSession || voteResults?.voteSession) && (
                      <Text
                        fontSize={{ base: "2xs", md: "xs" }}
                        color={getVoteDeadlineColor(voteDeadlineInfo.remainingHours)}
                        fontWeight="medium"
                        flex="1"
                        textAlign={{ base: "center", sm: "left" }}
                        mb={{ base: 1, sm: 0 }}
                      >
                        íˆ¬í‘œë§ˆê°: {voteDeadlineInfo.text}
                      </Text>
                    )}
                    
                    <Flex gap={{ base: 1, md: 2 }} w={{ base: "100%", sm: "auto" }}>
                      <Button
                        size={{ base: "xs", md: "sm" }}
                        colorScheme="purple"
                        onClick={handleShowVoteStatus}
                        fontSize={{ base: "2xs", md: "xs" }}
                        px={{ base: 1, md: 2 }}
                        h={{ base: "20px", md: "22px" }}
                        flex="1"
                        _hover={{
                          transform: "translateY(-1px)",
                          boxShadow: "md"
                        }}
                        transition="all 0.2s ease-in-out"
                      >
                        íˆ¬í‘œí˜„í™©
                      </Button>
                      
                      {(!isVoteClosed && hasUserVoted()) ? (
                        <Button
                          size={{ base: "xs", md: "sm" }}
                          bg="#FF6B35"
                          color="white"
                          onClick={handleRevote}
                          fontSize={{ base: "2xs", md: "xs" }}
                          px={{ base: 1, md: 2 }}
                          h={{ base: "20px", md: "22px" }}
                          isDisabled={isVoteClosed}
                          flex="1"
                          _hover={{
                            bg: "#E55A2B",
                            transform: "translateY(-1px)",
                            boxShadow: "md"
                          }}
                          transition="all 0.2s ease-in-out"
                        >
                          {getVoteButtonText()}
                        </Button>
                      ) : (
                        <Button
                          size={{ base: "xs", md: "sm" }}
                          bg={isVoteClosed || !user ? "gray.400" : "purple.600"}
                          color="white"
                          onClick={handleVoteButtonClick}
                          fontSize={{ base: "2xs", md: "xs" }}
                          px={{ base: 1, md: 2 }}
                          h={{ base: "20px", md: "22px" }}
                          isDisabled={isVoteClosed || !user}
                          flex="1"
                          _hover={{
                            bg: isVoteClosed || !user ? "gray.400" : (selectedDays.length > 0 ? "purple.700" : "purple.600"),
                            transform: isVoteClosed || !user ? "none" : (selectedDays.length > 0 ? "translateY(-1px)" : "none"),
                            boxShadow: isVoteClosed || !user ? "none" : (selectedDays.length > 0 ? "md" : "none")
                          }}
                          transition="all 0.2s ease-in-out"
                        >
                          {getVoteButtonText()}
                        </Button>
                      )}
                    </Flex>
                  </Flex>
                </VStack>
              </Box>
            </VStack>
          </Box>
        </Grid>
      </Flex>
      </Box>

      {/* íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ */}
      <Modal 
        isOpen={showVoteStatus} 
        onClose={() => setShowVoteStatus(false)} 
        size={{ base: "full", md: "lg" }}
        aria-labelledby="vote-status-modal-title"
        aria-describedby="vote-status-modal-description"
      >
        <ModalOverlay />
        <ModalContent mx={{ base: 2, md: "auto" }} my={{ base: 2, md: "auto" }}>
          <ModalHeader fontSize={{ base: "lg", md: "xl" }} id="vote-status-modal-title">
            ğŸ“Š íˆ¬í‘œ í˜„í™© [
            <Text as="span" color="purple.600" fontWeight="bold">
              {getScheduleData.nextWeekVoteData[0]?.date} ~ {getScheduleData.nextWeekVoteData[4]?.date}
            </Text>
            ]
          </ModalHeader>
          <ModalCloseButton aria-label="íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ ë‹«ê¸°" />
          <ModalBody id="vote-status-modal-description">
            {voteResults ? (
              <VStack spacing={{ base: 3, md: 4 }} align="stretch">
                {/* ìš”ì•½ ì •ë³´ */}
                <Flex justify="space-between" align="center" p={{ base: 2, md: 3 }} bg="gray.50" borderRadius="md" direction={{ base: 'column', sm: 'row' }} gap={{ base: 2, sm: 0 }}>
                  <Tooltip 
                    label={(() => {
                      if (!voteResults || !voteResults.voteSession || !voteResults.voteSession.votes) return 'íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                      
                      // íˆ¬í‘œì— ì°¸ì—¬í•œ ì¸ì›ëª… ìˆ˜ì§‘ (ì‹¤ì œ íšŒì› ì •ë³´ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
                      const participants = new Set<string>();
                      voteResults.voteSession.votes.forEach(vote => {
                        const member = allMembers.find(m => m.id === vote.userId);
                        console.log('ğŸ” íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ íˆ¬í‘œì ë¶„ì„:', {
                          userId: vote.userId,
                          member: member ? { id: member.id, name: member.name } : null
                        });
                        if (member) {
                          participants.add(member.name);
                        } else {
                          console.warn('âš ï¸ íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íšŒì›ì˜ íˆ¬í‘œ:', vote.userId);
                        }
                      });
                      
                      const participantList = Array.from(participants).sort((a, b) => a.localeCompare(b, 'ko'));
                      console.log('ğŸ“Š íˆ¬í‘œ í˜„í™© ëª¨ë‹¬ ìµœì¢… ì°¸ì—¬ì:', participantList);
                      return `íˆ¬í‘œ ì°¸ì—¬ ì¸ì›: ${participantList.join(', ')}`;
                    })()}
                    placement="top"
                    hasArrow
                    bg="purple.600"
                    color="white"
                    fontSize="sm"
                    borderRadius="md"
                    px={3}
                    py={2}
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} fontWeight="medium"  textAlign={{ base: "center", sm: "left" }}>
                      íˆ¬í‘œ ì°¸ì—¬ì: 
                      <Badge bg="purple.600" color="white" fontSize={{ base: "xs", md: "sm" }} px={1} py={0.5} borderRadius="md" ml={1}>
                        {(() => {
                          // í†µí•© APIì—ì„œ íˆ¬í‘œ ì°¸ì—¬ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                          if (unifiedVoteData?.activeSession?.totalParticipants) {
                            return unifiedVoteData.activeSession.totalParticipants;
                          }
                          return 0;
                        })()}ëª…
                      </Badge>
                    </Text>
                  </Tooltip>
                  
                  <Tooltip 
                    label={(() => {
                      if (!voteResults || !voteResults.voteSession || !voteResults.voteSession.votes) return 'íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                      
                      // ì‹¤ì œ íšŒì› ìˆ˜
                      const totalMembers = allMembers.length;
                      
                      // íˆ¬í‘œì— ì°¸ì—¬í•œ ê³ ìœ  ì¸ì› ìˆ˜ (ì‹¤ì œ íšŒì›ë§Œ)
                      const participants = new Set<number>();
                      voteResults.voteSession.votes.forEach(vote => {
                        const member = allMembers.find(m => m.id === vote.userId);
                        if (member) {
                          participants.add(vote.userId);
                        }
                      });
                      
                      // íˆ¬í‘œì— ì°¸ì—¬í•˜ì§€ ì•Šì€ ì¸ì› ìˆ˜
                      const absentCount = totalMembers - participants.size;
                      
                      if (absentCount === 0) return 'ëª¨ë“  íšŒì›ì´ íˆ¬í‘œì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.';
                      
                      // íˆ¬í‘œì— ì°¸ì—¬í•˜ì§€ ì•Šì€ ì¸ì›ëª… ìˆ˜ì§‘
                      const absentMemberIds = allMembers.filter(member => !participants.has(member.id));
                      const absentMemberNames = absentMemberIds.map(member => member.name);
                      
                      return `íˆ¬í‘œ ë¯¸ì°¸ì—¬ ì¸ì›: ${absentMemberNames.join(', ')}`;
                    })()}
                    placement="top"
                    hasArrow
                    bg="red.600"
                    color="white"
                    fontSize="sm"
                    borderRadius="md"
                    px={3}
                    py={2}
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} fontWeight="medium"  textAlign={{ base: "center", sm: "left" }}>
                      ë¶ˆì°¸ì: 
                      <Badge bg="red.600" color="white" fontSize={{ base: "xs", md: "sm" }} px={1} py={0.5} borderRadius="md" ml={1}>
                        {(() => {
                          // í†µí•© APIì—ì„œ ë¶ˆì°¸ì ìˆ˜ ê³„ì‚°
                          console.log('ğŸ” ë¶ˆì°¸ì ìˆ˜ ê³„ì‚°:', {
                            allMembers: unifiedVoteData?.allMembers?.length || 0,
                            totalParticipants: unifiedVoteData?.activeSession?.totalParticipants || 0,
                            calculated: unifiedVoteData?.allMembers && unifiedVoteData?.activeSession?.totalParticipants 
                              ? unifiedVoteData.allMembers.length - unifiedVoteData.activeSession.totalParticipants 
                              : 0
                          });
                          
                          if (unifiedVoteData?.allMembers && unifiedVoteData?.activeSession?.totalParticipants) {
                            return unifiedVoteData.allMembers.length - unifiedVoteData.activeSession.totalParticipants;
                          }
                          return 0;
                        })()}ëª…
                      </Badge>
                    </Text>
                  </Tooltip>
                </Flex>

                {/* íˆ¬í‘œ ëª©ë¡ ë° ë¶ˆì°¸ */}
                <VStack spacing="5.7px" align="stretch">
                  {getScheduleData.nextWeekVoteData.map((vote, index) => {
                    // í†µí•© APIì—ì„œ íˆ¬í‘œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    const voteCount = (() => {
                      if (!unifiedVoteData?.activeSession?.results) return 0;
                      
                      // ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ìš”ì¼ ì¶”ì¶œ
                      const match = vote.date.match(/(\d+)ì›” (\d+)ì¼\((.+)\)/);
                      if (match) {
                        const dayOfWeek = match[3]; // ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ
                        const dayKeys: { [key: string]: string } = {
                          'ì›”': 'MON',
                          'í™”': 'TUE', 
                          'ìˆ˜': 'WED',
                          'ëª©': 'THU',
                          'ê¸ˆ': 'FRI'
                        };
                        
                        const dayKey = dayKeys[dayOfWeek];
                        if (dayKey && unifiedVoteData.activeSession.results[dayKey]) {
                          return unifiedVoteData.activeSession.results[dayKey].count || 0;
                        }
                      }
                      return 0;
                    })();
                    
                    // ê¸°ì¡´ getVoteMemberNames í•¨ìˆ˜ ì‚¬ìš©
                    console.log('ğŸ” ëª¨ë‹¬ ë””ë²„ê¹…:', {
                      voteDate: vote.date,
                      voteCount,
                      unifiedVoteData: unifiedVoteData ? 'ìˆìŒ' : 'ì—†ìŒ',
                      activeSession: unifiedVoteData?.activeSession ? 'ìˆìŒ' : 'ì—†ìŒ',
                      participants: unifiedVoteData?.activeSession?.participants?.length || 0
                    });
                    
                    // í†µí•© APIì—ì„œ ì§ì ‘ íˆ¬í‘œì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    const memberNames = (() => {
                      if (!unifiedVoteData?.activeSession?.results) return [];
                      
                      // ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ìš”ì¼ ì¶”ì¶œ
                      const match = vote.date.match(/(\d+)ì›” (\d+)ì¼\((.+)\)/);
                      if (match) {
                        const dayOfWeek = match[3]; // ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ
                        const dayKeys: { [key: string]: string } = {
                          'ì›”': 'MON',
                          'í™”': 'TUE', 
                          'ìˆ˜': 'WED',
                          'ëª©': 'THU',
                          'ê¸ˆ': 'FRI'
                        };
                        
                        const dayKey = dayKeys[dayOfWeek];
                        if (dayKey && unifiedVoteData.activeSession.results[dayKey]) {
                          const dayResult = unifiedVoteData.activeSession.results[dayKey];
                          if (dayResult.participants) {
                            return dayResult.participants.map((p: any) => p.userName).filter(Boolean);
                          }
                        }
                      }
                      return [];
                    })();
                    
                    const result = memberNames.length > 0 ? memberNames.join(', ') : '-';
                    console.log('ğŸ” ëª¨ë‹¬ ê²°ê³¼:', { memberNames, result });
                    
                    const maxVoteCount = (() => {
                      if (!unifiedVoteData?.activeSession?.results) return 0;
                      const results = unifiedVoteData.activeSession.results;
                      return Math.max(
                        results.MON?.count || 0,
                        results.TUE?.count || 0,
                        results.WED?.count || 0,
                        results.THU?.count || 0,
                        results.FRI?.count || 0
                      );
                    })();
                    const isMaxVote = voteCount === maxVoteCount && voteCount > 0;
                    
                    console.log('ğŸ” íˆ¬í‘œ í˜„í™© í‘œì‹œ:', {
                      date: vote.date,
                      voteCount,
                      memberNames,
                      maxVoteCount,
                      isMaxVote,
                      voteResults: voteResults ? 'ìˆìŒ' : 'ì—†ìŒ'
                    });
                    
                    return (
                      <Flex 
                        key={index} 
                        justify="space-between" 
                        align="center" 
                        px={2}
                        py="0.5px"
                        border={isMaxVote ? "1px solid" : "0 0 1px 0 solid"}
                        borderColor={isMaxVote ? "purple.600" : "gray.200"}
                        bg={isMaxVote ? "purple.50" : "transparent"}
                        borderRadius="md"
                        _hover={{ bg: isMaxVote ? "purple.100" : "gray.50" }}
                      >
                        <Text 
                          fontSize={{ base: "xs", md: "sm" }} 
                          textAlign="center" 
                          w="20%" 
                          fontWeight={isMaxVote ? "bold" : "normal"}
                          color={isHolidayDate(vote.date) ? '#e53e3e' : 'inherit'}
                        >
                          {vote.date}
                        </Text>
                        <Badge 
                          bg={isMaxVote ? "purple.600" : (voteCount === 0 ? "gray.200" : "purple.300")}
                          color={isMaxVote ? "white" : (voteCount === 0 ? "gray.600" : "white")}
                          variant="solid" 
                          borderRadius="full" 
                          px={{ base: 1, md: 2 }} 
                          py={{ base: 0.25, md: 0.5 }} 
                          fontSize={{ base: "2xs", md: "xs" }}
                          w={{ base: "30px", md: "34px" }}
                          h={{ base: "18px", md: "20px" }}
                          display="flex"
                          alignItems="center"
                          justifyContent="center"
                          flexShrink={0}
                          textAlign="center"
                          fontWeight={isMaxVote ? "bold" : "normal"}
                        >
                          {isHolidayDate(vote.date) ? '-' : `${voteCount}ëª…`}
                        </Badge>
                        <Box w="10%" textAlign="center" display="flex" justifyContent="center" alignItems="center">
                          {isMaxVote && (
                            <Badge 
                              bg="transparent"
                              color="purple.600"
                              border="1px solid"
                              borderColor="purple.600"
                              borderRadius="md"
                              fontSize="2xs"
                              px={1}
                              py={0.5}
                              fontWeight="bold"
                            >
                              ìµœë‹¤
                            </Badge>
                          )}
                        </Box>
                        <Text 
                          fontSize={{ base: "xs", md: "sm" }} 
                          color="gray.600" 
                          textAlign="center" 
                          w="55%" 
                          noOfLines={1}
                          fontWeight={isMaxVote ? "bold" : "normal"}
                        >
                          {result}
                        </Text>
                      </Flex>
                    );
                  })}
                  
                {/* ë¶ˆì°¸ í•­ëª© - 0ëª…ì´ì–´ë„ í•­ìƒ í‘œì‹œ */}
                  <Flex 
                    justify="space-between" 
                    align="center" 
                    px={2}
                    py="0.5px"
                    borderBottom="1px solid" 
                    borderColor="gray.200"
                    bg="red.50"
                    borderRadius="md"
                    _hover={{ bg: "red.100" }}
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} textAlign="center" w="20%" fontWeight="normal">ë¶ˆì°¸</Text>
                    <Badge 
                      bg="red.500"
                      color="white"
                      variant="solid" 
                      borderRadius="full" 
                      px={{ base: 1, md: 2 }} 
                      py={{ base: 0.25, md: 0.5 }} 
                      fontSize={{ base: "2xs", md: "xs" }}
                      w={{ base: "30px", md: "34px" }}
                      h={{ base: "18px", md: "20px" }}
                      display="flex"
                      alignItems="center"
                      justifyContent="center"
                      flexShrink={0}
                      textAlign="center"
                      fontWeight={(() => {
                        const absentCount = voteResults.voteResults['ë¶ˆì°¸'] || 0;
                        const maxVoteCount = Math.max(...Object.values(voteResults.voteResults).filter(val => val > 0), 0);
                        return absentCount === maxVoteCount && absentCount > 0 ? "bold" : "normal";
                      })()}
                    >
                      {voteResults.voteResults['ë¶ˆì°¸'] || 0}ëª…
                    </Badge>
                    <Box w="10%" textAlign="center">
                      {/* ìµœë‹¤ ë±ƒì§€ ê³µê°„ */}
                    </Box>
                    <Text fontSize={{ base: "xs", md: "sm" }} color="gray.600" textAlign="center" w="55%">
                      {(() => {
                        const absentCount = voteResults.voteResults['ë¶ˆì°¸'] || 0;
                        if (absentCount === 0) return '-';
                        
                        // ë¶ˆì°¸í•œ ì¸ì›ëª… ê°€ì ¸ì˜¤ê¸°
                        const absentMembers = getAbsentMemberNames(voteResults, null);
                        return absentMembers.length > 0 ? absentMembers.join(', ') : '-';
                      })()}
                    </Text>
                  </Flex>
                </VStack>

                {/* ëŒ“ê¸€ ì„¹ì…˜ */}
                <VStack spacing={{ base: 1, md: 2 }} align="stretch">
                  <Text fontSize={{ base: "xs", md: "sm" }} fontWeight="bold" color="gray.700">
                    ëŒ“ê¸€
                  </Text>
                  
                  {/* ê¸°ì¡´ ëŒ“ê¸€ */}
                  <VStack spacing={1} align="stretch" maxH="120px" overflowY="auto">
                    {comments.map((comment, index) => (
                      <Box key={index} p={{ base: 1, md: 1.5 }} bg="gray.50" borderRadius="md">
                        {editingCommentIndex === index ? (
                          // ìˆ˜ì • ëª¨ë“œ
                          <VStack spacing={2} align="stretch">
                            <Input
                              value={editCommentText}
                              onChange={(e) => setEditCommentText(e.target.value)}
                              size="sm"
                              h="24px"
                            />
                            <Flex gap={2} justify="flex-end">
                              <Button
                                size="xs"
                                colorScheme="blue"
                                onClick={() => handleSaveEditComment(index)}
                                h="20px"
                              >
                                ì €ì¥
                              </Button>
                              <Button
                                size="xs"
                                variant="outline"
                                onClick={() => setEditingCommentIndex(null)}
                                h="20px"
                              >
                                ì·¨ì†Œ
                              </Button>
                            </Flex>
                          </VStack>
                        ) : (
                          // ì¼ë°˜ í‘œì‹œ ëª¨ë“œ
                          <Flex justify="space-between" align="center">
                            <Text fontSize={{ base: "2xs", md: "xs" }} color="gray.600" flex="1">
                              {comment.text}
                            </Text>
                            <Flex align="center" gap={2} flexShrink={0}>
                              <Text fontSize={{ base: "2xs", md: "xs" }} fontWeight="medium" color="gray.700">
                                {comment.user}
                              </Text>
                              <Text fontSize={{ base: "2xs", md: "xs" }} color="gray.500">
                                {comment.date}
                              </Text>
                              {user && comment.user === user.name && (
                                <Flex gap={1}>
                                  <IconButton
                                    aria-label="ëŒ“ê¸€ ìˆ˜ì •"
                                    icon={<Icon as={EditIcon} w={3} h={3} />}
                                    size="xs"
                                    variant="ghost"
                                    colorScheme="blue"
                                    onClick={() => handleEditComment(index)}
                                    h="20px"
                                    w="20px"
                                  />
                                  <IconButton
                                    aria-label="ëŒ“ê¸€ ì‚­ì œ"
                                    icon={<Icon as={DeleteIcon} w={3} h={3} />}
                                    size="xs"
                                    variant="ghost"
                                    colorScheme="red"
                                    onClick={() => handleDeleteComment(index)}
                                    h="20px"
                                    w="20px"
                                  />
                                </Flex>
                              )}
                            </Flex>
                          </Flex>
                        )}
                      </Box>
                    ))}
                  </VStack>

                  {/* ëŒ“ê¸€ ì…ë ¥ */}
                  <Flex gap={2} direction={{ base: 'column', sm: 'row' }}>
                    <Input
                      placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                      size={{ base: "xs", md: "sm" }}
                      flex="1"
                      value={commentText}
                      onChange={(e) => setCommentText(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleAddComment();
                        }
                      }}
                      h={{ base: "24px", md: "28px" }}
                      border="2px solid"
                      borderColor="blue.300"
                      _focus={{ borderColor: "blue.500", boxShadow: "0 0 0 1px var(--chakra-colors-blue-500)" }}
                      _hover={{ borderColor: "blue.400" }}
                    />
                    <IconButton
                      aria-label="ëŒ“ê¸€ ì‘ì„±"
                      icon={<ArrowUpIcon />}
                      size={{ base: "xs", md: "sm" }}
                      colorScheme="blue"
                      onClick={handleAddComment}
                      isDisabled={!commentText.trim()}
                      w={{ base: "100%", sm: "auto" }}
                      h={{ base: "24px", md: "28px" }}
                    />
                  </Flex>
                </VStack>
              </VStack>
            ) : (
              <VStack spacing={4} align="stretch">
                {/* íˆ¬í‘œ ì°¸ì—¬ì ë° ë¶ˆì°¸ì ì •ë³´ */}
                <Flex justify="space-between" align="center" wrap="wrap" gap={2}>
                  <Tooltip 
                    label="íˆ¬í‘œì— ì°¸ì—¬í•œ íšŒì› ìˆ˜"
                    placement="top"
                    hasArrow
                    bg="purple.600"
                    color="white"
                    fontSize="sm"
                    borderRadius="md"
                    px={3}
                    py={2}
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} fontWeight="medium" textAlign={{ base: "center", sm: "left" }}>
                      íˆ¬í‘œ ì°¸ì—¬ì: 
                      <Badge bg="purple.600" color="white" fontSize={{ base: "xs", md: "sm" }} px={1} py={0.5} borderRadius="md" ml={1}>
                        {(() => {
                          if (!voteResults || !(voteResults as any).voteSession || !(voteResults as any).voteSession.votes) return '0ëª…';
                          
                          // í˜„ì¬ ì„¸ì…˜ ID ê³„ì‚°
                          const currentSessionId = `session_${new Date().toISOString().split('T')[0].replace(/-/g, '_')}`;
                          
                          // í˜„ì¬ ì„¸ì…˜ì˜ íˆ¬í‘œë§Œ í•„í„°ë§
                          const currentSessionVotes = (voteResults as any).voteSession.votes.filter((vote: any) => vote.sessionId === currentSessionId);
                          
                          // ì‹¤ì œ íšŒì› ì¤‘ íˆ¬í‘œì— ì°¸ì—¬í•œ íšŒì›ë§Œ ê³„ì‚° (ê´€ë¦¬ì ì—­í•  ì œì™¸)
                          const currentParticipants = new Set<number>();
                          currentSessionVotes.forEach((vote: any) => {
                            const member = allMembers.find(m => m.id === vote.userId);
                            if (member && (member as any).role !== 'ADMIN') {
                              currentParticipants.add(vote.userId);
                            }
                          });
                          
                          return `${currentParticipants.size}ëª…`;
                        })()}
                      </Badge>
                    </Text>
                  </Tooltip>
                  
                  <Tooltip 
                    label={`íˆ¬í‘œ ë¯¸ì°¸ì—¬ ì¸ì›: ${allMembers.map(member => member.name).join(', ')}`}
                    placement="top"
                    hasArrow
                    bg="red.600"
                    color="white"
                    fontSize="sm"
                    borderRadius="md"
                    px={3}
                    py={2}
                  >
                    <Text fontSize={{ base: "xs", md: "sm" }} fontWeight="medium" textAlign={{ base: "center", sm: "left" }}>
                      ë¶ˆì°¸ì: 
                      <Badge bg="red.600" color="white" fontSize={{ base: "xs", md: "sm" }} px={1} py={0.5} borderRadius="md" ml={1}>
                        {(() => {
                          // í†µí•© APIì—ì„œ ë¶ˆì°¸ì ìˆ˜ ê³„ì‚°
                          console.log('ğŸ” ë¶ˆì°¸ì ìˆ˜ ê³„ì‚°:', {
                            allMembers: unifiedVoteData?.allMembers?.length || 0,
                            totalParticipants: unifiedVoteData?.activeSession?.totalParticipants || 0,
                            calculated: unifiedVoteData?.allMembers && unifiedVoteData?.activeSession?.totalParticipants 
                              ? unifiedVoteData.allMembers.length - unifiedVoteData.activeSession.totalParticipants 
                              : 0
                          });
                          
                          if (unifiedVoteData?.allMembers && unifiedVoteData?.activeSession?.totalParticipants) {
                            return unifiedVoteData.allMembers.length - unifiedVoteData.activeSession.totalParticipants;
                          }
                          return 0;
                        })()}ëª…
                      </Badge>
                    </Text>
                  </Tooltip>
                </Flex>

                {/* íˆ¬í‘œ ëª©ë¡ */}
                <VStack spacing={0.5} align="stretch">
                  {getScheduleData.nextWeekVoteData.map((vote, index) => (
                    <Flex 
                      key={index} 
                      justify="space-between" 
                      align="center" 
                      p={2} 
                      border="0 0 1px 0 solid"
                      borderColor="gray.200"
                      bg="transparent"
                      borderRadius="md"
                      _hover={{ bg: "gray.50" }}
                    >
                      <Text 
                        fontSize={{ base: "xs", md: "sm" }} 
                        textAlign="center" 
                        w="20%" 
                        fontWeight="normal"
                      >
                        {vote.date}
                      </Text>
                      <Badge 
                        bg="gray.200"
                        color="gray.600"
                        variant="solid" 
                        borderRadius="full" 
                        px={{ base: 1, md: 2 }} 
                        py={{ base: 0.5, md: 1 }} 
                        fontSize={{ base: "2xs", md: "xs" }}
                        w={{ base: "32px", md: "36px" }}
                        h={{ base: "20px", md: "22px" }}
                        display="flex"
                        alignItems="center"
                        justifyContent="center"
                        flexShrink={0}
                        textAlign="center"
                        fontWeight="normal"
                      >
                        {(() => {
                          // í†µí•© APIì—ì„œ íˆ¬í‘œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                          if (!unifiedVoteData?.activeSession?.results) return '0ëª…';
                          
                          // ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ìš”ì¼ ì¶”ì¶œ
                          const match = vote.date.match(/(\d+)ì›” (\d+)ì¼\((.+)\)/);
                          if (match) {
                            const dayOfWeek = match[3]; // ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ
                            const dayKeys: { [key: string]: string } = {
                              'ì›”': 'MON',
                              'í™”': 'TUE', 
                              'ìˆ˜': 'WED',
                              'ëª©': 'THU',
                              'ê¸ˆ': 'FRI'
                            };
                            
                            const dayKey = dayKeys[dayOfWeek];
                            if (dayKey && unifiedVoteData.activeSession.results[dayKey]) {
                              const count = unifiedVoteData.activeSession.results[dayKey].count || 0;
                              return count > 0 ? `${count}ëª…` : '0ëª…';
                            }
                          }
                          return '0ëª…';
                        })()}
                      </Badge>
                      <Text 
                        fontSize={{ base: "2xs", md: "xs" }} 
                        color="gray.500" 
                        textAlign="center" 
                        w="60%"
                        fontStyle="italic"
                      >
                        {(() => {
                          // í†µí•© APIì—ì„œ íˆ¬í‘œì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                          if (!unifiedVoteData?.activeSession?.results) return 'íˆ¬í‘œ ì—†ìŒ';
                          
                          // ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ìš”ì¼ ì¶”ì¶œ
                          const match = vote.date.match(/(\d+)ì›” (\d+)ì¼\((.+)\)/);
                          if (match) {
                            const dayOfWeek = match[3]; // ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ
                            const dayKeys: { [key: string]: string } = {
                              'ì›”': 'MON',
                              'í™”': 'TUE', 
                              'ìˆ˜': 'WED',
                              'ëª©': 'THU',
                              'ê¸ˆ': 'FRI'
                            };
                            
                            const dayKey = dayKeys[dayOfWeek];
                            if (dayKey && unifiedVoteData.activeSession.results[dayKey]) {
                              const dayResult = unifiedVoteData.activeSession.results[dayKey];
                              if (dayResult.participants && dayResult.participants.length > 0) {
                                const names = dayResult.participants.map((p: any) => p.userName).filter(Boolean);
                                return names.length > 0 ? names.join(', ') : 'íˆ¬í‘œ ì—†ìŒ';
                              }
                            }
                          }
                          return 'íˆ¬í‘œ ì—†ìŒ';
                        })()}
                      </Text>
                    </Flex>
                  ))}
                </VStack>

                {/* ëŒ“ê¸€ ì…ë ¥ */}
                <Flex gap={2} direction={{ base: 'column', sm: 'row' }}>
                  <Input
                    placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    size={{ base: "xs", md: "sm" }}
                    flex="1"
                    value={commentText}
                    onChange={(e) => setCommentText(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        handleAddComment();
                      }
                    }}
                    h={{ base: "24px", md: "28px" }}
                    border="2px solid"
                    borderColor="blue.300"
                    _focus={{ borderColor: "blue.500", boxShadow: "0 0 0 1px var(--chakra-colors-blue-500)" }}
                    _hover={{ borderColor: "blue.400" }}
                  />
                  <IconButton
                    aria-label="ëŒ“ê¸€ ì‘ì„±"
                    icon={<ArrowUpIcon />}
                    size={{ base: "xs", md: "sm" }}
                    colorScheme="blue"
                    onClick={handleAddComment}
                    isDisabled={!commentText.trim()}
                    w={{ base: "100%", sm: "auto" }}
                    h={{ base: "24px", md: "28px" }}
                  />
                </Flex>

                {/* íˆ¬í‘œí•˜ê¸° ë²„íŠ¼ */}
                <Flex justify="center" mt={4}>
                  <Button
                    colorScheme="blue"
                    size="sm"
                    onClick={() => setShowVoteStatus(false)}
                  >
                    íˆ¬í‘œí•˜ê¸°
                  </Button>
                </Flex>
              </VStack>
            )}
          </ModalBody>
        </ModalContent>
      </Modal>

      {/* ê²½ê¸°ì •ë³´ ëª¨ë‹¬ */}
      <Modal 
        isOpen={showGameModal} 
        onClose={handleCloseGameModal} 
        size="xs" 
        isCentered
        aria-labelledby="game-detail-modal-title"
        aria-describedby="game-detail-modal-description"
      >
        <ModalOverlay />
        <ModalContent maxW="380px">
          <ModalHeader fontSize="md" pb={2} id="game-detail-modal-title">
            ğŸ“… ì¼ì • ìƒì„¸ì •ë³´
          </ModalHeader>
          <ModalCloseButton size="sm" aria-label="ê²½ê¸° ìƒì„¸ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°" />
          <ModalBody pb={4} id="game-detail-modal-description">
            {selectedGameData ? (
              <VStack spacing={1.5} align="stretch">
                {/* ìœ í˜• */}
                <Flex align="center" gap={2}>
                  <Box as="span" fontSize="md">âš½</Box>
                  <Text fontSize="sm" fontWeight="medium">
                    ìœ í˜•: {(() => {
                      const eventType = selectedGameData.eventType || 'ìì²´';
                      // ë¹„ê·œê²© ê°’ ì •ê·œí™”
                      if (['í’‹ì‚´', 'FRIENDLY', 'FRIENDLY_MATCH'].includes(eventType)) return 'ë§¤ì¹˜';
                      if (!['ë§¤ì¹˜', 'ìì²´', 'íšŒì‹', 'ê¸°íƒ€'].includes(eventType)) return 'ê¸°íƒ€';
                      return eventType;
                    })()}
                  </Text>
                </Flex>

                {/* ì¼ì‹œ */}
                <Flex align="center" gap={2} mt="-18.9px">
                  <Box as="span" fontSize="md">ğŸ•</Box>
                  <Text fontSize="sm" fontWeight="medium">
                    ì¼ì‹œ: {(() => {
                      if (selectedGameData.date && selectedGameData.time) {
                        const date = new Date(selectedGameData.date);
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                        return `${month}ì›” ${day}ì¼(${dayOfWeek}) ${selectedGameData.time}`;
                      } else if (selectedGameData.date) {
                        const date = new Date(selectedGameData.date);
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                        return `${month}ì›” ${day}ì¼(${dayOfWeek})`;
                      }
                      return 'ì¼ì‹œ ë¯¸ì •';
                    })()}
                  </Text>
                </Flex>

                {/* ì¥ì†Œ */}
                <Flex align="center" justify="space-between" mt="-18.9px">
                  <Flex align="flex-start" gap={2} direction="column" flex={1}>
                    <Flex align="center" gap={2}>
                      <Box as="span" fontSize="md">ğŸ“</Box>
                      <Text fontSize="sm" fontWeight="medium">
                        ì¥ì†Œ: {selectedGameData.location || 'ì¥ì†Œ ë¯¸ì •'}
                      </Text>
                    </Flex>
                    {/* ì£¼ì†Œ í‘œì‹œ */}
                    {selectedGameData.locationAddress && (
                      <Text fontSize="xs" color="gray.600" pl={6} mt="-21px">
                        {selectedGameData.locationAddress}
                      </Text>
                    )}
                  </Flex>
                  <Button
                    size="xs"
                    height="22px"
                    minW="22px"
                    fontSize="11px"
                    p={0}
                    bg="yellow.400"
                    color="blue.600"
                    onClick={() => {
                      // locationì—ì„œ ì„¸ë¶€ ì¥ì†Œ ì œê±° (ë§ˆì§€ë§‰ ê³µë°± ì´í›„ ë¶€ë¶„ ì œê±°)
                      const location = selectedGameData.location || '';
                      const locationBase = location.includes(' ') ? location.substring(0, location.lastIndexOf(' ')) : location;
                      const searchQuery = encodeURIComponent(locationBase);
                      window.open(`https://map.kakao.com/link/search/${searchQuery}`, '_blank');
                    }}
                  >
                    K
                  </Button>
                </Flex>

                {/* ì°¸ì„ì ì •ë³´ */}
                <Flex align="center" gap={2} mt="-18.9px">
                  <Box as="span" fontSize="md">ğŸ‘¥</Box>
                  <Text fontSize="sm" fontWeight="medium">
                    ì°¸ì„ì : {(() => {
                      const rawMemberNames = Array.isArray(selectedGameData.memberNames) ? 
                        selectedGameData.memberNames : 
                        (typeof selectedGameData.memberNames === 'string' ? 
                          JSON.parse(selectedGameData.memberNames) : []);
                      const rawSelectedMembers = Array.isArray(selectedGameData.selectedMembers) ? 
                        selectedGameData.selectedMembers : 
                        (typeof selectedGameData.selectedMembers === 'string' ? 
                          JSON.parse(selectedGameData.selectedMembers) : []);

                      // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íšŒì›ë§Œ í•„í„°ë§
                      const validSelectedMembers = rawSelectedMembers.filter((name: string) => {
                        return allMembers.some(member => member.name === name);
                      });

                      const selectedSet = new Set<string>(validSelectedMembers);
                      const namesSet = new Set<string>(rawMemberNames as string[]);

                      const memberCount = validSelectedMembers.length; // ìœ íš¨í•œ íšŒì›ë§Œ ê³„ì‚°
                      const mercenaryCount = selectedGameData.mercenaryCount || 0;
                      // ê¸°íƒ€: ìˆ˜ê¸° ì…ë ¥ ì´ë¦„ë“¤(íšŒì›/ìš©ë³‘ ì œì™¸)
                      let otherCount = 0;
                      namesSet.forEach((name) => {
                        if (typeof name !== 'string') return;
                        const trimmedName = name.trim();
                        if (trimmedName === '') return; // ë¹ˆ ë¬¸ìì—´ ì œì™¸
                        if (selectedSet.has(trimmedName)) return; // ì´ë¯¸ íšŒì›ìœ¼ë¡œ ê³„ì‚°
                        if (trimmedName.startsWith('ìš©ë³‘')) return; // ìš©ë³‘ ë¬¸êµ¬ ì œì™¸
                        otherCount++;
                      });

                      return memberCount + mercenaryCount + otherCount;
                    })()}ëª…
                  </Text>
                  <Text fontSize="xs" whiteSpace="nowrap">
                    ({(() => {
                      const rawMemberNames = Array.isArray(selectedGameData.memberNames) ? 
                        selectedGameData.memberNames : 
                        (typeof selectedGameData.memberNames === 'string' ? 
                          JSON.parse(selectedGameData.memberNames) : []);
                      const rawSelectedMembers = Array.isArray(selectedGameData.selectedMembers) ? 
                        selectedGameData.selectedMembers : 
                        (typeof selectedGameData.selectedMembers === 'string' ? 
                          JSON.parse(selectedGameData.selectedMembers) : []);

                      // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íšŒì›ë§Œ í•„í„°ë§
                      const validSelectedMembers = rawSelectedMembers.filter((name: string) => {
                        return allMembers.some(member => member.name === name);
                      });

                      const selectedSet = new Set<string>(validSelectedMembers);
                      const namesSet = new Set<string>(rawMemberNames as string[]);

                      const memberCount = validSelectedMembers.length; // ìœ íš¨í•œ íšŒì›ë§Œ ê³„ì‚°
                      const mercenaryCount = selectedGameData.mercenaryCount || 0;
                      // ê¸°íƒ€: ìˆ˜ê¸° ì…ë ¥ ì´ë¦„ë“¤(íšŒì›/ìš©ë³‘ ì œì™¸)
                      let otherCount = 0;
                      namesSet.forEach((name) => {
                        if (typeof name !== 'string') return;
                        const trimmedName = name.trim();
                        if (trimmedName === '') return; // ë¹ˆ ë¬¸ìì—´ ì œì™¸
                        if (selectedSet.has(trimmedName)) return; // ì´ë¯¸ íšŒì›ìœ¼ë¡œ ê³„ì‚°
                        if (trimmedName.startsWith('ìš©ë³‘')) return; // ìš©ë³‘ ë¬¸êµ¬ ì œì™¸
                        otherCount++;
                      });

                      const parts = [] as Array<{ text: string; color: string }>;
                      if (memberCount > 0) parts.push({ text: `íšŒì› ${memberCount}ëª…`, color: '#004ea8' });
                      if (mercenaryCount > 0) parts.push({ text: `ìš©ë³‘ ${mercenaryCount}ëª…`, color: '#000000' });
                      if (otherCount > 0) parts.push({ text: `ê¸°íƒ€ ${otherCount}ëª…`, color: '#ff6b35' });

                      return parts.length > 0 ? (
                        <span>
                          {parts.map((part, index) => (
                            <span
                              key={index}
                              style={{ color: part.color, fontWeight: '500' }}
                            >
                              {part.text}{index < parts.length - 1 ? ' + ' : ''}
                            </span>
                          ))}
                        </span>
                      ) : 'ì°¸ì„ì ì—†ìŒ';
                    })()})
                  </Text>
                </Flex>

                {/* ì°¸ì„ì ëª©ë¡ */}
                {(() => {
                  const rawMemberNames = Array.isArray(selectedGameData.memberNames) ? 
                    selectedGameData.memberNames : 
                    (typeof selectedGameData.memberNames === 'string' ? 
                      JSON.parse(selectedGameData.memberNames) : []);
                  const rawSelectedMembers = Array.isArray(selectedGameData.selectedMembers) ? 
                    selectedGameData.selectedMembers : 
                    (typeof selectedGameData.selectedMembers === 'string' ? 
                      JSON.parse(selectedGameData.selectedMembers) : []);

                  const participants: Array<{name: string, type: 'member' | 'mercenary' | 'other'}> = [];
                  
                  // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íšŒì›ë§Œ í•„í„°ë§
                  const validSelectedMembers = rawSelectedMembers.filter((name: string) => {
                    return allMembers.some(member => member.name === name);
                  });
                  
                  const selectedSet = new Set<string>(validSelectedMembers);
                  const namesSet = new Set<string>(rawMemberNames as string[]);

                  // íšŒì› ë°°ì§€: ìœ íš¨í•œ íšŒì›ë§Œ í‘œì‹œ
                  validSelectedMembers.forEach((name: string) => {
                    participants.push({ name, type: 'member' });
                  });

                  // ìš©ë³‘ ë°°ì§€: ë¬¶ìŒìœ¼ë¡œ 1ê°œ ë°°ì§€
                  const mercenaryCount = selectedGameData.mercenaryCount || 0;
                  if (mercenaryCount > 0) participants.push({ name: `ìš©ë³‘ ${mercenaryCount}ëª…`, type: 'mercenary' });

                  // ê¸°íƒ€ ë°°ì§€: ìˆ˜ê¸° ì…ë ¥ ì´ë¦„ë“¤(íšŒì›/ìš©ë³‘ ì œì™¸)
                  namesSet.forEach((name) => {
                    if (typeof name !== 'string') return;
                    if (selectedSet.has(name)) return; // ì´ë¯¸ íšŒì›ìœ¼ë¡œ ì²˜ë¦¬ë¨
                    if (name.startsWith('ìš©ë³‘')) return; // ìš©ë³‘ ë¬¸êµ¬ ì œì™¸
                    participants.push({ name, type: 'other' });
                  });
                  
                  return participants.length > 0 ? (
                    <Flex wrap="wrap" gap={1} justify="center">
                      {participants.map((participant, index) => (
                        <Badge
                          key={index}
                          bg={
                            participant.type === 'member' ? '#004ea8' : 
                            participant.type === 'mercenary' ? '#000000' : 
                            '#ff6b35'
                          }
                          color="white"
                          variant="solid"
                          borderRadius="full"
                          px={2}
                          py={0.5}
                          fontSize="xs"
                        >
                          {participant.name}
                        </Badge>
                      ))}
                    </Flex>
                  ) : null;
                })()}
              </VStack>
            ) : (
              <Text>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</Text>
            )}
          </ModalBody>
        </ModalContent>
      </Modal>

      {/* ì •ì§€ í•´ì œ ìš”ì²­ ëª¨ë‹¬ */}
      <Modal 
        isOpen={showSuspensionRequestModal} 
        onClose={() => setShowSuspensionRequestModal(false)}
        aria-labelledby="suspension-request-modal-title"
        aria-describedby="suspension-request-modal-description"
      >
        <ModalOverlay />
        <ModalContent>
          <ModalHeader color="#004ea8" id="suspension-request-modal-title">ğŸ”“ ì •ì§€ í•´ì œ ìš”ì²­</ModalHeader>
          <ModalCloseButton aria-label="ì •ì§€ í•´ì œ ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°" />
          <ModalBody pb={6} id="suspension-request-modal-description">
            <VStack spacing={4} align="stretch">
              <Text color="gray.700">
                ì •ì§€ í•´ì œë¥¼ ìš”ì²­í•˜ì‹œëŠ” ì‚¬ìœ ë¥¼ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”. 
                ê´€ë¦¬ì ê²€í†  í›„ ìŠ¹ì¸ ë˜ëŠ” ê±°ì ˆë©ë‹ˆë‹¤.
              </Text>
              
              <FormControl>
                <FormLabel color="gray.700" fontWeight="bold">ìš”ì²­ ì‚¬ìœ </FormLabel>
                <Textarea
                  value={suspensionRequestReason}
                  onChange={(e) => setSuspensionRequestReason(e.target.value)}
                  placeholder="ì •ì§€ í•´ì œë¥¼ ì›í•˜ëŠ” êµ¬ì²´ì ì¸ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                  rows={4}
                  resize="vertical"
                  aria-label="ì •ì§€ í•´ì œ ìš”ì²­ ì‚¬ìœ  ì…ë ¥"
                  aria-required="true"
                />
              </FormControl>
              
              <HStack spacing={3} justify="flex-end">
                <Button
                  variant="outline"
                  onClick={() => setShowSuspensionRequestModal(false)}
                >
                  ì·¨ì†Œ
      </Button>
                <Button
                  colorScheme="blue"
                  onClick={handleSuspensionRequestSubmit}
                  isDisabled={!suspensionRequestReason.trim()}
                >
                  ìš”ì²­ ì œì¶œ
                </Button>
              </HStack>
  </VStack>
          </ModalBody>
        </ModalContent>
      </Modal>

      {/* íˆ¬í‘œ ì™„ë£Œ ê³µìœ  ì•ˆë‚´ */}
      {showVoteSharePrompt && (
        <Box
          position="fixed"
          right={{ base: 4, md: 6 }}
          bottom={{ base: 4, md: 6 }}
          bg="#0B63CE"
          border="1px solid"
          borderColor="#0B63CE"
          borderRadius="lg"
          boxShadow="lg"
          px={4}
          py={3}
          zIndex={2000}
          maxW={{ base: 'calc(100% - 32px)', md: '360px' }}
        >
          <HStack justify="space-between" align="start" spacing={3}>
            <VStack align="start" spacing={1}>
              <Text fontSize="sm" fontWeight="bold" color="white">
                íˆ¬í‘œ ì™„ë£Œ! ë‹¨í†¡ì— ê³µìœ í•´ìš”
              </Text>
              <Text fontSize="xs" color="blue.100">
                ê³µìœ í•˜ë©´ ì°¸ì—¬ìœ¨ì´ ì˜¬ë¼ê°€ìš”.
              </Text>
            </VStack>
            <IconButton
              aria-label="ê³µìœ  ì•ˆë‚´ ë‹«ê¸°"
              size="xs"
              variant="ghost"
              icon={<SmallCloseIcon />}
              color="white"
              _hover={{ bg: 'rgba(255,255,255,0.15)' }}
              onClick={() => setShowVoteSharePrompt(false)}
            />
          </HStack>
          <HStack mt={3} spacing={2}>
            <Button
              size="sm"
              bg="#FEE500"
              color="black"
              _hover={{ bg: '#F7D600' }}
              onClick={handleKakaoShare}
            >
              ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
            </Button>
            <Button
              size="sm"
              bg="white"
              color="#0B63CE"
              _hover={{ bg: 'blue.50' }}
              onClick={handleCopyShareText}
            >
              ë©”ì‹œì§€ ë³µì‚¬
            </Button>
          </HStack>
        </Box>
      )}
    </Box>
);
}

