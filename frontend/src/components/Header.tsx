import { useState, useEffect, useRef } from 'react';
import { Flex, Text, Button, HStack, Badge, Modal, ModalOverlay, ModalContent, ModalBody, useDisclosure, Box, FormControl, FormLabel, Input, useToast, Tooltip } from '@chakra-ui/react';
import { CalendarIcon, ViewIcon, SettingsIcon, AttachmentIcon, ExternalLinkIcon } from '@chakra-ui/icons';
import { useAuthStore } from '../store/auth';
import { changePassword } from '../api/auth';
import Signup from '../pages/Signup';
import Login from '../pages/Login';
import { useNavigate, useLocation } from 'react-router-dom';
import eventBus, { EVENT_TYPES } from '../utils/eventBus';

export default function Header() {
  const { isOpen, onOpen, onClose } = useDisclosure();
  const user = useAuthStore((s) => s.user);
  const logout = useAuthStore((s) => s.logout);
  const setUser = useAuthStore((s) => s.setUser);
  const token = useAuthStore((s) => s.token);
  const [showSignup, setShowSignup] = useState(false);
  const attendance = user?.attendance ?? null;
  const voteAttendance = user?.voteAttendance ?? null;
  const navigate = useNavigate();
  const location = useLocation();
  const [isNameModalOpen, setIsNameModalOpen] = useState(false);
  const [editName, setEditName] = useState(user?.name || '');
  const [nameLoading, setNameLoading] = useState(false);
  const [nameError, setNameError] = useState<string | null>(null);
  const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [passwordLoading, setPasswordLoading] = useState(false);
  const [passwordError, setPasswordError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const toast = useToast();

  // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
  const refreshUserData = async () => {
    if (!token) return;
    
    try {
      setIsLoading(true);
      console.log('üîÑ Ìó§Îçî: ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë');
      
      // Ï∫êÏãúÎ•º Î¨¥ÏãúÌïòÍ≥† Í∞ïÏ†úÎ°ú ÏÉàÎ°úÍ≥†Ïπ®
      const response = await fetch('http://localhost:4000/api/auth/profile', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('üìä Ìó§Îçî: ÌîÑÎ°úÌïÑ API ÏùëÎãµ:', {
        voteDetails: data.voteDetails,
        voteAttendance: data.voteAttendance,
        participated: data.voteDetails?.participated,
        total: data.voteDetails?.total
      });
      
      setUser(data);
      console.log('‚úÖ Ìó§Îçî: ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å:', {
        voteAttendance: data.voteAttendance,
        voteDetails: data.voteDetails,
        name: data.name
      });
    } catch (error) {
      console.error('‚ùå Ìó§Îçî: ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Ìà¨Ìëú Ï†úÏ∂ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleVoteSubmitted = () => {
      console.log('üó≥Ô∏è Ìó§Îçî: Ìà¨Ìëú Ï†úÏ∂ú Ïù¥Î≤§Ìä∏ ÏàòÏã†, ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
      refreshUserData();
    };

    window.addEventListener('voteSubmitted', handleVoteSubmitted);
    return () => {
      window.removeEventListener('voteSubmitted', handleVoteSubmitted);
    };
  }, [token]);

  const handleNamePillClick = () => {
    setEditName(user?.name || '');
    setIsNameModalOpen(true);
  };
  const handleNameSave = async () => {
    if (!user || !token) return;
    setNameLoading(true);
    setNameError(null);
    try {
      const updated = await import('../api/auth').then(m => m.updateProfile(editName));
      setUser(updated.user);
      setIsNameModalOpen(false);
      toast({ title: 'Ïù¥Î¶ÑÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', status: 'success', duration: 2000 });
    } catch {
      setNameError('Ïù¥Î¶Ñ ÏàòÏ†ï Ïã§Ìå®');
    } finally {
      setNameLoading(false);
    }
  };

  const handlePasswordChange = async () => {
    if (!user || !token) return;
    
    if (newPassword !== confirmPassword) {
      setPasswordError('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
      return;
    }
    
    if (newPassword.length < 6) {
      setPasswordError('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏµúÏÜå 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
      return;
    }
    
    setPasswordLoading(true);
    setPasswordError(null);
    try {
      // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω API Ìò∏Ï∂ú
      const { changePassword } = await import('../api/auth');
      await changePassword(newPassword);
      
      setIsPasswordModalOpen(false);
      setNewPassword('');
      setConfirmPassword('');
      toast({ title: 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', status: 'success', duration: 2000 });
    } catch (error) {
      console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
      setPasswordError('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    } finally {
      setPasswordLoading(false);
    }
  };

  // Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© ÏÉÅÌÉú
  const [animatedAttendance, setAnimatedAttendance] = useState(0);
  const [animatedVoteAttendance, setAnimatedVoteAttendance] = useState(0);
  const animationRef = useRef<NodeJS.Timeout | null>(null);
  const voteAnimationRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    // Ïã§Ï†ú Ï∞∏Ïó¨Ïú® Í≥ÑÏÇ∞
    const gameDetails = user?.gameDetails;
    const targetAttendance = gameDetails && gameDetails.total > 0 
      ? Math.round((gameDetails.participated / gameDetails.total) * 100)
      : 0;
    
    setAnimatedAttendance(0);
    
    // Ïï†ÎãàÎ©îÏù¥ÏÖò: 0ÏóêÏÑú targetAttendanceÍπåÏßÄ Îπ†Î•¥Í≤å Ï¶ùÍ∞Ä
    const duration = 700; // ms
    const frameRate = 1000 / 60; // 60fps
    const totalFrames = Math.round(duration / frameRate);
    let frame = 0;
    if (animationRef.current) clearInterval(animationRef.current);
    animationRef.current = setInterval(() => {
      frame++;
      const progress = Math.min(frame / totalFrames, 1);
      const value = Math.round(progress * targetAttendance);
      setAnimatedAttendance(value);
      if (progress === 1) {
        if (animationRef.current) clearInterval(animationRef.current);
      }
    }, frameRate);
    return () => {
      if (animationRef.current) clearInterval(animationRef.current);
    };
  }, [user?.gameDetails]);

  // Ìà¨Ìëú Ï∞∏Ïó¨Ïú® Ïï†ÎãàÎ©îÏù¥ÏÖò
  useEffect(() => {
    // Ïã§Ï†ú Ìà¨ÌëúÏú® Í≥ÑÏÇ∞
    const voteDetails = user?.voteDetails;
    const targetVoteAttendance = voteDetails && voteDetails.total > 0 
      ? Math.round((voteDetails.participated / voteDetails.total) * 100)
      : 0;
    
    // Ïï†ÎãàÎ©îÏù¥ÏÖò: 0ÏóêÏÑú targetVoteAttendanceÍπåÏßÄ Îπ†Î•¥Í≤å Ï¶ùÍ∞Ä
    const duration = 700; // ms
    const frameRate = 1000 / 60; // 60fps
    const totalFrames = Math.round(duration / frameRate);
    let frame = 0;
    if (voteAnimationRef.current) clearInterval(voteAnimationRef.current);
    voteAnimationRef.current = setInterval(() => {
      frame++;
      const progress = Math.min(frame / totalFrames, 1);
      const value = Math.round(progress * targetVoteAttendance);
      setAnimatedVoteAttendance(value);
      if (progress === 1) {
        if (voteAnimationRef.current) clearInterval(voteAnimationRef.current);
      }
    }, frameRate);
    return () => {
      if (voteAnimationRef.current) clearInterval(voteAnimationRef.current);
    };
  }, [user?.voteDetails]);

  // gaugeGrow keyframesÎ•º Ìó§ÎçîÏóêÎèÑ Ï†ÅÏö© (ÏµúÏ¥à 1Ìöå)
  useEffect(() => {
    const styleId = 'header-gauge-grow-keyframes';
    if (!document.getElementById(styleId)) {
      const style = document.createElement('style');
      style.id = styleId;
      style.innerHTML = `@keyframes gaugeGrow { from { width: 0%; } to { width: var(--gauge-width, 100%); } }`;
      document.head.appendChild(style);
    }
  }, []);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
  useEffect(() => {
    if (token) {
      console.log('üöÄ Ìó§Îçî: Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏, ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
      refreshUserData();
    }
  }, [token]); // tokenÏù¥ Î≥ÄÍ≤ΩÎê† ÎïåÎßå Ïã§Ìñâ

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∞ïÏ†úÎ°ú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
  useEffect(() => {
    if (token && user) {
      console.log('üîÑ Ìó§Îçî: ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®');
      refreshUserData();
    }
  }, []); // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Ìïú Î≤àÎßå Ïã§Ìñâ

  // Ìà¨Ìëú ÏôÑÎ£å Ïù¥Î≤§Ìä∏ ÏàòÏã†ÌïòÏó¨ ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
  useEffect(() => {
    const handleVoteSubmitted = () => {
      console.log('üîç Ìó§Îçî: Ìà¨Ìëú ÏôÑÎ£å Ïù¥Î≤§Ìä∏ ÏàòÏã†, ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
      if (user && token) {
        refreshUserData();
      }
    };

    window.addEventListener('voteSubmitted', handleVoteSubmitted);
    // Í≤ΩÍ∏∞ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ÏóêÎèÑ Ï¶âÏãú ÏÉàÎ°úÍ≥†Ïπ®
    const handleGamesChanged = () => {
      console.log('üîî Ìó§Îçî: Í≤ΩÍ∏∞ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ ÏàòÏã†, ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
      if (token) refreshUserData();
    };
    window.addEventListener('gamesChanged', handleGamesChanged);
    const busHandler = () => handleGamesChanged();
    eventBus.on(EVENT_TYPES.GAME_CREATED, busHandler);
    eventBus.on(EVENT_TYPES.GAME_UPDATED, busHandler);
    eventBus.on(EVENT_TYPES.GAME_DELETED, busHandler);
    eventBus.on(EVENT_TYPES.GAME_CONFIRMED, busHandler);
    eventBus.on(EVENT_TYPES.DATA_REFRESH_NEEDED, ({ payload }: any) => {
      if (payload?.dataType === 'games') handleGamesChanged();
    });
    
    return () => {
      window.removeEventListener('voteSubmitted', handleVoteSubmitted);
      window.removeEventListener('gamesChanged', handleGamesChanged);
      eventBus.off(EVENT_TYPES.GAME_CREATED, busHandler);
      eventBus.off(EVENT_TYPES.GAME_UPDATED, busHandler);
      eventBus.off(EVENT_TYPES.GAME_DELETED, busHandler);
      eventBus.off(EVENT_TYPES.GAME_CONFIRMED, busHandler);
    };
  }, [user, token]);

  return (
    <>
      <Flex as="nav" align="center" justify="space-between" px={{ base: 4, md: 16 }} py={4} bg="white" boxShadow="sm" w="100vw" position="fixed" top={0} left={0} right={0} zIndex={100}>
        <HStack spacing={4}>
          <Text 
            fontSize="xl" 
            fontWeight="bold" 
            cursor="pointer"
            onClick={(e) => { 
              e.preventDefault();
              e.stopPropagation();
              console.log('üîç ÌôàÏúºÎ°ú Ïù¥Îèô ÏãúÎèÑ - ÌòÑÏû¨ Í≤ΩÎ°ú:', window.location.pathname);
              console.log('üîç navigate Ìï®Ïàò ÌÉÄÏûÖ:', typeof navigate);
              
              // React Router navigate ÏãúÎèÑ
              try {
                navigate('/');
                console.log('üîç Ìôà navigate Ìò∏Ï∂ú ÏôÑÎ£å');
                
                // 0.5Ï¥à ÌõÑÏóêÎèÑ ÌéòÏù¥ÏßÄÍ∞Ä Ïïà Î∞îÎÄåÎ©¥ Í∞ïÏ†ú Ïù¥Îèô
                setTimeout(() => {
                  if (window.location.pathname !== '/') {
                    console.log('üîç React Router Ïã§Ìå®, Í∞ïÏ†ú Ïù¥Îèô ÏãúÎèÑ');
                    window.location.href = '/';
                  }
                }, 500);
              } catch (error) {
                console.error('üîç Ìôà navigate ÏóêÎü¨:', error);
                // ÏóêÎü¨ Î∞úÏÉù Ïãú Í∞ïÏ†ú Ïù¥Îèô
                window.location.href = '/';
              }
            }} 
            tabIndex={0} 
            aria-label="ÌôàÏúºÎ°ú Ïù¥Îèô"
            color="#004ea8"
            _hover={{ 
              color: '#00397a'
            }}
          >
            FC CHAL-GGYEO
          </Text>
        </HStack>
        <HStack spacing={4}>
          <Button 
            variant={location.pathname === '/schedule-v2' ? "outline" : "ghost"} 
            bg="transparent"
            color="#004ea8" 
            border="0.5px solid" 
            borderColor={location.pathname === '/schedule-v2' ? "#004ea8" : "transparent"} 
            _hover={{ 
              bg: location.pathname === '/schedule-v2' ? 'transparent' : 'gray.50',
              borderColor: "#004ea8"
            }} 
            leftIcon={<CalendarIcon />} 
            onClick={() => navigate('/schedule-v2')}
          >
            ÏùºÏ†ï
          </Button>
          <Button 
            variant={location.pathname === '/gallery/photos' ? "outline" : "ghost"} 
            bg="transparent"
            color="#004ea8" 
            border="0.5px solid" 
            borderColor={location.pathname === '/gallery/photos' ? "#004ea8" : "transparent"} 
            _hover={{ 
              bg: location.pathname === '/gallery/photos' ? 'transparent' : 'gray.50',
              borderColor: "#004ea8"
            }}
            leftIcon={<AttachmentIcon />}
            onClick={() => navigate('/gallery/photos')}
          >
            ÏÇ¨ÏßÑ
          </Button>
          <Button 
            variant={location.pathname === '/gallery/videos' ? "outline" : "ghost"} 
            bg="transparent"
            color="#004ea8" 
            border="0.5px solid" 
            borderColor={location.pathname === '/gallery/videos' ? "#004ea8" : "transparent"} 
            _hover={{ 
              bg: location.pathname === '/gallery/videos' ? 'transparent' : 'gray.50',
              borderColor: "#004ea8"
            }}
            leftIcon={<ExternalLinkIcon />}
            onClick={() => navigate('/gallery/videos')}
          >
            ÎèôÏòÅÏÉÅ
          </Button>
          {(user?.role === 'ADMIN' || user?.email === 'sti60val@gmail.com') && (
            <Button 
              variant={location.pathname === '/admin' ? "outline" : "ghost"} 
              bg="transparent"
              color="#004ea8" 
              border="0.5px solid" 
              borderColor={location.pathname === '/admin' ? "#004ea8" : "transparent"} 
              _hover={{ 
                bg: location.pathname === '/admin' ? 'transparent' : 'gray.50',
                borderColor: "#004ea8"
              }}
              leftIcon={<SettingsIcon />}
              onClick={(e) => { 
                e.preventDefault();
                e.stopPropagation();
                console.log('üîç Í¥ÄÎ¶¨ÏûêÎ°ú Ïù¥Îèô ÏãúÎèÑ - ÌòÑÏû¨ Í≤ΩÎ°ú:', window.location.pathname);
                console.log('üîç navigate Ìï®Ïàò ÌÉÄÏûÖ:', typeof navigate);
                
                // React Router navigate ÏãúÎèÑ
                try {
                  navigate('/admin');
                  console.log('üîç Í¥ÄÎ¶¨Ïûê navigate Ìò∏Ï∂ú ÏôÑÎ£å');
                  
                  // 0.5Ï¥à ÌõÑÏóêÎèÑ ÌéòÏù¥ÏßÄÍ∞Ä Ïïà Î∞îÎÄåÎ©¥ Í∞ïÏ†ú Ïù¥Îèô
                  setTimeout(() => {
                    if (window.location.pathname !== '/admin') {
                      console.log('üîç React Router Ïã§Ìå®, Í∞ïÏ†ú Ïù¥Îèô ÏãúÎèÑ');
                      window.location.href = '/admin';
                    }
                  }, 500);
                } catch (error) {
                  console.error('üîç Í¥ÄÎ¶¨Ïûê navigate ÏóêÎü¨:', error);
                  // ÏóêÎü¨ Î∞úÏÉù Ïãú Í∞ïÏ†ú Ïù¥Îèô
                  window.location.href = '/admin';
                }
              }}
            >
              Í¥ÄÎ¶¨Ïûê
            </Button>
          )}
        </HStack>
        <HStack spacing={4}>
          {!user ? (
            <Button size="sm" bg="#004ea8" color="white" _hover={{ bg: '#00397a' }} variant="outline" onClick={onOpen}>Î°úÍ∑∏Ïù∏</Button>
          ) : (
            <>
              <HStack align="center" spacing={3}>
                {/* Ìà¨ÌëúÏú®Í≥º Ï∞∏Ïó¨Ïú®Ïù¥ Ìï®Íªò ÌëúÏãúÎêòÎäî Ìó§ÎçîÎßå ÌëúÏãú */}
                {attendance !== null && (
                  <>
                    <Tooltip 
                      label={isLoading ? 'Î°úÎî© Ï§ë...' : `${user?.voteDetails?.participated || 0}/${user?.voteDetails?.total || 0} Ìà¨ÌëúÏ∞∏Ïó¨`}
                      placement="bottom"
                      hasArrow
                      bg="gray.800"
                      color="white"
                      fontSize="sm"
                    >
                      <Box minW="80px" textAlign="center" display="flex" flexDirection="column" alignItems="center" justifyContent="center">
                        <Text fontSize="xs" color="gray.500" cursor="default" _hover={{ color: "blue.400" }}>
                          Ìà¨ÌëúÏú® <span style={{ color: '#004ea8', fontWeight: 'bold' }}>
                            {isLoading ? '...' : `${animatedVoteAttendance}%`}
                          </span>
                        </Text>
                        <Box w="60px" mt={1}>
                          <Box
                            h="6px"
                            bg="#e2e8f0"
                            borderRadius={4}
                            overflow="hidden"
                            position="relative"
                          >
                            <Box
                              bg="#e53e3e"
                              h="100%"
                              borderRadius={4}
                              position="absolute"
                              left={0}
                              top={0}
                              zIndex={1}
                              style={{
                                width: `${animatedVoteAttendance}%`,
                                animation: `gaugeGrow 0.7s cubic-bezier(.4,2,.6,1)`,
                                animationFillMode: 'forwards',
                                '--gauge-width': `${animatedVoteAttendance}%`,
                                transition: 'width 0.7s cubic-bezier(.4,2,.6,1)'
                              } as React.CSSProperties}
                            />
                          </Box>
                        </Box>
                      </Box>
                    </Tooltip>
                    <Tooltip 
                      label={`${user?.gameDetails?.participated || 0}/${user?.gameDetails?.total || 0} Í≤ΩÍ∏∞ Ï∞∏Ïó¨`}
                      placement="bottom"
                      hasArrow
                      bg="gray.800"
                      color="white"
                      fontSize="sm"
                    >
                      <Box minW="80px" textAlign="center" display="flex" flexDirection="column" alignItems="center" justifyContent="center">
                        <Text fontSize="xs" color="gray.500" cursor="default" _hover={{ color: "blue.400" }}>Ï∞∏Ïó¨Ïú® <span style={{ color: '#004ea8', fontWeight: 'bold' }}>{animatedAttendance}%</span></Text>
                        <Box w="60px" mt={1}>
                          <Box
                            h="6px"
                            bg="#e2e8f0"
                            borderRadius={4}
                            overflow="hidden"
                            position="relative"
                          >
                            <Box
                              bg="#004ea8"
                              h="100%"
                              borderRadius={4}
                              position="absolute"
                              left={0}
                              top={0}
                              zIndex={1}
                              style={{
                                width: `${animatedAttendance}%`,
                                animation: `gaugeGrow 0.7s cubic-bezier(.4,2,.6,1)`,
                                animationFillMode: 'forwards',
                                '--gauge-width': `${animatedAttendance}%`,
                                transition: 'width 0.7s cubic-bezier(.4,2,.6,1)'
                              } as React.CSSProperties}
                            />
                          </Box>
                        </Box>
                      </Box>
                    </Tooltip>
                  </>
                )}
                <HStack align="center" spacing={2}>
                  <Badge bg="#004ea8" color="white" borderRadius="full" px={2} py={1}>Ï†ï</Badge>
                  <Text
                    fontWeight="bold"
                    cursor="pointer"
                    _hover={{ textDecoration: 'underline', color: '#00397a' }}
                    onClick={handleNamePillClick}
                  >
                    {user.name}
                  </Text>
                </HStack>
              </HStack>
              <Button size="sm" colorScheme="gray" variant="outline" onClick={() => { logout(); navigate('/'); }}>Î°úÍ∑∏ÏïÑÏõÉ</Button>
            </>
          )}
        </HStack>
      </Flex>
      {/* Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î™®Îã¨ */}
      <Modal isOpen={isOpen} onClose={() => { setShowSignup(false); onClose(); }} isCentered size="sm">
        <ModalOverlay />
        <ModalContent
          p={0}
          borderRadius="lg"
          minH="auto"
          maxH="400px"
          height="auto"
          mx="auto"
          my="auto"
          position="relative"
        >
          <ModalBody p={0} pt={0} pb={1} px={0} display="flex" alignItems="center" justifyContent="center" height="400px" minHeight="400px">
            {showSignup ? (
              <Signup onSwitch={() => setShowSignup(false)} onClose={() => { setShowSignup(false); onClose(); }} />
            ) : (
              <Login onSwitch={() => setShowSignup(true)} onClose={() => { setShowSignup(false); onClose(); }} />
            )}
          </ModalBody>
        </ModalContent>
      </Modal>
      {/* Ïù¥Î¶Ñ ÏàòÏ†ï Î™®Îã¨ */}
      <Modal isOpen={isNameModalOpen} onClose={() => setIsNameModalOpen(false)} isCentered size="sm">
        <ModalOverlay />
        <ModalContent>
          <ModalBody p={6}>
            <FormControl mb={4}>
              <FormLabel>ÏÉà Ïù¥Î¶Ñ</FormLabel>
              <Input value={editName} onChange={e => setEditName(e.target.value)} placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
            </FormControl>
            {nameError && <Text color="red.500" mb={2}>{nameError}</Text>}
            <Button bg="#004ea8" color="white" _hover={{ bg: '#00397a' }} w="full" onClick={handleNameSave} isLoading={nameLoading} isDisabled={!editName.trim() || editName === user?.name} mb={3}>Ï†ÄÏû•</Button>
            <Button variant="outline" colorScheme="orange" w="full" onClick={() => { setIsNameModalOpen(false); setIsPasswordModalOpen(true); }}>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</Button>
          </ModalBody>
        </ModalContent>
      </Modal>
      
      {/* ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ */}
      <Modal isOpen={isPasswordModalOpen} onClose={() => setIsPasswordModalOpen(false)} isCentered size="sm">
        <ModalOverlay />
        <ModalContent>
          <ModalBody p={6}>
            <FormControl mb={4}>
              <FormLabel>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</FormLabel>
              <Input 
                type="password" 
                value={newPassword} 
                onChange={e => setNewPassword(e.target.value)} 
                placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
              />
            </FormControl>
            <FormControl mb={4}>
              <FormLabel>ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</FormLabel>
              <Input 
                type="password" 
                value={confirmPassword} 
                onChange={e => setConfirmPassword(e.target.value)} 
                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
              />
            </FormControl>
            {passwordError && <Text color="red.500" mb={2}>{passwordError}</Text>}
            <Button bg="#004ea8" color="white" _hover={{ bg: '#00397a' }} w="full" onClick={handlePasswordChange} isLoading={passwordLoading} isDisabled={!newPassword.trim() || !confirmPassword.trim()}>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</Button>
          </ModalBody>
        </ModalContent>
      </Modal>
    </>
  );
} 