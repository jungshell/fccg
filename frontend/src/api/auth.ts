// ê³µí†µ API í´ë¼ì´ì–¸íŠ¸ (í”„ë¡ íŠ¸ ì „ì—­ì—ì„œ ì‚¬ìš©)
import { API_ENDPOINTS } from '../constants';
import { getApiBaseUrl, getApiUrl } from '../config/api';

// ===== íƒ€ì… =====
export type Role = 'SUPER_ADMIN' | 'ADMIN' | 'MEMBER' | 'GUEST';
export type MemberStatus = 'ACTIVE' | 'INACTIVE' | 'SUSPENDED' | 'DELETED';

export interface Member {
  id: number;
  name: string;
  email?: string;
  role?: Role;
  status?: MemberStatus;
}

export interface Game {
  id: number;
  date: string;
  time?: string;
  location?: string;
  gameType?: string;
  autoGenerated?: boolean;
  confirmed?: boolean;
  memberNames?: string[] | string;
}

export interface StatsSummary {
  totalMembers: number;
  confirmedGames: number;
  totalGames: number;
  activeVotePeriod?: string;
}

// ===== í† í° ìœ í‹¸ =====
export const getValidToken = (): string | null => {
  const s = typeof window !== 'undefined' ? window.sessionStorage.getItem('token') : null;
  const l = typeof window !== 'undefined' ? window.localStorage.getItem('token') : null;
  return s || l;
};

const authHeaders = () => {
  const token = getValidToken();
  return token ? { Authorization: `Bearer ${token}` } : {};
};

const request = async <T = any>(path: string, init: RequestInit = {}): Promise<T> => {
  const url = await getApiUrl(path);
  
  // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  try {
    const res = await fetch(url, {
      headers: { 'Content-Type': 'application/json', ...authHeaders(), ...(init.headers || {}) },
      ...init,
      signal: controller.signal,
    });
    
    clearTimeout(timeoutId);
    
    if (!res.ok) {
      const errorText = await res.text();
      let errorData;
      try {
        errorData = JSON.parse(errorText);
      } catch {
        errorData = { error: errorText || 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
      }
      const error = new Error(errorData.error || errorData.message || 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      (error as any).response = { status: res.status, data: errorData };
      throw error;
    }
    const ct = res.headers.get('content-type') || '';
    return (ct.includes('application/json') ? (await res.json()) : (await res.text())) as T;
  } catch (error: any) {
    clearTimeout(timeoutId);
    
    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
    if (error.name === 'AbortError' || error.message.includes('aborted')) {
      const timeoutError = new Error('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      (timeoutError as any).response = { status: 408, data: { error: 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼' } };
      throw timeoutError;
    }
    
    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      const networkError = new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      (networkError as any).response = { status: 0, data: { error: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜' } };
      throw networkError;
    }
    
    // ê¸°íƒ€ ì˜¤ë¥˜ëŠ” ê·¸ëŒ€ë¡œ throw
    throw error;
  }
};

// ===== ì¸ì¦ =====
export const login = (email: string, password: string) =>
  request<{ token: string; user: any }>('/login', { method: 'POST', body: JSON.stringify({ email, password }) });

export const register = async (data: { name: string; email: string; password: string; phone?: string }) => {
  const body = { name: data.name, email: data.email, password: data.password, phone: data.phone || null };
  console.log('ğŸ” register API í˜¸ì¶œ ì‹œì‘:', { 
    url: '/register', 
    body: { ...body, password: body.password ? '***' : undefined }
  });
  
  try {
    const url = await getApiUrl('/register');
    console.log('ğŸ” register API URL:', url);
    
    const result = await request<{ token?: string; user: any; message?: string }>('/register', { 
      method: 'POST', 
      body: JSON.stringify(body) 
    });
    
    console.log('âœ… register API ì‘ë‹µ ì„±ê³µ:', result);
    return result;
  } catch (error) {
    console.error('âŒ register API ì˜¤ë¥˜:', error);
    throw error;
  }
};

export const updateProfile = (data: Partial<Member>) =>
  request('/profile', { method: 'PUT', body: JSON.stringify(data) });

export const changePassword = (newPassword: string) =>
  request('/change-password', {
    method: 'PUT',
    body: JSON.stringify({ newPassword }),
  });

export const getProfile = () => request('/profile');

// ===== ë©¤ë²„ ê´€ë¦¬ =====
export const getMemberStats = () => request('/activity-analysis');

export const updateMember = (memberId: number, data: Partial<Member>) =>
  request(`/members/${memberId}`, { method: 'PUT', body: JSON.stringify(data) });

export const deleteMember = (memberId: number) =>
  request(`/members/${memberId}`, { method: 'DELETE' });

export const resetMemberPassword = (memberId: number) =>
  request(`/members/${memberId}/reset-password`, { method: 'POST' });

// ===== íˆ¬í‘œ/ì¼ì • =====
export const getUnifiedVoteDataNew = () => request('/unified-vote-data');

export const getAdminVoteSessionsSummary = () => request('/votes/sessions/summary');

export const getSavedVoteResults = (sessionId: number) => 
  request(`/votes/results?sessionId=${sessionId}`);

export const aggregateAndSaveVoteResults = (payload: any) =>
  request('/votes/aggregate/save', { method: 'POST', body: JSON.stringify(payload) });

export const closeVoteSession = (id: number) =>
  request(`/vote-sessions/${id}/close`, { method: 'POST' });

export const resumeVoteSession = (id: number) =>
  request(`/vote-sessions/${id}/resume`, { method: 'POST' });

export const deleteVoteSession = (id: number) =>
  request(`/vote-sessions/${id}`, { method: 'DELETE' });

export const bulkDeleteVoteSessions = (ids: number[]) =>
  request('/cleanup-duplicate-sessions', { method: 'POST', body: JSON.stringify({ ids }) });

export const renumberVoteSessions = () =>
  request('/cleanup-duplicate-sessions', { method: 'POST' });

export const cleanupDuplicateSessions = () =>
  request('/cleanup-duplicate-sessions', { method: 'POST' });

export const startWeeklyVote = () => request('/start-weekly-vote', { method: 'POST' });

// ì‚¬ìš©ì íˆ¬í‘œ ì‚­ì œ (ì¬íˆ¬í‘œìš©)
export const deleteVote = (userId: number) =>
  request(`/votes/${userId}`, { method: 'DELETE' });

// ===== ê¸°íƒ€ ìœ í‹¸ =====
export const apiGet = request;