"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
require("dotenv/config");
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const auth_simple_1 = __importDefault(require("./routes/auth_simple"));
const holiday_1 = __importDefault(require("./routes/holiday"));
const body_parser_1 = __importDefault(require("body-parser"));
const axios_1 = __importDefault(require("axios"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const client_1 = require("@prisma/client");
const app = (0, express_1.default)();
const PORT = process.env.PORT || 4000;
const prisma = new client_1.PrismaClient();
console.log('ì„œë²„ ì‹œì‘');
// JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
const authenticateToken = (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    if (!token) {
        return res.status(401).json({ message: 'ì•¡ì„¸ìŠ¤ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }
    jsonwebtoken_1.default.verify(token, process.env.JWT_SECRET || 'fc-chalggyeo-secret', (err, user) => {
        if (err) {
            return res.status(403).json({ message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.' });
        }
        req.user = user;
        next();
    });
};
// ë¯¸ë“¤ì›¨ì–´
app.use((0, cors_1.default)());
// app.use(express.json()); // ê¸°ì¡´ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬
app.use(body_parser_1.default.json()); // body-parserë¡œ ëŒ€ì²´
// ë¼ìš°íŠ¸ - authRoutes ì‚¬ìš© (ì§ì ‘ êµ¬í˜„í•œ APIë³´ë‹¤ ë¨¼ì € ë“±ë¡)
console.log('authRoutes ë“±ë¡ ì‹œì‘');
app.use('/api/auth', auth_simple_1.default);
console.log('authRoutes ë“±ë¡ ì™„ë£Œ');
// ê³µíœ´ì¼ API ë¼ìš°íŠ¸ ë“±ë¡
console.log('holidayRoutes ë“±ë¡ ì‹œì‘');
app.use('/api/holiday', holiday_1.default);
console.log('holidayRoutes ë“±ë¡ ì™„ë£Œ');
// ì•ˆì „ë§ ë¼ìš°íŠ¸ ì œê±°: authRoutesì—ì„œ ëª¨ë“  ê²½ë¡œë¥¼ ì²˜ë¦¬
// ë¼ìš°íŠ¸ëŠ” ëª¨ë‘ authRoutesì—ì„œ ì²˜ë¦¬ (ì¤‘ë³µ ë“±ë¡ ì œê±°)
// í†µí•© íšŒì› ë° ê²½ê¸° ì •ë³´ ì¡°íšŒ API
app.get('/api/auth/members', async (req, res) => {
    try {
        console.log('ğŸ” í†µí•© API í˜¸ì¶œ - íšŒì› ë° ê²½ê¸° ì •ë³´ ì¡°íšŒ');
        const { PrismaClient } = require('@prisma/client');
        const prisma = new PrismaClient();
        // ëª¨ë“  íšŒì› ì¡°íšŒ (ì™„ì „í•œ ì •ë³´ í¬í•¨)
        const members = await prisma.user.findMany({
            select: {
                id: true,
                name: true,
                email: true,
                role: true,
                status: true,
                attendance: true,
                createdAt: true,
                updatedAt: true,
                lastLoginAt: true,
                statusChangedAt: true,
                statusChangeReason: true
            },
            orderBy: {
                createdAt: 'desc'
            }
        });
        // ëª¨ë“  ê²½ê¸° ì¡°íšŒ
        const games = await prisma.game.findMany({
            select: {
                id: true,
                date: true,
                location: true,
                gameType: true,
                eventType: true,
                mercenaryCount: true,
                memberNames: true,
                selectedMembers: true,
                autoGenerated: true,
                confirmed: true,
                createdById: true,
                createdAt: true,
                updatedAt: true
            },
            orderBy: {
                date: 'asc'
            }
        });
        console.log('âœ… í†µí•© ë°ì´í„° ì¡°íšŒ ì„±ê³µ:', members.length, 'ëª… íšŒì›,', games.length, 'ê²½ê¸°');
        console.log('ğŸ“‹ ì²« ë²ˆì§¸ íšŒì› ë°ì´í„°:', {
            id: members[0]?.id,
            name: members[0]?.name,
            email: members[0]?.email,
            createdAt: members[0]?.createdAt
        });
        const response = {
            members,
            games,
            totalMembers: members.length,
            totalGames: games.length,
            activeMembers: members.filter(m => m.status === 'ACTIVE').length
        };
        console.log('ğŸ“¤ ì‘ë‹µ ë°ì´í„° êµ¬ì¡°:', {
            membersCount: response.members.length,
            gamesCount: response.games.length,
            firstMemberFields: Object.keys(response.members[0] || {})
        });
        res.json(response);
        await prisma.$disconnect();
    }
    catch (error) {
        console.error('âŒ í†µí•© ë°ì´í„° ì¡°íšŒ API ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// ì¤‘ë³µ/ì§ì ‘ ë¼ìš°íŠ¸ ì œê±°: í†µí•© ë° ê²°ê³¼ APIëŠ” ëª¨ë‘ authRoutesì—ì„œ ì²˜ë¦¬
// í”„ë¡œí•„ ì¡°íšŒ API
app.get('/api/auth/profile', authenticateToken, async (req, res) => {
    try {
        const userId = req.user.userId;
        console.log('ğŸ” ì§ì ‘ ë“±ë¡ëœ /api/auth/profile í˜¸ì¶œë¨, userId:', userId);
        const { PrismaClient } = require('@prisma/client');
        const prisma = new PrismaClient();
        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: {
                id: true,
                email: true,
                name: true,
                role: true,
                phone: true,
                avatarUrl: true,
                status: true,
                createdAt: true,
                updatedAt: true
            }
        });
        if (!user) {
            await prisma.$disconnect();
            return res.status(404).json({ error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
        }
        // íˆ¬í‘œ ì°¸ì—¬ ìƒì„¸ ì •ë³´ ê³„ì‚° (ì§ì ‘ êµ¬í˜„)
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(process.cwd(), 'voteData.json');
        let voteData = [];
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            voteData = JSON.parse(data);
        }
        // ì£¼ê°„ íˆ¬í‘œ ì°½(ì›” 00:01 ~ ëª© 17:00) ê³„ì‚° - ë§¤ì£¼ ë™ì¼ ê·œì¹™
        const now = new Date();
        const currentWeekStart = new Date(now);
        // getDay(): ì¼0 ì›”1 ... í† 6 â†’ ì´ë²ˆì£¼ ì›”ìš”ì¼ë¡œ ì´ë™
        const dow = currentWeekStart.getDay();
        const deltaToMonday = dow === 0 ? -6 : (1 - dow);
        currentWeekStart.setDate(currentWeekStart.getDate() + deltaToMonday);
        currentWeekStart.setHours(0, 1, 0, 0); // ì›”ìš”ì¼ 00:01
        const currentWeekEnd = new Date(currentWeekStart);
        currentWeekEnd.setDate(currentWeekStart.getDate() + 3); // ëª©ìš”ì¼
        currentWeekEnd.setHours(17, 0, 0, 0); // ëª©ìš”ì¼ 17:00
        // í˜„ì¬ ë‚ ì§œê°€ ëª©ìš”ì¼ 17:00 ì´í›„ë¼ë©´ ë‹¤ìŒ ì£¼ íˆ¬í‘œ ì°½ìœ¼ë¡œ í™•ì¥
        if (now > currentWeekEnd) {
            // ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ë¶€í„° ëª©ìš”ì¼ê¹Œì§€ë¡œ í™•ì¥
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() + 7);
        }
        // í™œì„± íˆ¬í‘œ ì„¸ì…˜ í™•ì¸ (í˜„ì¬ ì£¼ ë˜ëŠ” ë‹¤ìŒ ì£¼)
        const activeVoteSessions = new Set(voteData.map((vote) => vote.sessionId));
        const userVotes = voteData.filter((vote) => vote.userId === userId);
        // ì‚¬ìš©ìê°€ ì´ë²ˆ ì£¼ íˆ¬í‘œ ì°½ ë‚´ì—ì„œ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸
        const recentUserVotes = userVotes.filter((vote) => {
            const voteDate = new Date(vote.timestamp);
            return voteDate >= currentWeekStart && voteDate < currentWeekEnd;
        });
        console.log('íˆ¬í‘œ ë°ì´í„° ê³„ì‚°:', {
            userId,
            totalVotes: voteData.length,
            userVotes: userVotes.length,
            recentUserVotes: recentUserVotes.length,
            activeSessions: Array.from(activeVoteSessions),
            weekRange: `${currentWeekStart.toISOString().split('T')[0]} ~ ${currentWeekEnd.toISOString().split('T')[0]}`
        });
        // í—¤ë” íˆ¬í‘œìœ¨ ê³„ì‚° - DB ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ ê³„ì‚°
        const prismaClient = new PrismaClient();
        const totalVoteSessions = await prismaClient.voteSession.count();
        const participatedSessions = await prismaClient.vote.count({ where: { userId } });
        // ì„¸ì…˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ (íˆ¬í‘œìœ¨ ê·¼ê±° ì œê³µ)
        const allSessions = await prismaClient.voteSession.findMany({
            orderBy: { createdAt: 'desc' },
            include: { votes: { where: { userId } } }
        });
        const sessionDetails = allSessions.map((session) => ({
            id: session.id,
            weekStartDate: session.weekStartDate,
            isActive: session.isActive,
            isCompleted: session.isCompleted,
            userParticipated: session.votes.length > 0,
            createdAt: session.createdAt
        }));
        const voteDetails = {
            total: totalVoteSessions,
            participated: participatedSessions,
            missed: Math.max(0, totalVoteSessions - participatedSessions),
            sessions: sessionDetails
        };
        // ë””ë²„ê·¸ ë¡œê·¸ (ì „ì²´ íˆ¬í‘œ ì„¸ì…˜ ê¸°ì¤€)
        console.log('ì „ì²´ íˆ¬í‘œ ì„¸ì…˜ ê¸°ì¤€(DB):', {
            totalVoteSessions,
            participatedSessions,
            sessionDetails: sessionDetails.map((s) => ({
                id: s.id,
                weekStart: s.weekStartDate,
                participated: s.userParticipated,
                status: s.isActive ? 'active' : (s.isCompleted ? 'completed' : 'pending')
            }))
        });
        // í—¤ë” íˆ¬í‘œìœ¨: ì „ì²´ íˆ¬í‘œ ì„¸ì…˜ ì¤‘ ì°¸ì—¬í•œ ë¹„ìœ¨
        const voteAttendance = totalVoteSessions > 0 ? Math.round((participatedSessions / totalVoteSessions) * 100) : 0;
        // ê²½ê¸° ì°¸ì—¬ ìƒì„¸ ì •ë³´ ê³„ì‚° (ì§ì ‘ êµ¬í˜„)
        const allGames = await prismaClient.game.findMany();
        const participatedGames = allGames.filter((game) => {
            try {
                const memberNames = JSON.parse(game.memberNames || '[]');
                const selectedMembers = JSON.parse(game.selectedMembers || '[]');
                return memberNames.includes(user.name) || selectedMembers.includes(user.name);
            }
            catch (error) {
                return false;
            }
        });
        const gameDetails = {
            total: allGames.length,
            participated: participatedGames.length,
            missed: Math.max(0, allGames.length - participatedGames.length)
        };
        console.log('íˆ¬í‘œìœ¨ ê³„ì‚°:', {
            total: voteDetails.total,
            participated: voteDetails.participated,
            voteAttendance
        });
        // ê²½ê¸° ì°¸ì—¬ìœ¨ ê³„ì‚°
        const gameAttendance = gameDetails.total > 0 ?
            Math.round((gameDetails.participated / gameDetails.total) * 100) : 0;
        const profileData = {
            ...user,
            voteAttendance,
            attendance: gameAttendance,
            voteDetails,
            gameDetails
        };
        console.log('âœ… í”„ë¡œí•„ ì¡°íšŒ ì„±ê³µ:', profileData);
        res.json(profileData);
        await prismaClient.$disconnect();
    }
    catch (error) {
        console.error('âŒ í”„ë¡œí•„ ì¡°íšŒ ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'í”„ë¡œí•„ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// íˆ¬í‘œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
function loadVoteData() {
    try {
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(process.cwd(), 'backend/voteData.json');
        console.log('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ ê²½ë¡œ:', voteDataPath);
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            const parsedData = JSON.parse(data);
            console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', parsedData.length, 'ê°œ');
            return parsedData;
        }
        else {
            console.log('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ:', voteDataPath);
            return [];
        }
    }
    catch (error) {
        console.error('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
        return [];
    }
}
// íˆ¬í‘œ ë°ì´í„° API
app.get('/api/votes', (req, res) => {
    try {
        console.log('ğŸ” íˆ¬í‘œ ë°ì´í„° API í˜¸ì¶œë¨');
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(process.cwd(), 'voteData.json');
        console.log('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ ê²½ë¡œ:', voteDataPath);
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            const parsedData = JSON.parse(data);
            console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', parsedData.length, 'ê°œ');
            res.json(parsedData);
        }
        else {
            console.log('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ:', voteDataPath);
            res.json([]);
        }
    }
    catch (error) {
        console.error('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'íˆ¬í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }
});
// ë©¤ë²„ í†µê³„ API
app.get('/api/auth/members/stats', authenticateToken, async (req, res) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        // ì „ì²´ ë©¤ë²„ ìˆ˜
        const totalMembers = await prisma.user.count({
            where: { status: 'ACTIVE' }
        });
        // í™œì„± ë©¤ë²„ ìˆ˜
        const activeMembers = await prisma.user.count({
            where: { status: 'ACTIVE' }
        });
        // ì´ë²ˆ ì£¼ ê²½ê¸° ìˆ˜
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay() + 1); // ì›”ìš”ì¼
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // ì¼ìš”ì¼
        const thisWeekGames = await prisma.game.count({
            where: {
                date: {
                    gte: startOfWeek,
                    lte: endOfWeek
                }
            }
        });
        // ë‹¤ìŒ ì£¼ íˆ¬í‘œ ì„¸ì…˜
        const nextWeekVote = await prisma.voteSession.findFirst({
            where: {
                isActive: true
            }
        });
        const stats = {
            totalMembers,
            activeMembers,
            thisWeekGames,
            nextWeekVote: nextWeekVote ? {
                id: nextWeekVote.id,
                weekStartDate: nextWeekVote.weekStartDate,
                endTime: nextWeekVote.endTime,
                isActive: nextWeekVote.isActive
            } : null
        };
        console.log('ğŸ“Š ë©¤ë²„ í†µê³„ ì¡°íšŒ:', stats);
        res.json(stats);
    }
    catch (error) {
        console.error('âŒ ë©¤ë²„ í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// íˆ¬í‘œ ì¬ì„¤ì • API (ì¸ì¦ í•„ìš”)
app.delete('/api/votes/reset', authenticateToken, async (req, res) => {
    try {
        const userId = req.user?.userId;
        console.log('ğŸ—‘ï¸ íˆ¬í‘œ ì¬ì„¤ì • API í˜¸ì¶œë¨:', { userId });
        if (!userId) {
            return res.status(401).json({ error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        // íˆ¬í‘œ ë°ì´í„° íŒŒì¼ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ íˆ¬í‘œ ì‚­ì œ
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(process.cwd(), 'voteData.json');
        let voteData = [];
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            voteData = JSON.parse(data);
        }
        // í•´ë‹¹ ì‚¬ìš©ìì˜ íˆ¬í‘œ ë°ì´í„° ì‚­ì œ
        const originalLength = voteData.length;
        voteData = voteData.filter(vote => vote.userId !== userId);
        const deletedCount = originalLength - voteData.length;
        // íŒŒì¼ì— ì €ì¥
        fs.writeFileSync(voteDataPath, JSON.stringify(voteData, null, 2));
        console.log('âœ… íˆ¬í‘œ ì¬ì„¤ì • ì„±ê³µ:', { userId, deletedCount });
        res.json({ message: 'íˆ¬í‘œê°€ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', deletedCount });
    }
    catch (error) {
        console.error('âŒ íˆ¬í‘œ ì¬ì„¤ì • ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'íˆ¬í‘œ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// íˆ¬í‘œ ì œì¶œ API (ì¸ì¦ í•„ìš”) - ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
app.post('/api/votes', authenticateToken, async (req, res) => {
    try {
        const userId = req.user?.userId;
        const { selectedDays, timestamp } = req.body;
        console.log('ğŸ—³ï¸ íˆ¬í‘œ ì œì¶œ API í˜¸ì¶œë¨:', {
            userId,
            selectedDays,
            timestamp,
            userFromToken: req.user
        });
        if (!userId) {
            console.log('âŒ íˆ¬í‘œ ì œì¶œ ì‹¤íŒ¨: userId ì—†ìŒ');
            return res.status(401).json({ error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        if (!selectedDays || !Array.isArray(selectedDays)) {
            return res.status(400).json({ error: 'ì„ íƒëœ ë‚ ì§œê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        console.log('ğŸ—³ï¸ íˆ¬í‘œ ì œì¶œ:', { userId, selectedDays, timestamp });
        const prismaClient = new client_1.PrismaClient();
        // 1. í˜„ì¬ í™œì„± íˆ¬í‘œ ì„¸ì…˜ ì°¾ê¸°
        const activeSession = await prismaClient.voteSession.findFirst({
            where: {
                isActive: true,
                isCompleted: false
            }
        });
        if (!activeSession) {
            await prismaClient.$disconnect();
            return res.status(400).json({ error: 'í™œì„± íˆ¬í‘œ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.' });
        }
        // 2. ê¸°ì¡´ íˆ¬í‘œê°€ ìˆëŠ”ì§€ í™•ì¸
        const existingVote = await prismaClient.vote.findFirst({
            where: {
                userId: userId,
                voteSessionId: activeSession.id
            }
        });
        let voteResult;
        if (existingVote) {
            // ê¸°ì¡´ íˆ¬í‘œ ì—…ë°ì´íŠ¸
            voteResult = await prismaClient.vote.update({
                where: { id: existingVote.id },
                data: {
                    selectedDays: JSON.stringify(selectedDays),
                    updatedAt: new Date()
                }
            });
            console.log('âœ… ê¸°ì¡´ íˆ¬í‘œ ì—…ë°ì´íŠ¸:', voteResult);
        }
        else {
            // ìƒˆë¡œìš´ íˆ¬í‘œ ìƒì„±
            voteResult = await prismaClient.vote.create({
                data: {
                    userId: userId,
                    voteSessionId: activeSession.id,
                    selectedDays: JSON.stringify(selectedDays),
                    createdAt: new Date(),
                    updatedAt: new Date()
                }
            });
            console.log('âœ… ìƒˆë¡œìš´ íˆ¬í‘œ ìƒì„±:', voteResult);
        }
        // 3. íŒŒì¼ì—ë„ ë°±ì—… ì €ì¥ (í˜¸í™˜ì„± ìœ ì§€)
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(process.cwd(), 'voteData.json');
        let voteData = [];
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            voteData = JSON.parse(data);
        }
        // ê¸°ì¡´ íˆ¬í‘œ ì œê±° í›„ ìƒˆ íˆ¬í‘œ ì¶”ê°€
        voteData = voteData.filter((vote) => vote.userId !== userId);
        voteData.push({
            id: voteResult.id,
            userId: userId,
            selectedDays: selectedDays,
            timestamp: voteResult.createdAt.toISOString(),
            sessionId: activeSession.id
        });
        fs.writeFileSync(voteDataPath, JSON.stringify(voteData, null, 2));
        await prismaClient.$disconnect();
        console.log('âœ… íˆ¬í‘œ ë°ì´í„° ì €ì¥ ì„±ê³µ (DB + íŒŒì¼):', voteResult);
        res.json({
            message: 'íˆ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
            vote: {
                id: voteResult.id,
                userId: userId,
                selectedDays: selectedDays,
                sessionId: activeSession.id,
                isUpdate: !!existingVote
            }
        });
    }
    catch (error) {
        console.error('âŒ íˆ¬í‘œ ì œì¶œ ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'íˆ¬í‘œ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
console.log('ê¸´ê¸‰ ìˆ˜ì •: ì§ì ‘ API ë“±ë¡ ì™„ë£Œ');
// authRoutes í…ŒìŠ¤íŠ¸
app.get('/api/auth-test', (req, res) => {
    res.json({ message: 'authRoutes í…ŒìŠ¤íŠ¸ ì„±ê³µ!', timestamp: new Date().toISOString() });
});
console.log('âœ… authRoutes í…ŒìŠ¤íŠ¸ ë¼ìš°íŠ¸ ë“±ë¡ ì™„ë£Œ: /api/auth-test');
// ì¤‘ë³µëœ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ íšŒì› ì¶”ê°€ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ íšŒì› ìˆ˜ì • API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ íšŒì› ì‚­ì œ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ ê¸´ê¸‰ íšŒì› ê´€ë¦¬ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì£¼ì„ ì²˜ë¦¬ëœ ì¤‘ë³µ API ì œê±°ë¨
// ì¹´ì¹´ì˜¤ë§µ ì¥ì†Œ ê²€ìƒ‰ API - ì§ì ‘ ë“±ë¡
app.get('/api/auth/search-location', async (req, res) => {
    try {
        const { query } = req.query;
        console.log('ğŸ” ì¥ì†Œ ê²€ìƒ‰ ìš”ì²­:', query);
        if (!query || typeof query !== 'string' || query.trim().length === 0) {
            console.log('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê²€ìƒ‰ì–´:', query);
            return res.status(400).json({ error: 'ìœ íš¨í•œ ê²€ìƒ‰ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        // ê²€ìƒ‰ì–´ ê¸¸ì´ ì œí•œ (ë„ˆë¬´ ê¸´ ìš”ì²­ ë°©ì§€)
        if (query.length > 100) {
            console.log('âŒ ê²€ìƒ‰ì–´ê°€ ë„ˆë¬´ ê¹€:', query.length);
            return res.status(400).json({ error: 'ê²€ìƒ‰ì–´ëŠ” 100ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.' });
        }
        // ì¹´ì¹´ì˜¤ë§µ API í‚¤ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ê¸°, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
        const KAKAO_API_KEY = process.env.KAKAO_API_KEY || '4413813ca702d0fb6239ae38d9202d7e';
        if (!KAKAO_API_KEY) {
            console.log('âŒ ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
            return res.status(500).json({ error: 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
        }
        console.log('ğŸŒ ì¹´ì¹´ì˜¤ë§µ API í˜¸ì¶œ ì‹œì‘...');
        console.log('ğŸ“¡ ìš”ì²­ URL:', 'https://dapi.kakao.com/v2/local/search/keyword.json');
        console.log('ğŸ“ ê²€ìƒ‰ì–´:', query.toString());
        // ì¹´ì¹´ì˜¤ë§µ API í˜¸ì¶œ
        const response = await axios_1.default.get('https://dapi.kakao.com/v2/local/search/keyword.json', {
            headers: {
                'Authorization': `KakaoAK ${KAKAO_API_KEY}`
            },
            params: {
                query: query.toString(),
                size: 10
            }
        });
        console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ì‘ë‹µ ì„±ê³µ:', response.status);
        console.log('ğŸ“Š ê²€ìƒ‰ ê²°ê³¼ ìˆ˜:', response.data.documents?.length || 0);
        res.json(response.data);
    }
    catch (error) {
        console.error('âŒ ì¥ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        if (error.response) {
            console.error('ğŸš« API ì‘ë‹µ ì˜¤ë¥˜:', error.response.status, error.response.data);
        }
        res.status(500).json({ error: 'ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// ê²½ê¸° ê´€ë¦¬ API
// ì¤‘ë³µëœ ê²½ê¸° ìƒì„± API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ê²Œì„ ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œëŠ” authRoutes(auth_simple)ì—ì„œë§Œ ì²˜ë¦¬ (ì¤‘ë³µ ì œê±°)
// ì¤‘ë³µëœ ê²½ê¸° ì‚­ì œ/ìë™ìƒì„± API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ ê²½ê¸° ìˆ˜ì • API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ APIëŠ” authControllerì—ì„œ ì²˜ë¦¬
// ì¤‘ë³µëœ í”„ë¡œí•„ ìˆ˜ì • API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ë¡œê·¸ì¸ ë¼ìš°íŠ¸ - authRoutesë¡œ ì´ë™ë¨
// app.post('/api/auth/login', ...
// ìë™í™” ê¸°ëŠ¥ ì œê±°ë¨ - ìˆ˜ë™ ê´€ë¦¬ë¡œ ì „í™˜
// ìë™í™” ê¸°ëŠ¥ ì œê±°ë¨ - ìˆ˜ë™ ê´€ë¦¬ë¡œ ì „í™˜
// ëŒ€ì‹œë³´ë“œ í†µê³„ API ì¶”ê°€
// ì¤‘ë³µëœ í†µê³„ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ API ì œê±°ë¨ - /api/auth/membersë¡œ í†µí•©
// ì¤‘ë³µëœ í†µí•© API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ì¤‘ë³µëœ í”„ë¡œí•„ API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// íˆ¬í‘œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
function loadVoteData() {
    try {
        const fs = require('fs');
        const path = require('path');
        const voteDataPath = path.join(__dirname, 'voteData.json');
        if (fs.existsSync(voteDataPath)) {
            const data = fs.readFileSync(voteDataPath, 'utf8');
            return JSON.parse(data);
        }
        else {
            return [];
        }
    }
    catch (error) {
        console.error('íˆ¬í‘œ ë°ì´í„° íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
        return [];
    }
}
// íˆ¬í‘œ ë°ì´í„° API
// ì¤‘ë³µëœ íˆ¬í‘œ ë°ì´í„° API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// íšŒì› ìƒíƒœ ìë™ ì²´í¬ API
app.post('/api/admin/check-member-status', authenticateToken, async (req, res) => {
    try {
        const userId = req.user?.userId;
        const user = await prisma.user.findUnique({ where: { id: userId } });
        if (!user || (user.role !== 'ADMIN' && user.role !== 'SUPER_ADMIN')) {
            return res.status(403).json({ error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        const { checkMemberStatusRules } = require('./controllers/authController');
        await checkMemberStatusRules();
        res.json({ message: 'íšŒì› ìƒíƒœ ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }
    catch (error) {
        console.error('íšŒì› ìƒíƒœ ì²´í¬ API ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'íšŒì› ìƒíƒœ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
console.log('âœ… íšŒì› ìƒíƒœ ì²´í¬ API ë“±ë¡ ì™„ë£Œ: /api/admin/check-member-status');
console.log('âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API ë“±ë¡ ì™„ë£Œ: /api/auth/change-password');
// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
app.put('/api/auth/change-password', authenticateToken, async (req, res) => {
    try {
        const userId = req.user?.userId;
        const { newPassword } = req.body;
        if (!userId) {
            return res.status(401).json({ error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        }
        if (!newPassword || newPassword.length < 6) {
            return res.status(400).json({ error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' });
        }
        const bcrypt = require('bcrypt');
        const hashedPassword = await bcrypt.hash(newPassword, 10);
        const updatedUser = await prisma.user.update({
            where: { id: userId },
            data: { password: hashedPassword }
        });
        res.json({
            message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.',
            user: {
                id: updatedUser.id,
                email: updatedUser.email,
                name: updatedUser.name,
                role: updatedUser.role
            }
        });
    }
    catch (error) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
        res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    }
});
// ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ API
app.get('/api/test', (req, res) => {
    res.json({ message: 'í…ŒìŠ¤íŠ¸ APIê°€ ì‘ë™í•©ë‹ˆë‹¤!', timestamp: new Date().toISOString() });
});
console.log('âœ… í…ŒìŠ¤íŠ¸ API ë“±ë¡ ì™„ë£Œ: /api/test');
// ë¡œê·¸ì¸ API ì§ì ‘ êµ¬í˜„
// ì¤‘ë³µëœ ë¡œê·¸ì¸/íšŒì›ê°€ì… API ì œê±° - authRoutesì—ì„œ ì œê³µë¨
// ìë™í™” ê¸°ëŠ¥ ì œê±°ë¨ - ìˆ˜ë™ ê´€ë¦¬ë¡œ ì „í™˜
console.log('âœ… íšŒì› ìƒíƒœ ìë™ ì²´í¬ ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • ì™„ë£Œ: ë§¤ì¼ ì˜¤ì „ 9ì‹œ');
// ì¤‘ë³µëœ ê²½ê¸° ìˆ˜ì •/ì‚­ì œ API ì œê±°ë¨ (auth_simple ì‚¬ìš©)
app.listen(PORT, () => {
    console.log(`ì„œë²„ê°€ ${PORT}ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘`);
});
