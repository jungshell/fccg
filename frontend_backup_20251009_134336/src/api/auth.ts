import axios from 'axios';

// API ìž¬ì‹œë„ ë¡œì§ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const retryRequest = async (requestFn: () => Promise<any>, maxRetries = 3, delay = 1000) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await requestFn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ì—°ê²° ê±°ë¶€ ì˜¤ë¥˜ì¸ ê²½ìš°ì—ë§Œ ìž¬ì‹œë„
      if ((error as any).code === 'ERR_NETWORK' || (error as any).code === 'ERR_CONNECTION_REFUSED') {
        console.log(`API ìž¬ì‹œë„ ${i + 1}/${maxRetries}...`);
        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
      } else {
        throw error;
      }
    }
  }
};

// íƒ€ìž… ì •ì˜
export interface Game {
  id: number;
  date: string;
  time: string;
  location: string;
  eventType: string;
  gameType: string;
  mercenaryCount: number;
  memberNames: string[];
  selectedMembers: string[];
  autoGenerated: boolean;
  confirmed: boolean;
  createdById: number;
  createdBy?: {
    id: number;
    name: string;
  };
  createdAt: string;
  updatedAt: string;
}

export interface Member {
  id: number;
  name: string;
  email: string;
  role: string;
  status: string;
  attendance: number;
  createdAt: string;
  updatedAt: string;
  lastLoginAt?: string;
  statusChangedAt?: string;
  statusChangeReason?: string;
}

export interface StatsSummary {
  totalMembers: number;
  activeMembers: number;
  thisWeekGames: number;
  nextWeekVote: {
    id: number;
    weekStartDate: string;
    endTime: string;
    isActive: boolean;
  };
}

// API í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
const apiClient = axios.create({
  baseURL: 'http://localhost:4000/api/auth',
  headers: {
    'Content-Type': 'application/json',
  },
});

// ìš”ì²­ ì¸í„°ì…‰í„° - í† í° ìžë™ ì¶”ê°€
apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// ì‘ë‹µ ì¸í„°ì…‰í„° - í† í° ë§Œë£Œ ì²˜ë¦¬
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

// í† í° ìœ íš¨ì„± ê²€ì¦ ë° ê°±ì‹ 
export const getValidToken = async () => {
  let token = localStorage.getItem('token');
  
  if (!token) {
    console.error('âŒ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
    throw new Error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  try {
    console.log('ðŸ” í† í° ìœ íš¨ì„± ê²€ì¦ ì‹œìž‘...');
    // í† í° ìœ íš¨ì„± ê²€ì¦ (ìž¬ì‹œë„ ë¡œì§ ì ìš©)
    await retryRequest(() => apiClient.get('/verify-token'));
    console.log('âœ… í† í° ìœ íš¨ì„± ê²€ì¦ ì„±ê³µ');
    return token;
  } catch (error) {
    console.error('âŒ í† í° ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨:', error);
    
    // í† í°ì´ ë§Œë£Œëœ ê²½ìš° ê°±ì‹  ì‹œë„
    if ((error as any).response?.status === 401) {
      console.log('ðŸ”„ í† í° ê°±ì‹  ì‹œë„...');
      try {
        const refreshResponse = await retryRequest(() => 
          apiClient.post('/refresh-token', {}, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
        );
        
        const newToken = refreshResponse.data.token;
        localStorage.setItem('token', newToken);
        console.log('âœ… í† í° ê°±ì‹  ì„±ê³µ');
        return newToken;
      } catch (refreshError) {
        console.error('âŒ í† í° ê°±ì‹  ì‹¤íŒ¨:', refreshError);
        localStorage.removeItem('token');
        throw new Error('í† í° ê°±ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      }
    }
    
    // ë‹¤ë¥¸ ì˜¤ë¥˜ì˜ ê²½ìš°
    localStorage.removeItem('token');
    
    if ((error as any).response?.status === 404) {
      throw new Error('í† í° ê²€ì¦ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } else {
      throw new Error('í† í° ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
};

// ì¸ì¦ ê´€ë ¨ API
export const login = async (email: string, password: string) => {
  const response = await apiClient.post('/login', { email, password });
  return response.data;
};

export const register = async (userData: any) => {
  const response = await apiClient.post('/register', userData);
  return response.data;
};

export const logout = async () => {
  const response = await apiClient.post('/logout');
  return response.data;
};

export const verifyToken = async () => {
  const response = await apiClient.get('/verify-token');
  return response.data;
};

// íšŒì› ê´€ë¦¬ API
export const getMembers = async () => {
  const response = await apiClient.get('/members');
  return response.data;
};

export const createMember = async (memberData: any) => {
  const response = await apiClient.post('/members', memberData);
  return response.data;
};

export const updateMember = async (id: number, memberData: any) => {
  const response = await apiClient.put(`/members/${id}`, memberData);
  return response.data;
};

export const deleteMember = async (id: number) => {
  const response = await apiClient.delete(`/members/${id}`);
  return response.data;
};

// ê²½ê¸° ê´€ë¦¬ API
export const getGames = async () => {
  const response = await apiClient.get('/games');
  return response.data;
};

export const createGame = async (gameData: any) => {
  const response = await apiClient.post('/games', gameData);
  return response.data;
};

export const updateGame = async (id: number, gameData: any) => {
  const response = await apiClient.put(`/games/${id}`, gameData);
  return response.data;
};

export const deleteGame = async (id: number) => {
  const response = await apiClient.delete(`/games/${id}`);
  return response.data;
};

// íˆ¬í‘œ ê´€ë ¨ API
export const getVoteSessions = async () => {
  const response = await apiClient.get('/vote-sessions');
  return response.data;
};

export const createVoteSession = async (sessionData: any) => {
  const response = await apiClient.post('/vote-sessions', sessionData);
  return response.data;
};

export const updateVoteSession = async (id: number, sessionData: any) => {
  const response = await apiClient.put(`/vote-sessions/${id}`, sessionData);
  return response.data;
};

export const deleteVoteSession = async (id: number) => {
  const response = await apiClient.delete(`/vote-sessions/${id}`);
  return response.data;
};

export const closeVoteSession = async (sessionId: number) => {
  const response = await apiClient.post(`/vote-sessions/${sessionId}/close`);
  return response.data;
};

export const resumeVoteSession = async (sessionId: number) => {
  const response = await apiClient.post(`/vote-sessions/${sessionId}/resume`);
  return response.data;
};

export const bulkDeleteVoteSessions = async () => {
  const response = await apiClient.delete(`/vote-sessions/bulk-delete`);
  return response.data;
};
export const renumberVoteSessions = async () => {
  const response = await apiClient.post(`/vote-sessions/renumber`);
  return response.data;
};
export const deleteVote = async (userId: number) => {
  const response = await apiClient.delete(`/votes/${userId}`);
  return response.data;
};

// íˆ¬í‘œ ë°ì´í„° API
export const getVoteData = async () => {
  const response = await apiClient.get('/vote-data');
  return response.data;
};

export const submitVote = async (voteData: any) => {
  const response = await apiClient.post('/vote', voteData);
  return response.data;
};

export const getUnifiedVoteData = async () => {
  const response = await retryRequest(() => apiClient.get('/unified-vote-data'));
  return response.data;
};

// í†µí•© ë°ì´í„° API
export const getUnifiedData = async () => {
  const response = await retryRequest(() => apiClient.get('/unified-data'));
  return response.data;
};

// ê°¤ëŸ¬ë¦¬ API
export const getGallery = async () => {
  const response = await apiClient.get('/gallery');
  return response.data;
};

export const uploadImage = async (formData: FormData) => {
  const response = await apiClient.post('/gallery/upload', formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
  });
  return response.data;
};

// ê³µì§€ì‚¬í•­ API
export const getNotices = async () => {
  const response = await apiClient.get('/notices');
  return response.data;
};

export const createNotice = async (noticeData: any) => {
  const response = await apiClient.post('/notices', noticeData);
  return response.data;
};

export const updateNotice = async (id: number, noticeData: any) => {
  const response = await apiClient.put(`/notices/${id}`, noticeData);
  return response.data;
};

export const deleteNotice = async (id: number) => {
  const response = await apiClient.delete(`/notices/${id}`);
  return response.data;
};

// í†µê³„ API
export const getStats = async () => {
  const response = await apiClient.get('/stats');
  return response.data;
};

// ê´€ë¦¬ìž API
export const getAdminData = async () => {
  const response = await apiClient.get('/admin/data');
  return response.data;
};

export const getAdminVoteSessions = async () => {
  const response = await apiClient.get('/admin/vote-sessions');
  return response.data;
};

export const getAdminVoteSessionsSummary = async () => {
  const response = await apiClient.get('/votes/sessions/summary');
  return response.data;
};

// íˆ¬í‘œ ê²°ê³¼ API
export const getVoteResults = async () => {
  const response = await apiClient.get('/vote-results');
  return response.data;
};

export const getSavedVoteResults = async (sessionId: number) => {
  const response = await apiClient.get(`/saved-vote-results/${sessionId}`);
  return response.data;
};

export const aggregateAndSaveVoteResults = async () => {
  const response = await apiClient.post('/aggregate-vote-results');
  return response.data;
};

// ì£¼ê°„ íˆ¬í‘œ ì‹œìž‘ API
export const startWeeklyVote = async () => {
  const response = await apiClient.post('/start-weekly-vote');
  return response.data;
};

// í†µí•© íˆ¬í‘œ ë°ì´í„° API (ìƒˆë¡œìš´ ë²„ì „)
export const getUnifiedVoteDataNew = async () => {
  const response = await apiClient.get('/unified-vote-data');
  return response.data;
};

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
export const changePassword = async (currentPassword: string, newPassword: string) => {
  const response = await apiClient.post('/change-password', {
    currentPassword,
    newPassword
  });
  return response.data;
};

// íšŒì› ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” API
export const resetMemberPassword = async (memberId: number) => {
  const response = await apiClient.post(`/members/${memberId}/reset-password`);
  return response.data;
};

// ëª¨ë“  íšŒì› ì¡°íšŒ API
export const getAllMembers = async () => {
  const response = await apiClient.get('/members');
  return response.data;
};

// íšŒì› í†µê³„ ì¡°íšŒ API
export const getMemberStats = async () => {
  const response = await retryRequest(() => apiClient.get('/admin/member-stats'));
  return response.data;
};

// í”„ë¡œí•„ ì—…ë°ì´íŠ¸ API
export const updateProfile = async (profileData: any) => {
  const response = await apiClient.put('/profile', profileData);
  return response.data;
};

// í”„ë¡œí•„ ì¡°íšŒ API
export const getProfile = async () => {
  const response = await retryRequest(() => apiClient.get('/profile'));
  return response.data;
};

export default apiClient;